/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model with user-based access control.
 * Most data is namespaced under a tenant ID, and access is generally restricted
 * to users who belong to that tenant or have explicit roles. The ruleset prioritizes
 * security and data isolation between tenants.
 *
 * Data Structure:
 * - /users/{userId}: Maps user UIDs to tenant IDs.
 * - /tenants/{tenantId}: Stores tenant-specific data.
 * - All other data (products, orders, etc.) is nested under /tenants/{tenantId}.
 * - /global/plans/{planId}: Globally available subscription plans.
 *
 * Key Security Decisions:
 * - User listing is generally disallowed for privacy.
 * - Notifications are restricted to users within their tenant.
 * - Data validation is relaxed in this prototyping phase to allow flexible data shapes,
 *   but authorization checks are strictly enforced.
 *
 * Denormalization for Authorization:
 *  - The `users/{userId}` document denormalizes the tenant ID for quick user-to-tenant
 *  association. This is used in the `isTenantMember()` helper function for efficient
 *  authorization checks on tenant-scoped data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A (Helper Function)
     * @allow N/A
     * @deny N/A
     * @principle Global helper function for authentication.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user's UID matches the provided user ID.
     * @path N/A (Helper Function)
     * @allow N/A
     * @deny N/A
     * @principle Enforces user-specific access.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner and the resource exists.
     * @path N/A (Helper Function)
     * @allow N/A
     * @deny N/A
     * @principle Validates that the user is the owner of an existing resource.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is a member of the specified tenant.
     * @path N/A (Helper Function)
     * @allow N/A
     * @deny N/A
     * @principle Checks if the user belongs to the tenant.
     */
    function isTenantMember(tenantId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }

    /**
     * @description Top-level collection to map user UIDs to tenant IDs for security rules.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates a document with ID 'user123' and their tenantId.
     * @deny (create) User with UID 'user123' attempts to create a document with ID 'user456'.
     * @principle Enforces user-specific data and validates relational integrity.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Collection to store tenant information.
     * @path /tenants/{tenantId}
     * @allow (get) Any signed-in user can read tenant data (if membership is checked in other rules).
     * @deny (create) Any user attempts to create a tenant (admin role required in real app).
     * @principle Tenant-level data storage.
     */
    match /tenants/{tenantId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false; // TODO: Implement admin-only creation.
      allow update: if false; // TODO: Implement admin-only update.
      allow delete: if false; // TODO: Implement admin-only deletion.

        /**
         * @description Sub-collection for product categories within a tenant.
         * @path /tenants/{tenantId}/categories/{categoryId}
         * @allow (list) A tenant member can list categories.
         * @deny (create) A non-tenant member cannot create a category.
         * @principle Tenant-level data isolation and authorization.
         */
        match /categories/{categoryId} {
            allow get: if isTenantMember(tenantId);
            allow list: if isTenantMember(tenantId);
            allow create: if isTenantMember(tenantId);
            allow update: if isTenantMember(tenantId);
            allow delete: if isTenantMember(tenantId);
        }

      /**
       * @description Sub-collection for products within a tenant.
       * @path /tenants/{tenantId}/products/{productId}
       * @allow (list) A tenant member can list products.
       * @deny (create) A non-tenant member cannot create a product.
       * @principle Tenant-level data isolation and authorization.
       */
      match /products/{productId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

        /**
         * @description Sub-collection for customers within a tenant.
         * @path /tenants/{tenantId}/customers/{customerId}
         * @allow (list) A tenant member can list customers.
         * @deny (create) A non-tenant member cannot create a customer.
         * @principle Tenant-level data isolation and authorization.
         */
        match /customers/{customerId} {
            allow get: if isTenantMember(tenantId);
            allow list: if isTenantMember(tenantId);
            allow create: if isTenantMember(tenantId);
            allow update: if isTenantMember(tenantId);
            allow delete: if isTenantMember(tenantId);
        }

        /**
         * @description Sub-collection for POS orders within a tenant.
         * @path /tenants/{tenantId}/orders/{orderId}
         * @allow (list) A tenant member can list orders.
         * @deny (create) A non-tenant member cannot create an order.
         * @principle Tenant-level data isolation and authorization.
         */
        match /orders/{orderId} {
            allow get: if isTenantMember(tenantId);
            allow list: if isTenantMember(tenantId);
            allow create: if isTenantMember(tenantId);
            allow update: if isTenantMember(tenantId);
            allow delete: if isTenantMember(tenantId);
        }

        /**
         * @description Sub-collection for restaurant tables within a tenant.
         * @path /tenants/{tenantId}/tables/{tableId}
         * @allow (list) A tenant member can list tables.
         * @deny (create) A non-tenant member cannot create a table.
         * @principle Tenant-level data isolation and authorization.
         */
        match /tables/{tableId} {
            allow get: if isTenantMember(tenantId);
            allow list: if isTenantMember(tenantId);
            allow create: if isTenantMember(tenantId);
            allow update: if isTenantMember(tenantId);
            allow delete: if isTenantMember(tenantId);
        }

        /**
         * @description Sub-collection for Kitchen Display System orders within a tenant.
         * @path /tenants/{tenantId}/kdsOrders/{kdsId}
         * @allow (list) A tenant member can list KDS orders.
         * @deny (create) A non-tenant member cannot create a KDS order.
         * @principle Tenant-level data isolation and authorization.
         */
        match /kdsOrders/{kdsId} {
            allow get: if isTenantMember(tenantId);
            allow list: if isTenantMember(tenantId);
            allow create: if isTenantMember(tenantId);
            allow update: if isTenantMember(tenantId);
            allow delete: if isTenantMember(tenantId);
        }

      /**
       * @description Sub-collection for users within a tenant.
       * @path /tenants/{tenantId}/users/{userId}
       * @allow (list) A tenant member can list users in their tenant.
       * @deny (create) A non-tenant member cannot create a user in this tenant.
       * @principle Tenant-level data isolation and authorization.
       */
      match /users/{userId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Sub-collection for payments within a tenant.
       * @path /tenants/{tenantId}/payments/{paymentId}
       * @allow (list) A tenant member can list payments.
       * @deny (create) A non-tenant member cannot create a payment.
       * @principle Tenant-level data isolation and authorization.
       */
      match /payments/{paymentId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Document for general settings within a tenant.
       * @path /tenants/{tenantId}/settings/general
       * @allow (get) A tenant member can read general settings.
       * @deny (create) A non-tenant member cannot create general settings.
       * @principle Tenant-level data isolation and authorization.
       */
      match /settings/general {
        allow get: if isTenantMember(tenantId);
        allow list: if false;
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Document for module settings within a tenant.
       * @path /tenants/{tenantId}/settings/modules
       * @allow (get) A tenant member can read module settings.
       * @deny (create) A non-tenant member cannot create module settings.
       * @principle Tenant-level data isolation and authorization.
       */
      match /settings/modules {
        allow get: if isTenantMember(tenantId);
        allow list: if false;
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

        /**
         * @description Document for automation rule settings within a tenant.
         * @path /tenants/{tenantId}/settings/automationRules
         * @allow (get) A tenant member can read automation rules settings.
         * @deny (create) A non-tenant member cannot create automation rules settings.
         * @principle Tenant-level data isolation and authorization.
         */
        match /settings/automationRules {
            allow get: if isTenantMember(tenantId);
            allow list: if false;
            allow create: if isTenantMember(tenantId);
            allow update: if isTenantMember(tenantId);
            allow delete: if isTenantMember(tenantId);
        }

      /**
       * @description Singleton document for RKSV fiscal certificate and configuration for a tenant.
       * @path /tenants/{tenantId}/rksvConfig
       * @allow (get) A tenant member can read RKSV config.
       * @deny (create) A non-tenant member cannot create RKSV config.
       * @principle Tenant-level data isolation and authorization.
       */
      match /rksvConfig {
        allow get: if isTenantMember(tenantId);
        allow list: if false;
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Sub-collection for the RKSV cryptographic signature chain.
       * @path /tenants/{tenantId}/signatures/{signatureId}
       * @allow (list) A tenant member can list signatures.
       * @deny (create) A non-tenant member cannot create a signature.
       * @principle Tenant-level data isolation and authorization.
       */
      match /signatures/{signatureId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Sub-collection for daily Z-Reports (Tagesabschluss).
       * @path /tenants/{tenantId}/zReports/{reportId}
       * @allow (list) A tenant member can list Z-Reports.
       * @deny (create) A non-tenant member cannot create a Z-Report.
       * @principle Tenant-level data isolation and authorization.
       */
      match /zReports/{reportId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Sub-collection for logging FinanzOnline API submissions.
       * @path /tenants/{tenantId}/finanzOnlineLogs/{logId}
       * @allow (list) A tenant member can list FinanzOnline logs.
       * @deny (create) A non-tenant member cannot create a FinanzOnline log.
       * @principle Tenant-level data isolation and authorization.
       */
      match /finanzOnlineLogs/{logId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Sub-collection for logging critical system errors within a tenant.
       * @path /tenants/{tenantId}/systemErrors/{errorId}
       * @allow (list) A tenant member can list system errors.
       * @deny (create) A non-tenant member cannot create a system error log.
       * @principle Tenant-level data isolation and authorization.
       */
      match /systemErrors/{errorId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Sub-collection for third-party integrations like Wolt or Foodora.
       * @path /tenants/{tenantId}/integrations/{platformId}
       * @allow (list) A tenant member can list integrations.
       * @deny (create) A non-tenant member cannot create an integration.
       * @principle Tenant-level data isolation and authorization.
       */
      match /integrations/{platformId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Sub-collection for cash register sessions.
       * @path /tenants/{tenantId}/cashRegisters/{registerId}
       * @allow (list) A tenant member can list cash register sessions.
       * @deny (create) A non-tenant member cannot create a cash register session.
       * @principle Tenant-level data isolation and authorization.
       */
      match /cashRegisters/{registerId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Sub-collection for generated reports.
       * @path /tenants/{tenantId}/reports/{reportId}
       * @allow (list) A tenant member can list reports.
       * @deny (create) A non-tenant member cannot create a report.
       * @principle Tenant-level data isolation and authorization.
       */
      match /reports/{reportId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Sub-collection for AI chat messages within a tenant.
       * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
       * @allow (list) A tenant member can list AI chat messages within their tenant.
       * @deny (create) A non-tenant member cannot create an AI chat message in this tenant.
       * @principle Tenant-level data isolation and authorization.
       */
      match /aiChats/{chatId}/messages/{messageId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

      /**
       * @description Sub-collection for orders from external POS/delivery platforms.
       * @path /tenants/{tenantId}/posOrders/{orderId}
       * @allow (list) A tenant member can list POS orders within their tenant.
       * @deny (create) A non-tenant member cannot create a POS order in this tenant.
       * @principle Tenant-level data isolation and authorization.
       */
      match /posOrders/{orderId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }

        /**
         * @description Sub-collection for logging incoming webhook API calls.
         * @path /tenants/{tenantId}/auditLogs/{logId}
         * @allow (list) A tenant member can list audit logs.
         * @deny (create) A non-tenant member cannot create an audit log.
         * @principle Tenant-level data isolation and authorization.
         */
        match /auditLogs/{logId} {
            allow get: if isTenantMember(tenantId);
            allow list: if isTenantMember(tenantId);
            allow create: if isTenantMember(tenantId);
            allow update: if isTenantMember(tenantId);
            allow delete: if isTenantMember(tenantId);
        }

      /**
       * @description Sub-collection for user and system notifications within a tenant.
       * @path /tenants/{tenantId}/notifications/{notificationId}
       * @allow (list) A tenant member can list notifications within their tenant.
       * @deny (create) A non-tenant member cannot create a notification in this tenant.
       * @principle Tenant-level data isolation and authorization.
       */
      match /notifications/{notificationId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
      }
    }

    /**
     * @description Global collection for subscription plans.
     * @path /global/plans/{planId}
     * @allow (get) Any signed-in user can read a plan.
     * @deny (create) Only admins can create plans (not implemented here).
     * @principle Public read access for plans.
     */
    match /global/plans/{planId} {
      allow get: if isSignedIn();
      allow list: if false; // Listing plans should probably be admin-only in production
      allow create: if false; // TODO: Implement admin-only creation.
      allow update: if false; // TODO: Implement admin-only update.
      allow delete: if false; // TODO: Implement admin-only deletion.
    }

    /**
     * @description Collection for triggering email sending via Firebase Extensions.
     * @path /mail/{mailId}
     * @allow (create) Only authenticated users can trigger emails.
     * @deny (get, list, update, delete) All other operations are denied for security.
     */
    match /mail/{mailId} {
        allow get: if false;
        allow list: if false;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if false;
    }
  }
}