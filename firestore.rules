/**
 * @description This ruleset enforces a multi-tenant security model where users are associated with tenants.
 *  Each tenant's data is isolated from other tenants.
 * @dataStructure
 *  - /users/{userId}: Maps user UIDs to tenant IDs. Acts as the entry point for determining tenant access.
 *  - /tenants/{tenantId}: Stores tenant-level information.
 *  - /tenants/{tenantId}/...: All tenant-specific data is stored under the respective tenant document.
 *  - /global/plans/{planId}: Public information about available subscription plans.
 *  - /mail/{mailId}: Used to trigger email sending, secured for extension usage.
 * @keySecurityDecisions
 *  - User-to-tenant mapping is strictly enforced. Users can only access data within their assigned tenant.
 *  - Listing of users and tenants is generally disallowed to prevent information disclosure.
 *  - Global plans are publicly readable.
 *  - Mail collection is secured such that only extensions can create documents, triggering emails.
 * @denormalizationForAuthorization
 *  - The `users/{userId}` document directly stores the `tenantId`, avoiding the need to query a separate user profile.
 * @structuralSegregation
 *  - Tenant-specific data is segregated under the `/tenants/{tenantId}` path, ensuring clear data isolation.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Maps user UIDs to tenant IDs for security rules.
     * @path /users/{userId}
     * @allow (create) - If the authenticated user's UID matches the document ID. This allows a user to create their initial mapping.
     * @allow (get, list) - If the authenticated user's UID matches the document ID.
     * @allow (update, delete) - Never allowed. User-tenant mappings are immutable.
     * @deny (create) - If the authenticated user's UID does not match the document ID.
     * @deny (get, list) - If the authenticated user's UID does not match the document ID.
     * @principle Enforces document ownership for writes and reads based on user ID.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update, delete: if false;
    }

    /**
     * @description Stores tenant information.
     * @path /tenants/{tenantId}
     * @allow (get) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (list) - Never allowed. Listing all tenants is a security risk.
     * @allow (create, update, delete) - Never allowed. Tenants can only be created/updated via backend processes.
     * @deny (get) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to tenant information based on user-tenant association.
     */
    match /tenants/{tenantId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isUserInTenant(tenantId) {
            return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isSignedIn() && isUserInTenant(tenantId);
        allow list: if false;
        allow create, update, delete: if false;
    }

    /**
     * @description Sub-collection for users within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get, list) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create) - Never allowed. User creation should be handled via backend.
     * @allow (update, delete) - If the authenticated user's UID matches the document ID.
     * @deny (get, list) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to user information based on tenant association and user ID.
     */
    match /tenants/{tenantId}/users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      function isOwner(userId) {
          return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get, list: if isSignedIn() && isUserInTenant(tenantId);
      allow create: if false;
      allow update, delete: if isSignedIn() && isUserInTenant(tenantId) && isExistingOwner(userId);
    }

    /**
     * @description Sub-collection for transactions within a tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get, list) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create, update, delete) - If the request is made by an authenticated user who is associated with the tenant.
     * @deny (get, list, create, update, delete) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to transaction information based on tenant association.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      allow get, list, create, update, delete: if isSignedIn() && isUserInTenant(tenantId);
    }

    /**
     * @description Sub-collection for products within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create, update, delete) - If the request is made by an authenticated user who is associated with the tenant.
     * @deny (get, list, create, update, delete) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to product information based on tenant association.
     */
    match /tenants/{tenantId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      allow get, list, create, update, delete: if isSignedIn() && isUserInTenant(tenantId);
    }

    /**
     * @description Document for general settings within a tenant.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create, update, delete) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (list) - Never allowed.
     * @deny (get, create, update, delete) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to settings based on tenant association.
     */
    match /tenants/{tenantId}/settings/general {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      allow get, create, update, delete: if isSignedIn() && isUserInTenant(tenantId);
      allow list: if false;
    }

    /**
     * @description Document for module settings within a tenant.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create, update, delete) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (list) - Never allowed.
     * @deny (get, create, update, delete) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to module settings based on tenant association.
     */
    match /tenants/{tenantId}/settings/modules {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      allow get, create, update, delete: if isSignedIn() && isUserInTenant(tenantId);
      allow list: if false;
    }

    /**
     * @description Document for automation rule settings within a tenant.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow (get) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create, update, delete) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (list) - Never allowed.
     * @deny (get, create, update, delete) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to automation rule settings based on tenant association.
     */
    match /tenants/{tenantId}/settings/automationRules {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      allow get, create, update, delete: if isSignedIn() && isUserInTenant(tenantId);
      allow list: if false;
    }

    /**
     * @description Document for RKSV key and status within a tenant.
     * @path /tenants/{tenantId}/settings/rksv
     * @allow (get) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create, update, delete) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (list) - Never allowed.
     * @deny (get, create, update, delete) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to RKSV settings based on tenant association.
     */
    match /tenants/{tenantId}/settings/rksv {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      allow get, create, update, delete: if isSignedIn() && isUserInTenant(tenantId);
      allow list: if false;
    }

    /**
     * @description Stores credentials and status for third-party integrations like Wolt or Foodora.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get, list) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create, update, delete) - If the request is made by an authenticated user who is associated with the tenant.
     * @deny (get, list, create, update, delete) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to integration settings based on tenant association.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      allow get, list, create, update, delete: if isSignedIn() && isUserInTenant(tenantId);
    }

    /**
     * @description Global collection for subscription plans.
     * @path /global/plans/{planId}
     * @allow (get, list) - Publicly readable.
     * @allow (create, update, delete) - Never allowed. Plans are managed by backend.
     * @deny (create, update, delete) - Always deny write operations.
     * @principle Public read access for plans. Write access is restricted.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Sub-collection for messages within an AI chat session.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, list) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create, update, delete) - If the request is made by an authenticated user who is associated with the tenant.
     * @deny (get, list, create, update, delete) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to chat messages based on tenant association.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      allow get, list, create, update, delete: if isSignedIn() && isUserInTenant(tenantId);
    }

    /**
     * @description Sub-collection for orders from external POS/delivery platforms.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (get, list) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create, update, delete) - If the request is made by an authenticated user who is associated with the tenant.
     * @deny (get, list, create, update, delete) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to POS orders based on tenant association.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      allow get, list, create, update, delete: if isSignedIn() && isUserInTenant(tenantId);
    }

    /**
     * @description Sub-collection for logging incoming webhook API calls.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (get, list) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create, update, delete) - Never allow client side writes.
     * @deny (get, list) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to audit logs based on tenant association. Only backend writes allowed.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      allow get, list: if isSignedIn() && isUserInTenant(tenantId);
      allow create, update, delete: if false;
    }

    /**
     * @description Sub-collection for user and system notifications within a tenant.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (get, list) - If the request is made by an authenticated user who is associated with the tenant.
     * @allow (create, update, delete) - If the request is made by an authenticated user who is associated with the tenant.
     * @deny (get, list, create, update, delete) - If the request is not made by an authenticated user who is associated with the tenant.
     * @principle Restricts access to notifications based on tenant association.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isUserInTenant(tenantId) {
          return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }

      allow get, list, create, update, delete: if isSignedIn() && isUserInTenant(tenantId);
    }

    /**
     * @description Collection for triggering email sending via Firebase Extensions (e.g., SendGrid, Mailgun).
     * @path /mail/{mailId}
     * @allow (create) - Only allow extension to create documents.
     * @allow (get, list, update, delete) - Never allowed.
     * @deny (create) - If the request is not made by an extension (no auth).
     */
    match /mail/{mailId} {
        allow get, list, update, delete: if false;
        allow create: if request.auth == null;
    }
  }
}