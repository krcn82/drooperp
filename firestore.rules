rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Maps user UIDs to tenant IDs for security.
     * @path /users/{userId}
     * @allow (create) - If the authenticated user's ID matches the document ID.
     * @allow (get, list) - If the authenticated user's ID matches the document ID.
     * @allow (update, delete) - If the authenticated user's ID matches the document ID.
     * @deny (create) - If the authenticated user's ID does not match the document ID.
     * @deny (get, list) - If the authenticated user's ID does not match the document ID.
     * @deny (update, delete) - If the authenticated user's ID does not match the document ID.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update, delete: if isOwner(userId);
    }

    /**
     * @description Stores tenant information.
     * @path /tenants/{tenantId}
     * @allow (get, list) - If any authenticated user.
     * @allow (create) - If any authenticated user.
     * @allow (update, delete) - If any authenticated user.
     * @deny (create) - If not authenticated.
     * @deny (update, delete) - If not authenticated.
     * @principle Authenticated users can manage tenant data.
     */
    match /tenants/{tenantId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Sub-collection for users within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage user data.
     */
    match /tenants/{tenantId}/users/{userId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId) && isOwner(userId);
      allow update, delete: if isInTenant(tenantId) && isOwner(userId);
    }

    /**
     * @description Sub-collection for transactions within a tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage transaction data.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for products within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage product data.
     */
    match /tenants/{tenantId}/products/{productId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Document for general settings within a tenant.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage general settings.
     */
    match /tenants/{tenantId}/settings/general {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Document for module settings within a tenant.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage module settings.
     */
    match /tenants/{tenantId}/settings/modules {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Document for automation rule settings within a tenant.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage automation rule settings.
     */
    match /tenants/{tenantId}/settings/automationRules {
        allow get, list: if isInTenant(tenantId);
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Document for RKSV key and status within a tenant.
     * @path /tenants/{tenantId}/settings/rksv
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage RKSV settings.
     */
    match /tenants/{tenantId}/settings/rksv {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Stores credentials and status for third-party integrations.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage integration settings.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Global collection for subscription plans.
     * @path /global/plans/{planId}
     * @allow (get, list) - If any authenticated user.
     * @allow (create) - If any authenticated user.
     * @allow (update, delete) - If any authenticated user.
     * @deny (create) - If not authenticated.
     * @deny (update, delete) - If not authenticated.
     * @principle Authenticated users can manage subscription plans.
     */
    match /global/plans/{planId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();  // Allow creating plans (consider restricting this in production)
      allow update: if isSignedIn();  // Allow updating plans (consider restricting this in production)
      allow delete: if isSignedIn();  // Allow deleting plans (consider restricting this in production)
    }

    /**
     * @description Sub-collection for messages within an AI chat session.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage AI chat messages.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

   /**
     * @description Sub-collection for orders from external POS/delivery platforms.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage POS order data.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for logging incoming webhook API calls.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage audit log data.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
        allow get, list: if isInTenant(tenantId);
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for user and system notifications within a tenant.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (get, list) - If the user is in the tenant.
     * @allow (create) - If the user is in the tenant.
     * @allow (update, delete) - If the user is in the tenant.
     * @deny (create) - If the user is not in the tenant.
     * @deny (update, delete) - If the user is not in the tenant.
     * @principle Only users within the tenant can manage notifications.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Collection for triggering email sending via Firebase Extensions.
     * @path /mail/{mailId}
     * @allow create: if false;
     * @allow get: if false;
     * @allow list: if false;
     * @allow update: if false;
     * @allow delete: if false;
     * @principle This collection is only writable by extensions.  All client access is denied.
     */
    match /mail/{mailId} {
      allow create: if false;
      allow get: if false;
      allow list: if false;
      allow update: if false;
      allow delete: if false;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isInTenant(tenantId) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
  }
}