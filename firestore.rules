rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner and the resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId));
    }

    /**
     * @description Gets the tenant ID associated with the user's UID from the /users/{userId} document.
     */
    function getTenantIdForUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
    }

    /**
     * @description Checks if the authenticated user belongs to the tenant specified in the path.
     */
    function isInTenant(tenantId) {
      return isSignedIn() && getTenantIdForUser() == tenantId;
    }

    /**
     * @description Checks if the user has the specified role within the tenant.
     */
    function hasRole(tenantId, role) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == role;
    }

    /**
     * @description Top-level collection to map user UIDs to tenant IDs for security rules.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.tenantId is string;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Collection to store tenant information.
     */
    match /tenants/{tenantId} {
      allow get: if isInTenant(tenantId);
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
      match /categories/{categoryId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /products/{productId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /customers/{customerId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /orders/{orderId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /tables/{tableId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /kdsOrders/{kdsId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /users/{userId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /payments/{paymentId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /settings/{document=**} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if false;
        allow update: if isInTenant(tenantId);
        allow delete: if false;
      }
      match /rksvConfig {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if false;
        allow update: if isInTenant(tenantId);
        allow delete: if false;
      }
       match /signatures/{signatureId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /zReports/{reportId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /integrations/{platformId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /cashRegisters/{registerId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /reports/{reportId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /finanzOnlineLogs/{logId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /systemErrors/{errorId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /aiChats/{chatId}/messages/{messageId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /posOrders/{orderId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /auditLogs/{logId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
      match /notifications/{notificationId} {
        allow get: if isInTenant(tenantId);
        allow list: if false;
        allow create: if isInTenant(tenantId);
        allow update: if isInTenant(tenantId);
        allow delete: if isInTenant(tenantId);
      }
    }

    /**
     * @description Global collection for subscription plans.
     */
    match /global/plans/{planId} {
      allow get: if true;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Collection for triggering email sending via Firebase Extensions (e.g., SendGrid, Mailgun).
     */
    match /mail/{mailId} {
      allow get: if false;
      allow list: if false;
      allow create: if false; // TODO: Secure this via backend function identity.
      allow update: if false;
      allow delete: if false;
    }
  }
}