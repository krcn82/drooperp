/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model with user-based access control.
 * Tenants are isolated from each other, and users primarily have access to data within their own tenant.
 * Global data (e.g., subscription plans) is publicly readable but not writable by end-users.
 *
 * Data Structure:
 * - /users/{userId}: Maps user UIDs to tenant IDs. This is CRUCIAL for all authorization checks.
 * - /tenants/{tenantId}: Stores tenant-specific information.
 * - /tenants/{tenantId}/*: Subcollections contain tenant-specific data (users, products, transactions, etc.).
 * - /global/plans/{planId}: Stores publicly readable subscription plans.
 * - /mail/{mailId}: Stores email requests to be processed by an extension.
 *
 * Key Security Decisions:
 * - Users can only read/write data within their assigned tenant.
 * - The /users/{userId} document is writable only by the user themselves (self-creation).
 * - Listing of users within a tenant is allowed for tenant members.
 * - Global subscription plans are publicly readable.
 * - Email requests can only be created by a service account.
 *
 * Denormalization for Authorization:
 * - Tenant ID is denormalized onto most tenant-specific documents to simplify security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Maps user UIDs to tenant IDs.  Allows a user to create their own UserTenant document.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create a document /users/user123.
     * @deny (create) - User with UID 'user123' cannot create a document /users/anotherUser.
     * @allow (get, list, update, delete) - User with UID 'user123' cannot get, list, update or delete /users/user123 document.
     * @principle Enforces document ownership, enabling users to create their own entry, and only their own.
     */
    match /users/{userId} {
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow get, list, update, delete: if false;
    }

    /**
     * @description Stores tenant-specific information. No public read/write access.
     * @path /tenants/{tenantId}
     * @allow (get, list, create, update, delete) - Never allowed.
     * @deny (get, list, create, update, delete) - All requests are denied.
     * @principle Restricts access to tenant documents.
     */
    match /tenants/{tenantId} {
      allow get, list, create, update, delete: if false;
    }

    /**
     * @description Sub-collection for users within a tenant. Allows tenant members to list users.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for user management.
     */
    match /tenants/{tenantId}/users/{userId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Sub-collection for products within a tenant.  Tenant members can manage products.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for product management.
     */
    match /tenants/{tenantId}/products/{productId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Sub-collection for transactions within a tenant. Tenant members can manage transactions.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for transaction management.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Document for general settings within a tenant. Tenant members can manage settings.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for general settings.
     */
    match /tenants/{tenantId}/settings/general {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Document for module settings within a tenant. Tenant members can manage module settings.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for module settings.
     */
    match /tenants/{tenantId}/settings/modules {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Document for automation rule settings within a tenant.  Tenant members can manage these settings.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for automation settings.
     */
    match /tenants/{tenantId}/settings/automationRules {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Document for RKSV key and status within a tenant. Tenant members can manage these settings.
     * @path /tenants/{tenantId}/settings/rksv
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for RKSV settings.
     */
    match /tenants/{tenantId}/settings/rksv {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Stores credentials and status for third-party integrations like Wolt or Foodora. Tenant members can manage integrations.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for integrations.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Global collection for subscription plans. Publicly readable.
     * @path /global/plans/{planId}
     * @allow (get, list) - All users can read subscription plans.
     * @deny (create, update, delete) - No one should be able to modify plans through the client.
     * @principle Provides public read access to global plans while restricting write access.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Sub-collection for messages within an AI chat session. Tenant members can manage messages.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for AI chat messages.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Sub-collection for orders from external POS/delivery platforms. Tenant members can manage orders.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for POS orders.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Sub-collection for logging incoming webhook API calls. Tenant members can manage logs.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for audit logs.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Sub-collection for user and system notifications within a tenant. Tenant members can manage notifications.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (get, list, create, update, delete) - Only allowed if the request is made by the tenant.
     * @deny (get, list, create, update, delete) - All requests not from the tenant.
     * @principle Enforces tenant-based access control for notifications.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && resource != null;
      allow delete: if isTenantMember(tenantId) && resource != null;
    }

    /**
     * @description Collection for triggering email sending via Firebase Extensions (e.g., SendGrid, Mailgun).  Only the service account should be able to write.
     * @path /mail/{mailId}
     * @allow (create) - Only allowed for service accounts.
     * @deny (get, list, update, delete) - Not allowed for anyone.
     * @principle Restricts access to email creation to service accounts only.
     */
    match /mail/{mailId} {
      allow create: if false; // TODO: Only allow service accounts here
      allow get, list, update, delete: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isTenantMember(tenantId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }
  }
}