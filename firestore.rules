/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a multi-tenant security model where users are associated with tenants.
 *   Access is primarily role-based within a tenant, with additional ownership checks where appropriate.
 *
 * @dataStructure
 *   - /users/{userId}: Maps user UIDs to tenant IDs. This is the entry point for determining a user's tenant.
 *   - /tenants/{tenantId}: Stores tenant-level data.
 *   - /tenants/{tenantId}/*: Most tenant data is stored in subcollections, following a consistent pattern.
 *   - /global/plans/{planId}: Stores global subscription plans.
 *   - /mail/{mailId}: A top-level collection for triggering emails via Firebase Extensions.
 *
 * @keySecurityDecisions
 *   - Users can only access data within their assigned tenant.
 *   - The `users` collection maps user IDs to tenant IDs and this mapping is strictly enforced.
 *   - The rules do not validate data types or the presence of optional fields during writes to maximize
 *     prototyping speed.  However, they DO enforce that key relationship fields (e.g., tenantId) are
 *     consistent and immutable.
 *   - The `mail` collection is write-only and intended for use by a Firebase Extension, which will handle
 *     the actual email sending.
 *
 * @denormalizationForAuthorization
 *   - For most tenant-specific data, the rules rely on the path (`/tenants/{tenantId}/...`) to determine
 *     authorization.  This avoids the need to duplicate the tenant ID in every document.
 *   - The user's tenant ID is denormalized in the `/users/{userId}` document to allow rules to quickly
 *     determine which tenant a user belongs to.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to read and write their own tenant ID mapping.
     * @path /users/{userId}
     * @allow (create, update, get, list, delete) if request.auth.uid == userId
     * @deny (create, update, delete) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing all user mappings is disallowed for privacy.
      allow create: if isOwner(userId) && request.resource.data.tenantId is string;
      allow update: if isOwner(userId) && request.resource.data.tenantId == resource.data.tenantId; // Tenant ID is immutable.
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows read access to tenant information.  Write access is not granted in these rules.
     * @path /tenants/{tenantId}
     * @allow get, list: if true
     * @deny create, update, delete: always
     * @principle Public read access.
     */
    match /tenants/{tenantId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Allows read and write access to product categories within a tenant for authenticated users.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow get, list: if isSignedIn()
     * @allow create, update, delete: if isSignedIn()
     * @principle Authenticated users can manage categories within their tenant.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
        function isSignedIn() {
            return request.auth != null;
        }
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Allows read and write access to products within a tenant for authenticated users.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow get, list: if isSignedIn()
     * @allow create, update, delete: if isSignedIn()
     * @principle Authenticated users can manage products within their tenant.
     */
    match /tenants/{tenantId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows read and write access to customers within a tenant for authenticated users.
     * @path /tenants/{tenantId}/customers/{customerId}
     * @allow get, list: if isSignedIn()
     * @allow create, update, delete: if isSignedIn()
     * @principle Authenticated users can manage customers within their tenant.
     */
    match /tenants/{tenantId}/customers/{customerId} {
        function isSignedIn() {
            return request.auth != null;
        }
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Allows read and write access to orders within a tenant for authenticated users.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow get, list: if isSignedIn()
     * @allow create, update, delete: if isSignedIn()
     * @principle Authenticated users can manage orders within their tenant.
     */
    match /tenants/{tenantId}/orders/{orderId} {
        function isSignedIn() {
            return request.auth != null;
        }
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Allows read and write access to tables within a tenant for authenticated users.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow get, list: if isSignedIn()
     * @allow create, update, delete: if isSignedIn()
     * @principle Authenticated users can manage tables within their tenant.
     */
    match /tenants/{tenantId}/tables/{tableId} {
        function isSignedIn() {
            return request.auth != null;
        }
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Allows read and write access to KDS orders within a tenant for authenticated users.
     * @path /tenants/{tenantId}/kdsOrders/{kdsId}
     * @allow get, list: if isSignedIn()
     * @allow create, update, delete: if isSignedIn()
     * @principle Authenticated users can manage KDS orders within their tenant.
     */
    match /tenants/{tenantId}/kdsOrders/{kdsId} {
        function isSignedIn() {
            return request.auth != null;
        }
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Allows a tenant admin to manage users within their tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow get, list: if isTenantAdmin(tenantId)
     * @allow create: if isTenantAdmin(tenantId)
     * @allow update: if isTenantAdmin(tenantId)
     * @allow delete: if isTenantAdmin(tenantId)
     * @principle Tenant admins can manage users within their tenant.
     */
    match /tenants/{tenantId}/users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
      }
      function isTenantAdmin(tenantId) {
        return isSignedIn() && getTenantId() == tenantId;
      }

      allow get: if isTenantAdmin(tenantId);
      allow list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

   /**
     * @description Allows a tenant admin to manage payments within their tenant.
     * @path /tenants/{tenantId}/payments/{paymentId}
     * @allow get, list: if isTenantAdmin(tenantId)
     * @allow create: if isTenantAdmin(tenantId)
     * @allow update: if isTenantAdmin(tenantId)
     * @allow delete: if isTenantAdmin(tenantId)
     * @principle Tenant admins can manage payments within their tenant.
     */
    match /tenants/{tenantId}/payments/{paymentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
      }
      function isTenantAdmin(tenantId) {
        return isSignedIn() && getTenantId() == tenantId;
      }

      allow get: if isTenantAdmin(tenantId);
      allow list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows read and write access to general settings within a tenant for authenticated users.
     * @path /tenants/{tenantId}/settings/general
     * @allow get: if isSignedIn()
     * @allow list: if false;
     * @allow create: if isSignedIn();
     * @allow update: if isSignedIn();
     * @allow delete: if isSignedIn();
     * @principle Authenticated users can manage settings within their tenant.
     */
    match /tenants/{tenantId}/settings/general {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows read access to module settings within a tenant for authenticated users.
     *   Write access is restricted to tenant admins.
     * @path /tenants/{tenantId}/settings/modules
     * @allow get: if isSignedIn()
     * @allow list: if false;
     * @deny create, update, delete: if true
     * @principle Authenticated users can read settings, but only admins can modify them.
     */
    match /tenants/{tenantId}/settings/modules {
      function isSignedIn() {
        return request.auth != null;
      }
       function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
      }
      function isTenantAdmin(tenantId) {
        return isSignedIn() && getTenantId() == tenantId;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }
    
    /**
     * @description Allows read and write access to automation rules within a tenant for authenticated users.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow get: if isSignedIn()
     * @allow list: if false;
     * @allow create: if isSignedIn();
     * @allow update: if isSignedIn();
     * @allow delete: if isSignedIn();
     * @principle Authenticated users can manage automation rules within their tenant.
     */
    match /tenants/{tenantId}/settings/automationRules {
        function isSignedIn() {
            return request.auth != null;
        }
        allow get: if isSignedIn();
        allow list: if false;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Allows read and write access to the RKSV config for tenant admins.
     * @path /tenants/{tenantId}/rksvConfig
     * @allow get: if isTenantAdmin(tenantId)
     * @allow create: if isTenantAdmin(tenantId)
     * @allow update: if isTenantAdmin(tenantId)
     * @allow delete: if isTenantAdmin(tenantId)
     * @principle Only tenant admins can manage the RKSV configuration.
     */
    match /tenants/{tenantId}/rksvConfig {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
      }
      function isTenantAdmin(tenantId) {
        return isSignedIn() && getTenantId() == tenantId;
      }

      allow get: if isTenantAdmin(tenantId);
      allow list: if false;
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows read and write access to signatures for tenant admins.
     * @path /tenants/{tenantId}/signatures/{signatureId}
     * @allow get, list: if isTenantAdmin(tenantId)
     * @allow create, update, delete: if isTenantAdmin(tenantId)
     * @principle Only tenant admins can manage RKSV signatures.
     */
    match /tenants/{tenantId}/signatures/{signatureId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
      }
      function isTenantAdmin(tenantId) {
        return isSignedIn() && getTenantId() == tenantId;
      }

      allow get: if isTenantAdmin(tenantId);
      allow list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows read and write access to zReports for tenant admins.
     * @path /tenants/{tenantId}/zReports/{reportId}
     * @allow get, list: if isTenantAdmin(tenantId)
     * @allow create, update, delete: if isTenantAdmin(tenantId)
     * @principle Only tenant admins can manage Z-Reports.
     */
    match /tenants/{tenantId}/zReports/{reportId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
      }
      function isTenantAdmin(tenantId) {
        return isSignedIn() && getTenantId() == tenantId;
      }

      allow get: if isTenantAdmin(tenantId);
      allow list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows a tenant admin to manage integrations within their tenant.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow get, list: if isTenantAdmin(tenantId)
     * @allow create: if isTenantAdmin(tenantId)
     * @allow update: if isTenantAdmin(tenantId)
     * @allow delete: if isTenantAdmin(tenantId)
     * @principle Tenant admins can manage integrations within their tenant.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
      }
      function isTenantAdmin(tenantId) {
        return isSignedIn() && getTenantId() == tenantId;
      }

      allow get: if isTenantAdmin(tenantId);
      allow list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows a tenant admin to manage cash registers within their tenant.
     * @path /tenants/{tenantId}/cashRegisters/{registerId}
     * @allow get, list: if isTenantAdmin(tenantId)
     * @allow create: if isTenantAdmin(tenantId)
     * @allow update: if isTenantAdmin(tenantId)
     * @allow delete: if isTenantAdmin(tenantId)
     * @principle Tenant admins can manage cash registers within their tenant.
     */
    match /tenants/{tenantId}/cashRegisters/{registerId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
      }
      function isTenantAdmin(tenantId) {
        return isSignedIn() && getTenantId() == tenantId;
      }

      allow get: if isTenantAdmin(tenantId);
      allow list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows a tenant admin to manage reports within their tenant.
     * @path /tenants/{tenantId}/reports/{reportId}
     * @allow get, list: if isTenantAdmin(tenantId)
     * @allow create: if isTenantAdmin(tenantId)
     * @allow update: if isTenantAdmin(tenantId)
     * @allow delete: if isTenantAdmin(tenantId)
     * @principle Tenant admins can manage reports within their tenant.
     */
    match /tenants/{tenantId}/reports/{reportId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
      }
      function isTenantAdmin(tenantId) {
        return isSignedIn() && getTenantId() == tenantId;
      }

      allow get: if isTenantAdmin(tenantId);
      allow list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows a tenant admin to manage FinanzOnline logs within their tenant.
     * @path /tenants/{tenantId}/finanzOnlineLogs/{logId}
     * @allow get, list: if isTenantAdmin(tenantId)
     * @allow create: if isTenantAdmin(tenantId)
     * @allow update: if isTenantAdmin(tenantId)
     * @allow delete: if isTenantAdmin(tenantId)
     * @principle Tenant admins can manage FinanzOnline logs within their tenant.
     */
    match /tenants/{tenantId}/finanzOnlineLogs/{logId} {
        function isSignedIn() {
            return request.auth != null;
        }
       function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
      }
      function isTenantAdmin(tenantId) {
        return isSignedIn() && getTenantId() == tenantId;
      }
        allow get: if isTenantAdmin(tenantId);
        allow list: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows a tenant admin to manage system errors within their tenant.
     * @path /tenants/{tenantId}/systemErrors/{errorId}
     * @allow get, list: if isTenantAdmin(tenantId)
     * @allow create: if isTenantAdmin(tenantId)
     * @allow update: if isTenantAdmin(tenantId)
     * @allow delete: if isTenantAdmin(tenantId)
     * @principle Tenant admins can manage system errors within their tenant.
     */
    match /tenants/{tenantId}/systemErrors/{errorId} {
        function isSignedIn() {
            return request.auth != null;
        }
         function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
      }
      function isTenantAdmin(tenantId) {
        return isSignedIn() && getTenantId() == tenantId;
      }
        allow get: if isTenantAdmin(tenantId);
        allow list: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows public read access to subscription plans. Write access is forbidden.
     * @path /global/plans/{planId}
     * @allow get, list: if true
     * @deny create, update, delete: if true
     * @principle Public read access to plan information.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read and write access to chat messages for authenticated users.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow get, list: if isSignedIn()
     * @allow create, update, delete: if isSignedIn()
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows a tenant admin to manage POS orders within their tenant.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow get, list: if isTenantAdmin(tenantId)
     * @allow create: if isTenantAdmin(tenantId)
     * @allow update: if isTenantAdmin(tenantId)
     * @allow delete: if isTenantAdmin(tenantId)
     * @principle Tenant admins can manage POS orders within their tenant.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
        function isSignedIn() {
            return request.auth != null;
        }
        function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
        }
        function isTenantAdmin(tenantId) {
            return isSignedIn() && getTenantId() == tenantId;
        }
        allow get: if isTenantAdmin(tenantId);
        allow list: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows a tenant admin to manage audit logs within their tenant.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow get, list: if isTenantAdmin(tenantId)
     * @allow create: if isTenantAdmin(tenantId)
     * @allow update: if isTenantAdmin(tenantId)
     * @allow delete: if isTenantAdmin(tenantId)
     * @principle Tenant admins can manage audit logs within their tenant.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
        function isSignedIn() {
            return request.auth != null;
        }
        function getTenantId() {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
        }
        function isTenantAdmin(tenantId) {
            return isSignedIn() && getTenantId() == tenantId;
        }
        allow get: if isTenantAdmin(tenantId);
        allow list: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows read and write access to notifications for authenticated users.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow get, list: if isSignedIn()
     * @allow create, update, delete: if isSignedIn()
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows creation of mail documents, intended for processing by a Firebase Extension.
     *   Reads, updates, and deletes are disallowed.
     * @path /mail/{mailId}
     * @allow create: if isSignedIn()
     * @deny get, list, update, delete: always
     * @principle Allows authorized creation of mail documents to trigger email sending.
     */
    match /mail/{mailId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}