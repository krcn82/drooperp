/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a multi-tenant security model where users
 * are associated with tenants, and data access is restricted based on tenant
 * membership.
 *
 * Data Structure:
 * - /users/{userId}: Maps user UIDs to tenant IDs.  This collection is only writable by the user themselves on creation.
 * - /tenants/{tenantId}: Stores tenant information.
 * - /tenants/{tenantId}/users/{userId}: Stores user information within a tenant.
 * - /tenants/{tenantId}/transactions/{transactionId}: Stores transaction data for a tenant.
 * - /tenants/{tenantId}/products/{productId}: Stores product data for a tenant.
 * - /tenants/{tenantId}/settings/{settingsId}: Stores settings for a tenant.
 * - /global/plans/{planId}: Stores globally available subscription plans.
 * - /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}: Stores chat messages within a tenant.
 *
 * Key Security Decisions:
 * - Strict user-ownership for /users/{userId} to map the authenticated user to the tenant.
 * - Tenant-based access control for all tenant subcollections. Only authenticated users
 *   can access data within their associated tenant.
 * - Public read access to /global/plans/{planId}.
 * - No listing of users outside of a tenant context is allowed.
 * - Default security posture for ambiguous relationships is strict owner-only access.
 *
 * Denormalization for Authorization:
 * - The /users/{userId} document is used to denormalize the tenantId for each user,
 *   enabling efficient tenant-based access control in other rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Maps user UIDs to tenant IDs for security rules.
     * @path /users/{userId}
     * @allow (create) User 'testuser' with UID 'testuser' can create their own entry.
     * @deny (create) User 'testuser' with UID 'otheruser' cannot create entry for 'testuser'.
     * @principle Enforces user-ownership and allows self-creation.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if false;
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.tenantId is string && request.resource.data.size() == 1;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores tenant information.
     * @path /tenants/{tenantId}
     * @allow (get, list) Any authenticated user can read tenant info.
     * @deny (create, update, delete) No one can create, update, or delete tenants directly.
     * @principle Requires backend management of tenants.
     */
    match /tenants/{tenantId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores user information within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get, list) Any authenticated user can read user info within their tenant.
     * @deny (create, update, delete) No one can create, update, or delete users directly.
     * @principle Requires backend management of users within a tenant.
     */
    match /tenants/{tenantId}/users/{userId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores transaction data for a tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get, list) Any authenticated user can read transaction data within their tenant.
     * @deny (create, update, delete) No one can create, update, or delete transactions directly.
     * @principle Requires backend management of transactions within a tenant.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores product data for a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) Any authenticated user can read product data within their tenant.
     * @deny (create, update, delete) No one can create, update, or delete products directly.
     * @principle Requires backend management of products within a tenant.
     */
    match /tenants/{tenantId}/products/{productId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores general settings for a tenant.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get) Any authenticated user can read tenant settings.
     * @deny (create, update, delete) No one can create, update, or delete tenant settings directly.
     * @principle Requires backend management of tenant settings.
     */
    match /tenants/{tenantId}/settings/general {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

        /**
     * @description Stores module settings for a tenant.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get) Any authenticated user can read tenant module settings.
     * @deny (create, update, delete) No one can create, update, or delete tenant module settings directly.
     * @principle Requires backend management of tenant module settings.
     */
    match /tenants/{tenantId}/settings/modules {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

        /**
     * @description Stores RKSV settings for a tenant.
     * @path /tenants/{tenantId}/settings/rksv
     * @allow (get) Any authenticated user can read tenant RKSV settings.
     * @deny (create, update, delete) No one can create, update, or delete tenant RKSV settings directly.
     * @principle Requires backend management of tenant RKSV settings.
     */
    match /tenants/{tenantId}/settings/rksv {
      allow get: if isSignedIn();
       allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores globally available subscription plans.
     * @path /global/plans/{planId}
     * @allow (get, list) Any user can read plan information.
     * @deny (create, update, delete) Plans can only be created and updated by the backend.
     * @principle Provides public read access to subscription plans.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores chat messages within a tenant.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, list) Any authenticated user can read chat messages within their tenant.
     * @deny (create, update, delete) No one can create, update, or delete chat messages directly.
     * @principle Requires backend management of chat messages within a tenant.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }

  function isSignedIn() {
    return request.auth != null;
  }
}