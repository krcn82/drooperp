/**
 * @fileoverview Firestore Security Rules for the ERP application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model where users are associated with specific tenants.
 * Data access is primarily restricted to users within their respective tenants, with some global read access for shared resources like subscription plans.
 *
 * Data Structure:
 * - /users/{userId}: Maps user UIDs to tenant IDs. This is the primary entry point for determining a user's tenant.
 * - /tenants/{tenantId}: Stores tenant-specific information.
 * - /tenants/{tenantId}/*: Subcollections under each tenant for data like users, products, and transactions.
 * - /global/plans/{planId}: Globally accessible collection for subscription plans.
 * - /mail/{mailId}: Collection used to trigger outbound emails.
 *
 * Key Security Decisions:
 * - User listing is generally disallowed to prevent information disclosure.
 * - Tenant-level data access is strictly enforced, preventing cross-tenant data access.
 * - The /global/plans collection is publicly readable.
 * - The /mail collection is publicly writable so extensions can create outbound emails.
 *
 * Denormalization for Authorization:
 * - The /users/{userId} document contains the tenantId to avoid needing to query user details to determine the tenant.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Maps user UIDs to tenant IDs. Used for tenant-based security.
     * @path /users/{userId}
     * @allow (create) Authenticated user with matching UID can create this document.
     * @deny (create) Authenticated user attempts to create a document with a mismatched UID.
     * @allow (get, list) Authenticated user with matching UID can read this document.
     * @deny (update, delete) No updates or deletes allowed on user-tenant mappings.
     * @principle Owner-only access with self-creation for initial tenant assignment.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow update, delete: if false;
    }

    /**
     * @description Stores tenant-specific information.
     * @path /tenants/{tenantId}
     * @allow (create) No direct creation allowed through client.
     * @deny (create) No one can create tenants directly.
     * @allow (get, list) No direct reads or lists allowed.
     * @deny (get, list) Tenants are generally not public.
     * @allow (update, delete) No direct client updates or deletes.
     * @deny (update, delete) Tenants are only managed internally.
     * @principle Tenant documents are not directly accessible by end-users.
     */
    match /tenants/{tenantId} {
      allow create, get, list, update, delete: if false;
    }

    /**
     * @description Sub-collection for users within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (create) Authenticated user within the tenant can create new user.
     * @deny (create) User not in tenant cannot create users.
     * @allow (get) Authenticated user within the tenant can get any user.
     * @allow (list) Authenticated user within the tenant can list users.
     * @deny (update, delete) Only admins can update or delete users.
     * @principle Tenant-scoped user management.
     */
    match /tenants/{tenantId}/users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow create: if isSignedIn() && isInTenant(tenantId);
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if isSignedIn() && isInTenant(tenantId);
      allow update, delete: if false; // Implement admin role check here if needed
    }

    /**
     * @description Sub-collection for transactions within a tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (create) Authenticated user within the tenant can create a transaction.
     * @deny (create) User not in tenant cannot create transactions.
     * @allow (get) Authenticated user within the tenant can get any transaction.
     * @allow (list) Authenticated user within the tenant can list transactions.
     * @deny (update, delete) Transactions are append-only or managed by a service.
     * @principle Tenant-scoped transaction management.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow create: if isSignedIn() && isInTenant(tenantId);
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if isSignedIn() && isInTenant(tenantId);
      allow update, delete: if false;
    }

    /**
     * @description Sub-collection for products within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (create) Authenticated user within the tenant can create products.
     * @deny (create) User not in tenant cannot create products.
     * @allow (get) Authenticated user within the tenant can get any product.
     * @allow (list) Authenticated user within the tenant can list products.
     * @deny (update, delete) Products are tenant-managed. Implement role checks here.
     * @principle Tenant-scoped product management.
     */
    match /tenants/{tenantId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow create: if isSignedIn() && isInTenant(tenantId);
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if isSignedIn() && isInTenant(tenantId);
      allow update, delete: if false; // Implement role checks here if needed
    }

    /**
     * @description Document for general settings within a tenant.
     * @path /tenants/{tenantId}/settings/general
     * @allow (create) No direct creation allowed.
     * @deny (create) Settings documents should be created by a service.
     * @allow (get) Authenticated user within the tenant can read settings.
     * @deny (list) Listing settings documents is not allowed.
     * @allow (update) Authenticated user within the tenant can update settings.
     * @deny (delete) Settings documents are not intended to be deleted.
     * @principle Tenant-scoped settings.
     */
    match /tenants/{tenantId}/settings/general {
      function isSignedIn() {
        return request.auth != null;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if false;
      allow create: if false;
      allow update: if isSignedIn() && isInTenant(tenantId);
      allow delete: if false;
    }

    /**
     * @description Document for module settings within a tenant.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (create) No direct creation allowed.
     * @deny (create) Settings documents should be created by a service.
     * @allow (get) Authenticated user within the tenant can read settings.
     * @deny (list) Listing settings documents is not allowed.
     * @allow (update) Authenticated user within the tenant can update settings.
     * @deny (delete) Settings documents are not intended to be deleted.
     * @principle Tenant-scoped module settings.
     */
    match /tenants/{tenantId}/settings/modules {
      function isSignedIn() {
        return request.auth != null;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if false;
      allow create: if false;
      allow update: if isSignedIn() && isInTenant(tenantId);
      allow delete: if false;
    }

    /**
     * @description Document for automation rule settings within a tenant.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow (create) No direct creation allowed.
     * @deny (create) Settings documents should be created by a service.
     * @allow (get) Authenticated user within the tenant can read settings.
     * @deny (list) Listing settings documents is not allowed.
     * @allow (update) Authenticated user within the tenant can update settings.
     * @deny (delete) Settings documents are not intended to be deleted.
     */
    match /tenants/{tenantId}/settings/automationRules {
       function isSignedIn() {
        return request.auth != null;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if false;
      allow create: if false;
      allow update: if isSignedIn() && isInTenant(tenantId);
      allow delete: if false;
    }

    /**
     * @description Document for RKSV key and status within a tenant.
     * @path /tenants/{tenantId}/settings/rksv
     * @allow (create) No direct creation allowed.
     * @deny (create) Settings documents should be created by a service.
     * @allow (get) Authenticated user within the tenant can read RKSV settings.
     * @deny (list) Listing settings documents is not allowed.
     * @allow (update) Authenticated user within the tenant can update RKSV settings.
     * @deny (delete) Settings documents are not intended to be deleted.
     * @principle Tenant-scoped RKSV settings.
     */
    match /tenants/{tenantId}/settings/rksv {
      function isSignedIn() {
        return request.auth != null;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if false;
      allow create: if false;
      allow update: if isSignedIn() && isInTenant(tenantId);
      allow delete: if false;
    }

    /**
     * @description Stores credentials and status for third-party integrations like Wolt or Foodora.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (create) Authenticated user within the tenant can create integrations.
     * @deny (create) User not in tenant cannot create integrations.
     * @allow (get) Authenticated user within the tenant can get any integration.
     * @allow (list) Authenticated user within the tenant can list integrations.
     * @deny (update, delete) Integrations are tenant-managed. Implement role checks here.
     * @principle Tenant-scoped integrations.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow create: if isSignedIn() && isInTenant(tenantId);
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if isSignedIn() && isInTenant(tenantId);
      allow update, delete: if false; // Implement role checks here if needed
    }

    /**
     * @description Global collection for subscription plans.
     * @path /global/plans/{planId}
     * @allow (create) No public creation allowed.
     * @deny (create) Only a service account can create plans.
     * @allow (get, list) Everyone can read subscription plans.
     * @deny (update, delete) No updates or deletes allowed.
     * @principle Globally readable subscription plans.
     */
    match /global/plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Sub-collection for messages within an AI chat session.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (create) Authenticated user within the tenant can create messages.
     * @deny (create) User not in tenant cannot create messages.
     * @allow (get) Authenticated user within the tenant can get any message.
     * @allow (list) Authenticated user within the tenant can list messages.
     * @deny (update, delete) Messages are append-only.
     * @principle Tenant-scoped AI chat messages.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow create: if isSignedIn() && isInTenant(tenantId);
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if isSignedIn() && isInTenant(tenantId);
      allow update, delete: if false;
    }

    /**
     * @description Sub-collection for orders from external POS/delivery platforms.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (create) Incoming requests from external POS/delivery platforms via webhook.
     * @deny (create) Direct client-side creation should be denied.
     * @allow (get) Authenticated user within the tenant can get any POS order.
     * @allow (list) Authenticated user within the tenant can list POS orders.
     * @deny (update, delete) POS orders should be append-only.
     * @principle Tenant-scoped POS orders.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow create: if true; // Webhooks don't have auth context
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if isSignedIn() && isInTenant(tenantId);
      allow update, delete: if false;
    }

    /**
     * @description Sub-collection for logging incoming webhook API calls.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (create) Any service can write to the audit log (e.g., extension).
     * @deny (create)
     * @allow (get) Authenticated user within the tenant can get audit logs.
     * @allow (list) Authenticated user within the tenant can list audit logs.
     * @deny (update, delete) No updates or deletes to audit logs.
     * @principle Audit logging of incoming webhooks.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow create: if true; // Webhooks don't have auth context
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if isSignedIn() && isInTenant(tenantId);
      allow update, delete: if false;
    }

    /**
     * @description Sub-collection for user and system notifications within a tenant.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (create) System or authenticated user within the tenant can create notifications.
     * @deny (create)
     * @allow (get) Authenticated user within the tenant can get any notification.
     * @allow (list) Authenticated user within the tenant can list notifications.
     * @deny (update, delete)
     * @principle Tenant-scoped notifications.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isInTenant(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow create: if true; // Notifications are made with Admin SDK
      allow get: if isSignedIn() && isInTenant(tenantId);
      allow list: if isSignedIn() && isInTenant(tenantId);
      allow update, delete: if false;
    }

    /**
     * @description Collection for triggering email sending via Firebase Extensions (e.g., SendGrid, Mailgun).
     * @path /mail/{mailId}
     * @allow (create) Public write for extensions to trigger emails.
     * @deny (create)
     * @allow (get, list) No reads allowed.
     * @deny (update, delete) No updates or deletes allowed.
     * @principle Public write-only access for outbound email triggering.
     */
    match /mail/{mailId} {
      allow create: if true; // Extension creates outbound emails
      allow get, list, update, delete: if false;
    }
  }
}