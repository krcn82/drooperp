rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @file Firestore Security Rules
     * @core-philosophy This ruleset enforces a strict tenant-based security model,
     *  where users can only access data within their assigned tenant. All write
     *  operations are restricted to authenticated users. Data relationships are
     *  validated on write to maintain consistency. Read access is generally
     *  restricted to tenant members, except for globally accessible plan data.
     * @data-structure
     *  - /users/{userId}: Maps user UIDs to tenant IDs.
     *  - /tenants/{tenantId}: Stores tenant information.
     *  - /tenants/{tenantId}/users/{userId}: Stores user information within a tenant.
     *  - /tenants/{tenantId}/transactions/{transactionId}: Stores transaction data.
     *  - /tenants/{tenantId}/products/{productId}: Stores product data.
     *  - /tenants/{tenantId}/settings/general: Stores general tenant settings.
     *  - /tenants/{tenantId}/settings/modules: Stores tenant module settings.
     *  - /tenants/{tenantId}/settings/rksv: Stores RKSV key and status.
     *  - /tenants/{tenantId}/integrations/{platformId}: Stores third-party integration settings.
     *  - /global/plans/{planId}: Stores global subscription plans.
     *  - /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}: Stores AI chat messages.
     *  - /tenants/{tenantId}/posOrders/{orderId}: Stores POS orders from external platforms.
     *  - /tenants/{tenantId}/auditLogs/{logId}: Stores audit logs for API calls.
     * @key-security-decisions
     *  - Users can only create their own /users/{userId} document.
     *  - All other data creation, modification, and deletion are limited to
     *    authenticated users within their respective tenants.
     *  - Listing of users within a tenant is allowed for tenant members.
     *  - Global plans are publicly readable.
     * @denormalization-for-authorization
     *  - The /users/{userId} document denormalizes the tenantId, which allows us
     *    to quickly check if a user is authorized to access resources within that
     *    tenant.
     */

    /**
     * @description Allows a user to create their own user mapping document.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates /users/user123.
     * @deny (create) User with UID 'user123' attempts to create /users/user456.
     * @principle Enforces self-creation of user mapping documents.
     */
    match /users/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Manages access to tenant documents.
     * @path /tenants/{tenantId}
     * @allow (get, list) Always deny, no public data here
     * @deny (create, update, delete) No one can create, update, or delete tenants via client.
     * @principle Only backend processes should manage tenants.
     */
    match /tenants/{tenantId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to user documents within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get, list) Tenant member reads user profiles.
     * @allow (create) Tenant member creates user profile
     * @allow (update, delete) Tenant member changes user profile
     * @deny (create, update, delete) Non-tenant member attempts write operations.
     * @principle Enforces tenant-based access control.
     */
    match /tenants/{tenantId}/users/{userId} {
      allow get: if isSignedIn() && isTenantMember(tenantId);
      allow list: if isSignedIn() && isTenantMember(tenantId);
      allow create: if isSignedIn() && isTenantMember(tenantId);
      allow update: if isSignedIn() && isTenantMember(tenantId);
      allow delete: if isSignedIn() && isTenantMember(tenantId);
    }

    /**
     * @description Manages access to transaction documents within a tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get, list) Tenant member reads transactions.
     * @allow (create) Tenant member creates transaction.
     * @allow (update, delete) Tenant member changes transaction.
     * @deny (create, update, delete) Non-tenant member attempts write operations.
     * @principle Enforces tenant-based access control.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      allow get: if isSignedIn() && isTenantMember(tenantId);
      allow list: if isSignedIn() && isTenantMember(tenantId);
      allow create: if isSignedIn() && isTenantMember(tenantId);
      allow update: if isSignedIn() && isTenantMember(tenantId);
      allow delete: if isSignedIn() && isTenantMember(tenantId);
    }

    /**
     * @description Manages access to product documents within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) Tenant member reads products.
     * @allow (create) Tenant member creates product.
     * @allow (update, delete) Tenant member changes product.
     * @deny (create, update, delete) Non-tenant member attempts write operations.
     * @principle Enforces tenant-based access control.
     */
    match /tenants/{tenantId}/products/{productId} {
      allow get: if isSignedIn() && isTenantMember(tenantId);
      allow list: if isSignedIn() && isTenantMember(tenantId);
      allow create: if isSignedIn() && isTenantMember(tenantId);
      allow update: if isSignedIn() && isTenantMember(tenantId);
      allow delete: if isSignedIn() && isTenantMember(tenantId);
    }

    /**
     * @description Manages access to general settings within a tenant.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get) Tenant member reads settings.
     * @allow (create, update, delete) Tenant member changes settings.
     * @deny (create, update, delete) Non-tenant member attempts write operations.
     * @principle Enforces tenant-based access control.
     */
    match /tenants/{tenantId}/settings/general {
      allow get: if isSignedIn() && isTenantMember(tenantId);
      allow list: if false;
      allow create: if isSignedIn() && isTenantMember(tenantId);
      allow update: if isSignedIn() && isTenantMember(tenantId);
      allow delete: if isSignedIn() && isTenantMember(tenantId);
    }

    /**
     * @description Manages access to module settings within a tenant.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get) Tenant member reads module settings.
     * @allow (create, update, delete) Tenant member changes module settings.
     * @deny (create, update, delete) Non-tenant member attempts write operations.
     * @principle Enforces tenant-based access control.
     */
    match /tenants/{tenantId}/settings/modules {
      allow get: if isSignedIn() && isTenantMember(tenantId);
      allow list: if false;
      allow create: if isSignedIn() && isTenantMember(tenantId);
      allow update: if isSignedIn() && isTenantMember(tenantId);
      allow delete: if isSignedIn() && isTenantMember(tenantId);
    }

    /**
     * @description Manages access to RKSV settings within a tenant.
     * @path /tenants/{tenantId}/settings/rksv
     * @allow (get) Tenant member reads RKSV settings.
     * @allow (create, update, delete) Tenant member changes RKSV settings.
     * @deny (create, update, delete) Non-tenant member attempts write operations.
     * @principle Enforces tenant-based access control.
     */
    match /tenants/{tenantId}/settings/rksv {
      allow get: if isSignedIn() && isTenantMember(tenantId);
      allow list: if false;
      allow create: if isSignedIn() && isTenantMember(tenantId);
      allow update: if isSignedIn() && isTenantMember(tenantId);
      allow delete: if isSignedIn() && isTenantMember(tenantId);
    }

    /**
     * @description Manages access to integration settings within a tenant.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get) Tenant member reads integration settings.
     * @allow (create, update, delete) Tenant member changes integration settings.
     * @deny (create, update, delete) Non-tenant member attempts write operations.
     * @principle Enforces tenant-based access control.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      allow get: if isSignedIn() && isTenantMember(tenantId);
      allow list: if false;
      allow create: if isSignedIn() && isTenantMember(tenantId);
      allow update: if isSignedIn() && isTenantMember(tenantId);
      allow delete: if isSignedIn() && isTenantMember(tenantId);
    }

    /**
     * @description Allows public read access to global plans.
     * @path /global/plans/{planId}
     * @allow (get, list) Public read access to plans.
     * @deny (create, update, delete) No one can create, update, or delete plans via client.
     */
    match /global/plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to AI chat messages within a tenant.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, list) Tenant member reads messages.
     * @allow (create) Tenant member creates message.
     * @allow (update, delete) Tenant member changes message.
     * @deny (create, update, delete) Non-tenant member attempts write operations.
     * @principle Enforces tenant-based access control.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      allow get: if isSignedIn() && isTenantMember(tenantId);
      allow list: if isSignedIn() && isTenantMember(tenantId);
      allow create: if isSignedIn() && isTenantMember(tenantId);
      allow update: if isSignedIn() && isTenantMember(tenantId);
      allow delete: if isSignedIn() && isTenantMember(tenantId);
    }

    /**
     * @description Manages access to POS orders within a tenant.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (get, list) Tenant member reads orders.
     * @allow (create) Tenant member creates order.
     * @allow (update, delete) Tenant member changes order.
     * @deny (create, update, delete) Non-tenant member attempts write operations.
     * @principle Enforces tenant-based access control.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      allow get: if isSignedIn() && isTenantMember(tenantId);
      allow list: if isSignedIn() && isTenantMember(tenantId);
      allow create: if isSignedIn() && isTenantMember(tenantId);
      allow update: if isSignedIn() && isTenantMember(tenantId);
      allow delete: if isSignedIn() && isTenantMember(tenantId);
    }

    /**
     * @description Manages access to audit logs within a tenant.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (get, list) Tenant member reads logs.
     * @allow (create) Tenant member creates logs.
     * @allow (update, delete) Tenant member changes logs.
     * @deny (create, update, delete) Non-tenant member attempts write operations.
     * @principle Enforces tenant-based access control.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
      allow get: if isSignedIn() && isTenantMember(tenantId);
      allow list: if isSignedIn() && isTenantMember(tenantId);
      allow create: if isSignedIn() && isTenantMember(tenantId);
      allow update: if isSignedIn() && isTenantMember(tenantId);
      allow delete: if isSignedIn() && isTenantMember(tenantId);
    }
  }

  /**
   * @description Checks if the user is signed in.
   * @return True if the user is signed in, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }

  /**
   * @description Checks if the user is the owner of the resource.
   * @param userId The user ID to check against.
   * @return True if the user is the owner, false otherwise.
   */
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  /**
   * @description Checks if the user is a member of the tenant.
   * @param tenantId The tenant ID to check against.
   * @return True if the user is a member of the tenant, false otherwise.
   */
  function isTenantMember(tenantId) {
    return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
  }
}