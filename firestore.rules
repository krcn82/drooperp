rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Maps user UIDs to tenant IDs for security rules.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create document /users/user123 setting tenantId to 'tenant456'.
     * @deny (create) User with UID 'user123' cannot create document /users/anotherUser setting tenantId to 'tenant456'.
     * @deny (update) User cannot update this top level user document.
     * @deny (delete) User cannot delete this top level user document.
     * @principle Enforces user-ownership: Only the authenticated user can create their own document.
     */
    match /users/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.tenantId is string;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores tenant information.
     * @path /tenants/{tenantId}
     * @allow (get, list) Any authenticated user can read tenants.
     * @deny (create, update, delete) No one can create, update or delete tenants (for now).
     * @principle Restricts creation, update, and deletion of tenants.
     */
    match /tenants/{tenantId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Sub-collection for users within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get, list) Authenticated user can read tenant users.
     * @allow (create) Authenticated user can create a tenant user if the tenant id matches.
     * @allow (update, delete) Authenticated user can only update/delete tenant users if the tenant id matches.
     * @principle Enforces that a user can only manage users within their tenant.
     */
    match /tenants/{tenantId}/users/{userId} {
      allow get, list: if isSignedIn() && isTenantUser(tenantId, userId);
      allow create: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
      allow update: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
      allow delete: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
    }

    /**
     * @description Sub-collection for transactions within a tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get, list) Authenticated user can read tenant transactions.
     * @allow (create) Authenticated user can create a transaction if they are a user in the tenant.
     * @allow (update, delete) Authenticated user can only update/delete transactions if they are a user in the tenant.
     * @principle Enforces that a user can only manage transactions within their tenant.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      allow get, list: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
      allow create: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
      allow update: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
      allow delete: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
    }

    /**
     * @description Sub-collection for products within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) Authenticated user can read tenant products.
     * @allow (create) Authenticated user can create a product if they are a user in the tenant.
     * @allow (update, delete) Authenticated user can only update/delete products if they are a user in the tenant.
     * @principle Enforces that a user can only manage products within their tenant.
     */
    match /tenants/{tenantId}/products/{productId} {
      allow get, list: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
      allow create: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
      allow update: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
      allow delete: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
    }

    /**
     * @description Sub-collection for settings within a tenant.
     * @path /tenants/{tenantId}/settings/{settingId}
     * @allow (get, list) Authenticated user can read tenant settings.
     * @allow (create) Authenticated user can create settings if they are a user in the tenant.
     * @allow (update, delete) Authenticated user can only update/delete settings if they are a user in the tenant.
     * @principle Enforces that a user can only manage settings within their tenant.
     */
    match /tenants/{tenantId}/settings/{settingId} {
      allow get, list: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
      allow create: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
      allow update: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
      allow delete: if isSignedIn() && isTenantUser(tenantId, request.auth.uid);
    }

    /**
     * @description Global collection for subscription plans.
     * @path /global/plans/{planId}
     * @allow (get, list) Any user can read the global plans.
     * @deny (create, update, delete) No one can create, update, or delete plans (for now).
     * @principle Provides public read access to subscription plans while restricting modifications.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isTenantUser(tenantId, userId) {
    return get(/databases/$(database)/documents/users/$(userId)).data.tenantId == tenantId;
  }

  function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
  }
}