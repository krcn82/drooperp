/**
 * @fileoverview Firestore Security Rules for the ERP application.
 *
 * Core Philosophy:
 * This ruleset prioritizes strong authorization, focusing on tenant-based isolation and role-based access where appropriate.
 * It uses a combination of ownership checks, role verification, and authenticated user validation to secure data.
 * Data shape validation is relaxed in this prototyping phase to allow rapid schema iteration.
 *
 * Data Structure:
 * - Data is primarily organized under tenants (`/tenants/{tenantId}`).
 * - User access is controlled both at the root level (`/users/{userId}`) and within tenants (`/tenants/{tenantId}/users/{userId}`).
 * - Global data like subscription plans is stored in the `/global` collection.
 *
 * Key Security Decisions:
 * - User listing is generally disallowed unless explicitly required and secured by role checks.
 * - The rules enforce tenant isolation, ensuring users can only access data within their assigned tenant.
 * - System-level operations (e.g., writing audit logs) are restricted to service accounts via custom claims (`request.auth.token.isSystem`).
 * - Read-only collections, if any, should have `allow get, list: if true;` for public data and stricter rules for sensitive data.
 * - Denormalization: The rules rely on `request.auth.token` (JWT) for tenantId to simplify payment rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Authentication: Ensures that only authenticated users can access certain resources.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Ownership: Enforces that a user can only access resources they own.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId and the document exists.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Ownership & Existence: Enforces that a user can only access resources they own and that the resource exists.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && existsAfter(/databases/$(database)/documents/users/$(userId));
    }

    /**
     * @description Checks if the authenticated user has the 'admin' role in their custom claims.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Role-Based Access Control: Restricts access to certain resources based on the user's role.
     */
    function isAdmin() {
      return request.auth.token.isAdmin == true;
    }

    /**
     * @description Checks if the authenticated user has the 'cashier' role in their custom claims.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Role-Based Access Control: Restricts access to certain resources based on the user's role.
     */
    function isCashier() {
      return request.auth.token.isCashier == true;
    }

    /**
     * @description Checks if the authenticated user has the 'viewer' role in their custom claims.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Role-Based Access Control: Restricts access to certain resources based on the user's role.
     */
    function isViewer() {
      return request.auth.token.isViewer == true;
    }

    /**
     * @description Checks if the request originates from a system with 'isSystem' custom claim.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Service Account: Restricts write access to service accounts for backend operations.
     */
    function isSystem() {
      return request.auth.token.isSystem == true;
    }

    /**
     * @description Rule for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own document.
     * @deny (create) - User attempts to create a document with an ID that doesn't match their own UID.
     * @allow (get, list) - Authenticated user can read their own document.
     * @deny (get, list) - User attempts to read another user's document.
     * @allow (update, delete) - Authenticated user can update their own document.
     * @deny (update, delete) - User attempts to update or delete another user's document.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /tenants/{tenantId} collection.
     * @path /tenants/{tenantId}
     * @allow (get, list) - Authenticated user can read tenant information.
     * @deny (create) - No one can create tenants through the client.
     * @deny (update) - No one can update tenants through the client.
     * @deny (delete) - No one can delete tenants through the client.
     * @principle Restricts creation, update, and deletion of tenants.
     */
    match /tenants/{tenantId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/users/{userId} collection.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get, list) - Authenticated user can read user information within a tenant.
     * @allow (create) - Authenticated user can create their own user document within a tenant.
     * @allow (update) - Authenticated user can update their own user document within a tenant.
     * @allow (delete) - Authenticated user can delete their own user document within a tenant.
     * @deny (create) - User attempts to create a document with an ID that doesn't match their own UID.
     * @deny (update) - User attempts to update another user's document or change the user ID.
     * @deny (delete) - User attempts to delete another user's document.
     * @principle Enforces document ownership and tenant isolation.
     */
    match /tenants/{tenantId}/users/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /tenants/{tenantId}/transactions/{transactionId} collection.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get, list) - Authenticated user can read transactions within a tenant.
     * @deny (create) - No one can create transactions through the client.
     * @deny (update) - No one can update transactions through the client.
     * @deny (delete) - No one can delete transactions through the client.
     * @principle Transactions should be created and managed by backend functions.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/payments/{paymentId} collection.
     * @path /tenants/{tenantId}/payments/{paymentId}
     * @allow (read) - Authenticated user can read payments if their tenantId matches the document's tenantId.
     * @allow (write) - Only system accounts can write payment data.
     * @deny (read) - User attempts to read payment data from a different tenant.
     * @deny (write) - Non-system accounts attempt to write payment data.
     * @principle Restricts payment data access based on tenant and system role.
     */
    match /tenants/{tenantId}/payments/{paymentId} {
      allow get: if isSignedIn() && request.auth.token.tenantId == tenantId;
      allow list: if false;
      allow create: if isSystem();
      allow update: if isSystem();
      allow delete: if isSystem();
    }

    /**
     * @description Rule for the /tenants/{tenantId}/products/{productId} collection.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) - Authenticated user can read products within a tenant.
     * @deny (create) - No one can create products through the client.
     * @deny (update) - No one can update products through the client.
     * @deny (delete) - No one can delete products through the client.
     * @principle Products should be created and managed by backend functions.
     */
    match /tenants/{tenantId}/products/{productId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/settings/general document.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get) - Authenticated user can read general settings within a tenant.
     * @deny (create) - No one can create general settings through the client.
     * @deny (update) - No one can update general settings through the client.
     * @deny (delete) - No one can delete general settings through the client.
     * @principle Settings should be managed by backend functions or admin users.
     */
    match /tenants/{tenantId}/settings/general {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/settings/modules document.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get) - Authenticated user can read module settings within a tenant.
     * @deny (create) - No one can create module settings through the client.
     * @deny (update) - No one can update module settings through the client.
     * @deny (delete) - No one can delete module settings through the client.
     * @principle Settings should be managed by backend functions or admin users.
     */
    match /tenants/{tenantId}/settings/modules {
      allow get: if isSignedIn();
       allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     /**
      * @description Rule for the /tenants/{tenantId}/settings/automationRules document.
      * @path /tenants/{tenantId}/settings/automationRules
      * @allow (get) - Authenticated user can read automation rules within a tenant.
      * @deny (create) - No one can create automation rules through the client.
      * @deny (update) - No one can update automation rules through the client.
      * @deny (delete) - No one can delete automation rules through the client.
      * @principle Settings should be managed by backend functions or admin users.
      */
    match /tenants/{tenantId}/settings/automationRules {
        allow get: if isSignedIn();
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }


    /**
     * @description Rule for the /tenants/{tenantId}/settings/rksv document.
     * @path /tenants/{tenantId}/settings/rksv
     * @allow (get) - Authenticated user can read RKSV settings within a tenant.
     * @deny (create) - No one can create RKSV settings through the client.
     * @deny (update) - No one can update RKSV settings through the client.
     * @deny (delete) - No one can delete RKSV settings through the client.
     * @principle Settings should be managed by backend functions or admin users.
     */
    match /tenants/{tenantId}/settings/rksv {
      allow get: if isSignedIn();
       allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/integrations/{platformId} collection.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get) - Authenticated user can read integration settings within a tenant.
     * @deny (create) - No one can create integration settings through the client.
     * @deny (update) - No one can update integration settings through the client.
     * @deny (delete) - No one can delete integration settings through the client.
     * @principle Settings should be managed by backend functions or admin users.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/cashRegisters/{registerId} collection.
     * @path /tenants/{tenantId}/cashRegisters/{registerId}
     * @allow (get, list) - Authenticated user can read cash register sessions within a tenant.
     * @deny (create) - No one can create cash register sessions through the client.
     * @deny (update) - No one can update cash register sessions through the client.
     * @deny (delete) - No one can delete cash register sessions through the client.
     * @principle Cash register sessions should be managed by backend functions.
     */
    match /tenants/{tenantId}/cashRegisters/{registerId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/reports/{reportId} collection.
     * @path /tenants/{tenantId}/reports/{reportId}
     * @allow (get, list) - Authenticated user can read reports within a tenant.
     * @deny (create) - No one can create reports through the client.
     * @deny (update) - No one can update reports through the client.
     * @deny (delete) - No one can delete reports through the client.
     */
    match /tenants/{tenantId}/reports/{reportId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /global/plans/{planId} collection.
     * @path /global/plans/{planId}
     * @allow (get, list) - Public read access to subscription plans.
     * @deny (create) - No one can create plans through the client.
     * @deny (update) - No one can update plans through the client.
     * @deny (delete) - No one can delete plans through the client.
     * @principle Subscription plans are managed by the system.
     */
    match /global/plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} collection.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, list) - Authenticated user can read chat messages within a tenant.
     * @deny (create) - No one can create chat messages through the client.
     * @deny (update) - No one can update chat messages through the client.
     * @deny (delete) - No one can delete chat messages through the client.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/posOrders/{orderId} collection.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (get, list) - Authenticated user can read POS orders within a tenant.
     * @deny (create) - No one can create POS orders through the client.
     * @deny (update) - No one can update POS orders through the client.
     * @deny (delete) - No one can delete POS orders through the client.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/auditLogs/{logId} collection.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (read) - Only admin users can read audit logs.
     * @allow (write) - Only system accounts can write audit logs.
     * @deny (read) - Non-admin users cannot read audit logs.
     * @deny (write) - Non-system accounts cannot write audit logs.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
      allow get: if isSignedIn() && isAdmin();
      allow list: if false;
      allow create: if isSystem();
      allow update: if isSystem();
      allow delete: if isSystem();
    }

    /**
     * @description Rule for the /tenants/{tenantId}/notifications/{notificationId} collection.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (get, list) - Authenticated user can read notifications within a tenant.
     * @deny (create) - No one can create notifications through the client.
     * @deny (update) - No one can update notifications through the client.
     * @deny (delete) - No one can delete notifications through the client.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /mail/{mailId} collection.
     * @path /mail/{mailId}
     * @deny (read) - No one can read mails.
     * @allow (write) - Only system accounts can create mail entries.
     */
    match /mail/{mailId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSystem();
      allow update: if isSystem();
      allow delete: if isSystem();
    }

     /**
      * @description Rule for the /auditLogs/{logId} collection.
      * @path /auditLogs/{logId}
      * @allow (read) - Only admin users can read audit logs.
      * @allow (write) - Only system accounts can write audit logs.
      * @deny (read) - Non-admin users cannot read audit logs.
      * @deny (write) - Non-system accounts cannot write audit logs.
      */
     match /auditLogs/{logId} {
        allow get: if isSignedIn() && isAdmin();
        allow list: if false;
        allow create: if isSystem();
        allow update: if isSystem();
        allow delete: if isSystem();
     }
  }
}