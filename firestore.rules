/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a tenant-centric security model. Most data is scoped to a specific tenant,
 * and access is generally restricted to authenticated users.  Top-level /users/{userId} documents
 * map UIDs to tenant IDs, enabling tenant-level authorization. Public read access is not granted
 * to any collections.
 *
 * Data Structure:
 * - /users/{userId}: Maps a user's UID to their tenant ID.
 * - /tenants/{tenantId}: Stores tenant information.
 * - /tenants/{tenantId}/users/{userId}: Stores user data within a tenant.
 * - /tenants/{tenantId}/transactions/{transactionId}: Stores transaction data within a tenant.
 * - /tenants/{tenantId}/products/{productId}: Stores product data within a tenant.
 * - /tenants/{tenantId}/settings/{settingId}: Stores settings for a tenant.
 * - /global/plans/{planId}: Stores global subscription plans.
 * - /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}: Stores AI chat messages within a tenant.
 *
 * Key Security Decisions:
 * - Listing tenants is disallowed to prevent enumeration.
 * - Transactions, products, and users are tenant-scoped, requiring a valid tenant ID for access.
 * - The /users/{userId} collection is crucial for mapping user IDs to tenant IDs. Only the user themselves can create this document and the tenantID must be validated.
 *
 * Denormalization for Authorization:
 * - The `tenantId` is denormalized onto most documents to simplify tenant-based access control. This avoids costly `get()` operations to parent collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Maps a user's UID to their tenant ID. Only the user can create/update this document.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own UserTenant document with matching userId and their tenantId is valid.
     * @deny (create) - Unauthenticated user attempts to create a UserTenant document.
     * @deny (update) - A user attempts to modify another user's UserTenant document.
     * @principle Enforces document ownership for writes and requires authentication.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.tenantId is string;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Stores tenant information.
     * @path /tenants/{tenantId}
     * @allow (get) - Authenticated user can read tenant information.
     * @deny (create) - No one can create a tenant document.
     * @deny (update) - No one can update a tenant document.
     * @deny (delete) - No one can delete a tenant document.
     * @principle No writes allowed.
     */
    match /tenants/{tenantId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores user data within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (create) - Authenticated user creates a user document within a tenant.
     * @deny (create) - Unauthenticated user attempts to create a user document.
     * @deny (update) - A user attempts to modify another user's document within a tenant.
     * @principle Enforces tenant-scoped user management and requires authentication.
     */
    match /tenants/{tenantId}/users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores transaction data within a tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get) - Authenticated user can read a transaction within their tenant.
     * @allow (list) - Authenticated user can list transactions within their tenant.
     * @deny (create) - Unauthenticated user attempts to create a transaction.
     * @deny (update) - A user attempts to modify a transaction without proper authorization.
     * @deny (delete) - A user attempts to delete a transaction without proper authorization.
     * @principle Enforces tenant-scoped transaction management and requires authentication.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores product data within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get) - Authenticated user can read a product within their tenant.
     * @deny (create) - Unauthenticated user attempts to create a product.
     * @deny (update) - A user attempts to modify a product without proper authorization.
     * @deny (delete) - A user attempts to delete a product without proper authorization.
     * @principle Enforces tenant-scoped product management and requires authentication.
     */
    match /tenants/{tenantId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores settings for a tenant.
     * @path /tenants/{tenantId}/settings/{settingId}
     * @allow (get) - Authenticated user can read settings within their tenant.
     * @deny (create) - Unauthenticated user attempts to create settings.
     * @deny (update) - A user attempts to modify settings without proper authorization.
     * @deny (delete) - A user attempts to delete settings without proper authorization.
     * @principle Enforces tenant-scoped settings management and requires authentication.
     */
    match /tenants/{tenantId}/settings/{settingId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores global subscription plans.
     * @path /global/plans/{planId}
     * @allow (get) - Authenticated user can read a plan.
     * @deny (create) - Unauthenticated user attempts to create a plan.
     * @deny (update) - A user attempts to modify a plan without proper authorization.
     * @deny (delete) - A user attempts to delete a plan without proper authorization.
     */
    match /global/plans/{planId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     /**
      * @description Stores AI chat messages within a tenant.
      * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
      * @allow (get) - Authenticated user can read a message within their tenant's AI chat.
      * @deny (create) - Unauthenticated user attempts to create a message.
      * @deny (update) - A user attempts to modify a message without proper authorization.
      * @deny (delete) - A user attempts to delete a message without proper authorization.
      * @principle Enforces tenant-scoped AI chat management and requires authentication.
      */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
       function isSignedIn() {
         return request.auth != null;
       }
       allow get: if isSignedIn();
       allow list: if isSignedIn();
       allow create: if isSignedIn();
       allow update: if false;
       allow delete: if false;
     }
  }
}