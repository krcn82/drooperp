/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict tenant-based security model with user-based access control.
 *
 * Data Structure:
 * - /users/{userId}: Maps user UIDs to tenant IDs. This is a critical lookup for all tenant-scoped data access.
 * - /tenants/{tenantId}: Stores tenant-level information.
 * - /tenants/{tenantId}/...: All tenant-specific data is nested under the respective tenant.
 * - /global/plans/{planId}: Globally available subscription plans.
 *
 * Key Security Decisions:
 * - Strict Tenant Isolation: All data access is scoped to a tenant. Users can only access data within their assigned tenant.
 * - User-Based Access Control: Within a tenant, access to user-specific data (e.g., /tenants/{tenantId}/users/{userId}) is restricted to the user themselves.
 * - No User Listing: Listing all users is generally disallowed for privacy and security.
 * - Public Read for Plans: Subscription plans in /global/plans are publicly readable.
 * - Audit Logs: Creation only for logs from external sources (e.g. wolt, foodora)
 *
 * Denormalization for Authorization:
 * - The /users/{userId} document MUST contain the `tenantId` to authorize access to any /tenants/{tenantId} subcollection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to read and create their own UserTenant document, which maps their UID to a tenant ID.
     * @path /users/{userId}
     * @allow (create, get): if request.auth.uid == userId
     * @deny (update, delete, list): Always deny these operations.
     * @principle Enforces user-ownership for their UserTenant document.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows reading tenant information. No write access is granted in this example.
     * @path /tenants/{tenantId}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always deny these operations.
     * @principle Limits access to tenant read-only.
     */
    match /tenants/{tenantId} {
      allow get: if true;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;

       /**
         * @description Allows a user to read and manage their own user document within a tenant.
         * @path /tenants/{tenantId}/users/{userId}
         * @allow (get, list): if isTenantMember(tenantId)
         * @allow (create): if request.auth.uid == userId
         * @allow (update, delete): if isExistingOwner(tenantId, userId)
         * @deny (create, update, delete): if not isTenantMember(tenantId)
         * @principle Enforces tenant membership and user-ownership for user documents.
         */
      match /users/{userId} {
        function isTenantMember(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        function isOwner(userId) {
          return request.auth.uid == userId;
        }

        function isExistingOwner(tenantId, userId) {
            return isOwner(userId) && isTenantMember(tenantId) && resource != null;
        }

        allow get: if isTenantMember(tenantId);
        allow list: if false;
        allow create: if isOwner(userId) && isTenantMember(tenantId);
        allow update: if isExistingOwner(tenantId, userId);
        allow delete: if isExistingOwner(tenantId, userId);
      }

      /**
       * @description Allows a tenant member to manage transactions within their tenant.
       * @path /tenants/{tenantId}/transactions/{transactionId}
       * @allow (get, list): if isTenantMember(tenantId)
       * @allow (create, update, delete): if isTenantMember(tenantId)
       * @principle Enforces tenant membership for transaction management.
       */
      match /transactions/{transactionId} {
        function isTenantMember(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId) && resource != null;
        allow delete: if isTenantMember(tenantId) && resource != null;
      }

      /**
       * @description Allows a tenant member to manage products within their tenant.
       * @path /tenants/{tenantId}/products/{productId}
       * @allow (get, list): if isTenantMember(tenantId)
       * @allow (create, update, delete): if isTenantMember(tenantId)
       * @principle Enforces tenant membership for product management.
       */
      match /products/{productId} {
        function isTenantMember(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId) && resource != null;
        allow delete: if isTenantMember(tenantId) && resource != null;
      }

      /**
       * @description Allows a tenant member to read and write general settings for their tenant.
       * @path /tenants/{tenantId}/settings/general
       * @allow (get, list): if isTenantMember(tenantId)
       * @allow (create, update, delete): if isTenantMember(tenantId)
       * @principle Enforces tenant membership for settings management.
       */
      match /settings/general {
        function isTenantMember(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isTenantMember(tenantId);
        allow list: if false;
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId) && resource != null;
        allow delete: if isTenantMember(tenantId) && resource != null;
      }

      /**
       * @description Allows a tenant member to read and write module settings for their tenant.
       * @path /tenants/{tenantId}/settings/modules
       * @allow (get, list): if isTenantMember(tenantId)
       * @allow (create, update, delete): if isTenantMember(tenantId)
       * @principle Enforces tenant membership for module settings management.
       */
      match /settings/modules {
        function isTenantMember(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isTenantMember(tenantId);
        allow list: if false;
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId) && resource != null;
        allow delete: if isTenantMember(tenantId) && resource != null;
      }

      /**
       * @description Allows a tenant member to read and write RKSV settings for their tenant.
       * @path /tenants/{tenantId}/settings/rksv
       * @allow (get, list): if isTenantMember(tenantId)
       * @allow (create, update, delete): if isTenantMember(tenantId)
       * @principle Enforces tenant membership for RKSV settings management.
       */
      match /settings/rksv {
        function isTenantMember(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isTenantMember(tenantId);
        allow list: if false;
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId) && resource != null;
        allow delete: if isTenantMember(tenantId) && resource != null;
      }

      /**
       * @description Allows a tenant member to manage integrations within their tenant.
       * @path /tenants/{tenantId}/integrations/{platformId}
       * @allow (get, list): if isTenantMember(tenantId)
       * @allow (create, update, delete): if isTenantMember(tenantId)
       * @principle Enforces tenant membership for integration management.
       */
      match /integrations/{platformId} {
        function isTenantMember(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId) && resource != null;
        allow delete: if isTenantMember(tenantId) && resource != null;
      }

      /**
       * @description Allows a tenant member to manage AI chat messages within their tenant.
       * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
       * @allow (get, list): if isTenantMember(tenantId)
       * @allow (create, update, delete): if isTenantMember(tenantId)
       * @principle Enforces tenant membership for AI chat message management.
       */
      match /aiChats/{chatId}/messages/{messageId} {
        function isTenantMember(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId) && resource != null;
        allow delete: if isTenantMember(tenantId) && resource != null;
      }

      /**
       * @description Allows a tenant member to manage POS orders within their tenant.
       * @path /tenants/{tenantId}/posOrders/{orderId}
       * @allow (get, list): if isTenantMember(tenantId)
       * @allow (create, update, delete): if isTenantMember(tenantId)
       * @principle Enforces tenant membership for POS order management.
       */
      match /posOrders/{orderId} {
        function isTenantMember(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId) && resource != null;
        allow delete: if isTenantMember(tenantId) && resource != null;
      }

       /**
         * @description Allows a tenant member to manage audit logs within their tenant. However, only creation is allowed for external sources.
         * @path /tenants/{tenantId}/auditLogs/{logId}
         * @allow (get, list): if isTenantMember(tenantId)
         * @allow (create): if isTenantMember(tenantId)
         * @deny (update, delete): Always deny these operations.
         * @principle Enforces tenant membership for audit log management.
         */
        match /auditLogs/{logId} {
            function isTenantMember(tenantId) {
                return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
            }

            allow get: if isTenantMember(tenantId);
            allow list: if isTenantMember(tenantId);
            allow create: if isTenantMember(tenantId);
            allow update: if false;
            allow delete: if false;
        }
    }

    /**
     * @description Allows public read access to subscription plans.
     * @path /global/plans/{planId}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always deny these operations.
     * @principle Allows public read for plans.
     */
    match /global/plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}