/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model where users primarily access data scoped to their tenant.
 * Access is generally restricted to authenticated users, with ownership-based access for user-specific data.
 * Public listing of collections is disallowed unless explicitly intended for public consumption.
 *
 * Data Structure:
 * - /users/{userId}: Maps user IDs to tenant IDs. This is the entry point for determining a user's tenant.
 * - /tenants/{tenantId}: Stores tenant-level information.
 * - /tenants/{tenantId}/users/{userId}: Stores user profiles within a tenant.
 * - /tenants/{tenantId}/transactions/{transactionId}: Stores transaction data for a tenant.
 * - /tenants/{tenantId}/products/{productId}: Stores product data for a tenant.
 * - /tenants/{tenantId}/settings/{settingId}: Stores tenant-specific settings.
 * - /global/plans/{planId}: Stores global subscription plans.
 * - /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}: Stores AI chat messages within a tenant.
 *
 * Key Security Decisions:
 * - User listing is disallowed for security and privacy.
 * - The /users/{userId} collection is strictly owner-only for both reads and writes.
 * - All data access under /tenants/{tenantId} is implicitly restricted to users belonging to that tenant,
 *   verified by checking the /users/{userId} document.
 * - Global plans are publicly readable but writable only by a privileged role (not implemented in this prototype).
 * - To enhance security and performance, tenantId values from /users/{userId} are used to control access to all tenant-scoped collections.
 * - No write operations are allowed with `if true;`.
 *
 * Denormalization for Authorization:
 *  - The `UserTenant` document at `/users/{userId}` is critical. It denormalizes the `tenantId` onto the user's root document,
 *    allowing rules to quickly determine the user's tenant without having to query user profiles under each `/tenants/{tenantId}` collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Restricts access to the /users/{userId} collection to the owner.
     * @path /users/{userId}
     * @allow (get, create, update, delete, list) if the request is made by the user with matching userId.
     * @deny (get, create, update, delete, list) if the request is made by a different user or an unauthenticated user.
     * @principle Enforces strict user-ownership for managing tenant assignment.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Restricts access to the /tenants/{tenantId} collection to authenticated users.
     * @path /tenants/{tenantId}
     * @allow (get, list) if the request is made by an authenticated user.
     * @allow (create, update, delete) if false, preventing unauthorized modification of tenant information.
     * @deny (get, list) if the request is made by an unauthenticated user.
     * @principle Authenticated access to tenant information, with restricted write permissions.
     */
    match /tenants/{tenantId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Restricts access to the /tenants/{tenantId}/users/{userId} collection to users within the specified tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get, create, update, delete, list) if the request is made by a user belonging to the tenant.
     * @deny (get, create, update, delete, list) if the request is made by a user not belonging to the tenant or an unauthenticated user.
     * @principle Enforces tenant-based access control for user profiles.
     */
    match /tenants/{tenantId}/users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantIdForUser(userId) {
          return get(/databases/$(database)/documents/users/$(userId)).data.tenantId;
      }
      function isUserInTenant(tenantId) {
        return isSignedIn() && getTenantIdForUser(request.auth.uid) == tenantId;
      }
      allow get: if isUserInTenant(tenantId);
      allow list: if isUserInTenant(tenantId);
      allow create: if isUserInTenant(tenantId);
      allow update: if isUserInTenant(tenantId);
      allow delete: if isUserInTenant(tenantId);
    }

    /**
     * @description Restricts access to the /tenants/{tenantId}/transactions/{transactionId} collection to users within the specified tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get, create, update, delete, list) if the request is made by a user belonging to the tenant.
     * @deny (get, create, update, delete, list) if the request is made by a user not belonging to the tenant or an unauthenticated user.
     * @principle Enforces tenant-based access control for transaction data.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantIdForUser(userId) {
          return get(/databases/$(database)/documents/users/$(userId)).data.tenantId;
      }
      function isUserInTenant(tenantId) {
        return isSignedIn() && getTenantIdForUser(request.auth.uid) == tenantId;
      }
      allow get: if isUserInTenant(tenantId);
      allow list: if isUserInTenant(tenantId);
      allow create: if isUserInTenant(tenantId);
      allow update: if isUserInTenant(tenantId);
      allow delete: if isUserInTenant(tenantId);
    }

    /**
     * @description Restricts access to the /tenants/{tenantId}/products/{productId} collection to users within the specified tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, create, update, delete, list) if the request is made by a user belonging to the tenant.
     * @deny (get, create, update, delete, list) if the request is made by a user not belonging to the tenant or an unauthenticated user.
     * @principle Enforces tenant-based access control for product data.
     */
    match /tenants/{tenantId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantIdForUser(userId) {
          return get(/databases/$(database)/documents/users/$(userId)).data.tenantId;
      }
      function isUserInTenant(tenantId) {
        return isSignedIn() && getTenantIdForUser(request.auth.uid) == tenantId;
      }
      allow get: if isUserInTenant(tenantId);
      allow list: if isUserInTenant(tenantId);
      allow create: if isUserInTenant(tenantId);
      allow update: if isUserInTenant(tenantId);
      allow delete: if isUserInTenant(tenantId);
    }

    /**
     * @description Restricts access to the /tenants/{tenantId}/settings/{settingId} collection to users within the specified tenant.
     * @path /tenants/{tenantId}/settings/{settingId}
     * @allow (get, create, update, delete, list) if the request is made by a user belonging to the tenant.
     * @deny (get, create, update, delete, list) if the request is made by a user not belonging to the tenant or an unauthenticated user.
     * @principle Enforces tenant-based access control for tenant settings.
     */
    match /tenants/{tenantId}/settings/{settingId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantIdForUser(userId) {
          return get(/databases/$(database)/documents/users/$(userId)).data.tenantId;
      }
      function isUserInTenant(tenantId) {
        return isSignedIn() && getTenantIdForUser(request.auth.uid) == tenantId;
      }
      allow get: if isUserInTenant(tenantId);
      allow list: if isUserInTenant(tenantId);
      allow create: if isUserInTenant(tenantId);
      allow update: if isUserInTenant(tenantId);
      allow delete: if isUserInTenant(tenantId);
    }

    /**
     * @description Allows public read access to the /global/plans/{planId} collection, but restricts write access.
     * @path /global/plans/{planId}
     * @allow (get, list) to anyone.
     * @allow (create, update, delete) if false, preventing unauthorized modification of plans.
     * @principle Public read access for plans, with restricted write permissions.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     /**
     * @description Restricts access to the /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} collection to users within the specified tenant.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, create, update, delete, list) if the request is made by a user belonging to the tenant.
     * @deny (get, create, update, delete, list) if the request is made by a user not belonging to the tenant or an unauthenticated user.
     * @principle Enforces tenant-based access control for chat messages.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function getTenantIdForUser(userId) {
          return get(/databases/$(database)/documents/users/$(userId)).data.tenantId;
      }
      function isUserInTenant(tenantId) {
        return isSignedIn() && getTenantIdForUser(request.auth.uid) == tenantId;
      }
      allow get: if isUserInTenant(tenantId);
      allow list: if isUserInTenant(tenantId);
      allow create: if isUserInTenant(tenantId);
      allow update: if isUserInTenant(tenantId);
      allow delete: if isUserInTenant(tenantId);
    }
    /**
     * @description Prevents listing of the kdsOrders collection due to insufficient permissions.
     * @path /tenants/{tenantId}/kdsOrders
     * @allow get: if false; // No read access to single kdsOrder documents.
     * @allow list: if false; // Explicitly deny listing of kdsOrders.
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Prevents unauthorized access to kdsOrders.
     */
     match /tenants/{tenantId}/kdsOrders/{document} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}