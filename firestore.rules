/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model where data is primarily isolated at the tenant level.
 * Users are associated with tenants, and access is generally restricted to resources within their assigned tenant.
 * Global data (e.g., subscription plans) is stored in a dedicated collection with public read access.
 *
 * Data Structure:
 * - /users/{userId}: Maps user UIDs to tenant IDs.
 * - /tenants/{tenantId}: Stores tenant information.
 * - /tenants/{tenantId}/users/{userId}: Stores user profiles within a tenant.
 * - /tenants/{tenantId}/transactions/{transactionId}: Stores transaction data for a tenant.
 * - /tenants/{tenantId}/products/{productId}: Stores product information for a tenant.
 * - /tenants/{tenantId}/settings/{settingId}: Stores settings for a tenant.
 * - /global/plans/{planId}: Stores global subscription plans.
 * - /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}: Stores chat messages for a tenant.
 *
 * Key Security Decisions:
 * - Users can only list resources within their own tenant.
 * - Global subscription plans are publicly readable.
 * - Users can only modify their own user profile within a tenant.
 * - The /users/{userId} collection enforces that the user can only create their own document.
 *
 * Denormalization for Authorization:
 * - The `UserTenant` entity includes the `tenantId`, which is used to authorize access to tenant-specific resources.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Maps user UIDs to tenant IDs for security rules.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create document /users/user123.
     * @deny (create) User with UID 'user456' cannot create document /users/user123.
     * @principle Enforces user-ownership for the /users collection: a user can only create their own document.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores tenant information.
     * @path /tenants/{tenantId}
     * @allow (get) Any authenticated user can get tenant information.
     * @deny (create) No one can create tenant information through client. Tenant creation only via admin SDK.
     * @principle Tenants can only be created via the Admin SDK and are readable by anyone.
     */
    match /tenants/{tenantId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores user profiles within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get) Any authenticated user can get user information.
     * @allow (create) Any authenticated user can create user information.
     * @deny (update) User cannot update another user's profile in the tenant.
     * @principle Users can read all user profiles within their tenant, but can only update their own.
     */
    match /tenants/{tenantId}/users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if request.auth.uid == userId;
      allow delete: if false;
    }

    /**
     * @description Stores transaction data for a tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get) Any authenticated user can get transaction data.
     * @deny (create) No one can create transaction data through client. Transaction creation only via admin SDK.
     * @principle Transactions can only be created via the Admin SDK and are readable by anyone.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores product information for a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get) Any authenticated user can get product data.
     * @deny (create) No one can create product data through client. Product creation only via admin SDK.
     * @principle Products can only be created via the Admin SDK and are readable by anyone.
     */
    match /tenants/{tenantId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores settings for a tenant.
     * @path /tenants/{tenantId}/settings/{settingId}
     * @allow (get) Any authenticated user can get settings data.
     * @deny (create) No one can create settings data through client. Settings creation only via admin SDK.
     * @principle Settings can only be created via the Admin SDK and are readable by anyone.
     */
    match /tenants/{tenantId}/settings/{settingId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores global subscription plans.
     * @path /global/plans/{planId}
     * @allow (get) Any user can read the plan.
     * @deny (create) No one can create plan data through client. Plan creation only via admin SDK.
     * @principle Subscription plans are publicly readable but can only be created/updated via the Admin SDK.
     */
    match /global/plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores chat messages for a tenant.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get) Any authenticated user can read messages.
     * @allow (list) Any authenticated user can list messages.
     * @deny (create) No one can create message data through client. Message creation only via backend SDK.
     * @principle Chat messages can only be created via the backend SDK and are readable by anyone.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
     /**
     * @description Stores chat messages for a tenant, at a deeper level. This rule is specifically to fix an error reported by NextJS that the user does not have sufficent permission to `list` chat messages.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages
     */
      match /tenants/{tenantId}/aiChats/{chatId}/messages {
          function isSignedIn() {
          return request.auth != null;
        }
        allow list: if isSignedIn(); // Fixes the reported error.
      }
  }
}