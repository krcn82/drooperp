rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A (Helper function)
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID.
     * @path N/A (Helper function)
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner and the document exists.
     * @path N/A (Helper function)
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && existsAfter(/databases/$(database)/documents/users/$(userId));
    }

    /**
     * @description Gets the tenant ID associated with the user from the /users/{userId} document.
     * @path N/A (Helper function)
     */
    function getTenantId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
    }

    /**
     * @description Checks if the request is made by a user belonging to the specified tenant.
     * @path N/A (Helper function)
     */
    function isInTenant(tenantId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }

    /**
     * @description Top-level collection to map user UIDs to tenant IDs for security rules.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates a document with ID 'user123' and tenantId.
     * @deny (create) User with UID 'user123' tries to create a document with ID 'user456'.
     * @deny (update) Any user tries to update this document (updates are disallowed).
     * @principle Enforces document ownership for creation; only the user can create their own entry.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Collection to store tenant information.
     * @path /tenants/{tenantId}
     * @allow (get) User belonging to tenant 'tenant123' reads the tenant document.
     * @deny (create) Any user tries to create a tenant document (creation is disallowed via client).
     * @principle Restricts access to tenant data to users within that tenant; tenant creation is handled via backend.
     */
    match /tenants/{tenantId} {
      allow get: if isInTenant(tenantId);
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Sub-collection for users within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get) User belonging to tenant 'tenant123' reads a user document within that tenant.
     * @allow (create) User belonging to tenant 'tenant123' creates a user document within that tenant.
     * @deny (update) Any user tries to update a user document (updates are disallowed).
     * @principle Restricts access to users within their assigned tenant; user management handled within tenant scope.
     */
    match /tenants/{tenantId}/users/{userId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId) && request.auth.uid == userId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Document for general settings within a tenant.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get) User belonging to tenant 'tenant123' reads the general settings.
     * @deny (create) Any user tries to create the settings document directly.
     * @principle Restricts access to tenant settings to users within that tenant; settings managed within tenant scope.
     */
    match /tenants/{tenantId}/settings/general {
      allow get: if isInTenant(tenantId);
      allow list: if false;
      allow create: if false;
      allow update: if isInTenant(tenantId);
      allow delete: if false;
    }

    /**
     * @description Document for module settings within a tenant.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get) User belonging to tenant 'tenant123' reads the module settings.
     * @deny (create) Any user tries to create the settings document directly.
     * @principle Restricts access to tenant settings to users within that tenant; settings managed within tenant scope.
     */
    match /tenants/{tenantId}/settings/modules {
      allow get: if isInTenant(tenantId);
      allow list: if false;
      allow create: if false;
      allow update: if isInTenant(tenantId);
      allow delete: if false;
    }

    /**
     * @description Document for automation rule settings within a tenant.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow (get) User belonging to the tenant can read the automation rules.
     * @allow (update) User belonging to the tenant can update the automation rules.
     * @deny (create) Creation not allowed.
     * @deny (delete) Deletion not allowed.
     * @principle Restricts access to tenant settings to users within that tenant; settings managed within tenant scope.
     */
    match /tenants/{tenantId}/settings/automationRules {
      allow get: if isInTenant(tenantId);
      allow list: if false;
      allow create: if false;
      allow update: if isInTenant(tenantId);
      allow delete: if false;
    }

    /**
     * @description Sub-collection for product categories within a tenant.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get) User belonging to the tenant can read categories.
     * @allow (list) User belonging to the tenant can list categories.
     * @allow (create) User belonging to the tenant can create categories.
     * @allow (update) User belonging to the tenant can update categories.
     * @allow (delete) User belonging to the tenant can delete categories.
     * @principle Tenant users have full CRUD access to product categories.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for products within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get) User belonging to the tenant can read products.
     * @allow (list) User belonging to the tenant can list products.
     * @allow (create) User belonging to the tenant can create products.
     * @allow (update) User belonging to the tenant can update products.
     * @allow (delete) User belonging to the tenant can delete products.
     * @principle Tenant users have full CRUD access to products.
     */
    match /tenants/{tenantId}/products/{productId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for customers within a tenant.
     * @path /tenants/{tenantId}/customers/{customerId}
     * @allow (get) User belonging to the tenant can read customers.
     * @allow (list) User belonging to the tenant can list customers.
     * @allow (create) User belonging to the tenant can create customers.
     * @allow (update) User belonging to the tenant can update customers.
     * @allow (delete) User belonging to the tenant can delete customers.
     * @principle Tenant users have full CRUD access to customers.
     */
    match /tenants/{tenantId}/customers/{customerId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for POS orders within a tenant.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get) User belonging to the tenant can read orders.
     * @allow (list) User belonging to the tenant can list orders.
     * @allow (create) User belonging to the tenant can create orders.
     * @allow (update) User belonging to the tenant can update orders.
     * @allow (delete) User belonging to the tenant can delete orders.
     * @principle Tenant users have full CRUD access to orders.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for restaurant tables within a tenant.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get) User belonging to the tenant can read tables.
     * @allow (list) User belonging to the tenant can list tables.
     * @allow (create) User belonging to the tenant can create tables.
     * @allow (update) User belonging to the tenant can update tables.
     * @allow (delete) User belonging to the tenant can delete tables.
     * @principle Tenant users have full CRUD access to tables.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for Kitchen Display System orders within a tenant.
     * @path /tenants/{tenantId}/kdsOrders/{kdsId}
     * @allow (get) User belonging to the tenant can read KDS orders.
     * @allow (list) User belonging to the tenant can list KDS orders.
     * @allow (create) User belonging to the tenant can create KDS orders.
     * @allow (update) User belonging to the tenant can update KDS orders.
     * @allow (delete) User belonging to the tenant can delete KDS orders.
     * @principle Tenant users have full CRUD access to KDS orders.
     */
    match /tenants/{tenantId}/kdsOrders/{kdsId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for payments within a tenant.
     * @path /tenants/{tenantId}/payments/{paymentId}
     * @allow (get) User belonging to the tenant can read payments.
     * @allow (list) User belonging to the tenant can list payments.
     * @allow (create) User belonging to the tenant can create payments.
     * @allow (update) User belonging to the tenant can update payments.
     * @allow (delete) User belonging to the tenant can delete payments.
     * @principle Tenant users have full CRUD access to payments.
     */
    match /tenants/{tenantId}/payments/{paymentId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Singleton document for RKSV fiscal certificate and configuration for a tenant.
     * @path /tenants/{tenantId}/rksvConfig
     * @allow (get) User belonging to the tenant can read the RKSV config.
     * @allow (update) User belonging to the tenant can update the RKSV config.
     * @deny (create) Creation not allowed.
     * @deny (delete) Deletion not allowed.
     * @principle Tenant users can read and update their RKSV config.
     */
    match /tenants/{tenantId}/rksvConfig {
      allow get: if isInTenant(tenantId);
      allow list: if false;
      allow create: if false;
      allow update: if isInTenant(tenantId);
      allow delete: if false;
    }

    /**
     * @description Sub-collection for the RKSV cryptographic signature chain.
     * @path /tenants/{tenantId}/signatures/{signatureId}
     * @allow (get) User belonging to the tenant can read signatures.
     * @allow (list) User belonging to the tenant can list signatures.
     * @allow (create) User belonging to the tenant can create signatures.
     * @allow (update) User belonging to the tenant can update signatures.
     * @allow (delete) User belonging to the tenant can delete signatures.
     * @principle Tenant users have full CRUD access to RKSV signatures.
     */
    match /tenants/{tenantId}/signatures/{signatureId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for daily Z-Reports (Tagesabschluss).
     * @path /tenants/{tenantId}/zReports/{reportId}
     * @allow (get) User belonging to the tenant can read zReports.
     * @allow (list) User belonging to the tenant can list zReports.
     * @allow (create) User belonging to the tenant can create zReports.
     * @allow (update) User belonging to the tenant can update zReports.
     * @allow (delete) User belonging to the tenant can delete zReports.
     * @principle Tenant users have full CRUD access to zReports.
     */
    match /tenants/{tenantId}/zReports/{reportId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for logging FinanzOnline API submissions.
     * @path /tenants/{tenantId}/finanzOnlineLogs/{logId}
     * @allow (get) User belonging to the tenant can read the FinanzOnline logs.
     * @allow (list) User belonging to the tenant can list the FinanzOnline logs.
     * @allow (create) User belonging to the tenant can create the FinanzOnline logs.
     * @allow (update) User belonging to the tenant can update the FinanzOnline logs.
     * @allow (delete) User belonging to the tenant can delete the FinanzOnline logs.
     */
    match /tenants/{tenantId}/finanzOnlineLogs/{logId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for logging critical system errors within a tenant.
     * @path /tenants/{tenantId}/systemErrors/{errorId}
     * @allow (get) User belonging to the tenant can read the system errors.
     * @allow (list) User belonging to the tenant can list the system errors.
     * @allow (create) User belonging to the tenant can create the system errors.
     * @allow (update) User belonging to the tenant can update the system errors.
     * @allow (delete) User belonging to the tenant can delete the system errors.
     */
    match /tenants/{tenantId}/systemErrors/{errorId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Stores credentials and status for third-party integrations like Wolt or Foodora.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get) User belonging to the tenant can read integrations.
     * @allow (list) User belonging to the tenant can list integrations.
     * @allow (create) User belonging to the tenant can create integrations.
     * @allow (update) User belonging to the tenant can update integrations.
     * @allow (delete) User belonging to the tenant can delete integrations.
     * @principle Tenant users have full CRUD access to integrations.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for cash register sessions.
     * @path /tenants/{tenantId}/cashRegisters/{registerId}
     * @allow (get) User belonging to the tenant can read cash registers.
     * @allow (list) User belonging to the tenant can list cash registers.
     * @allow (create) User belonging to the tenant can create cash registers.
     * @allow (update) User belonging to the tenant can update cash registers.
     * @allow (delete) User belonging to the tenant can delete cash registers.
     * @principle Tenant users have full CRUD access to cash registers.
     */
    match /tenants/{tenantId}/cashRegisters/{registerId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for generated reports.
     * @path /tenants/{tenantId}/reports/{reportId}
     * @allow (get) User belonging to the tenant can read reports.
     * @allow (list) User belonging to the tenant can list reports.
     * @allow (create) User belonging to the tenant can create reports.
     * @allow (update) User belonging to the tenant can update reports.
     * @allow (delete) User belonging to the tenant can delete reports.
     * @principle Tenant users have full CRUD access to reports.
     */
    match /tenants/{tenantId}/reports/{reportId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Global collection for subscription plans.
     * @path /global/plans/{planId}
     * @allow (get) Any user can read subscription plans.
     * @deny (create) No user can create plans (must be created via backend).
     * @principle Global plans are publicly readable but not writable via client.
     */
    match /global/plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Sub-collection for messages within an AI chat session.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get) User belonging to the tenant can read messages.
     * @allow (list) User belonging to the tenant can list messages.
     * @allow (create) User belonging to the tenant can create messages.
     * @allow (update) User belonging to the tenant can update messages.
     * @allow (delete) User belonging to the tenant can delete messages.
     * @principle Tenant users have full CRUD access to AI chat messages.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for orders from external POS/delivery platforms.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (get) User belonging to the tenant can read POS orders.
     * @allow (list) User belonging to the tenant can list POS orders.
     * @allow (create) User belonging to the tenant can create POS orders.
     * @allow (update) User belonging to the tenant can update POS orders.
     * @allow (delete) User belonging to the tenant can delete POS orders.
     * @principle Tenant users have full CRUD access to POS orders.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for logging incoming webhook API calls.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (get) User belonging to the tenant can read audit logs.
     * @allow (list) User belonging to the tenant can list audit logs.
     * @allow (create) User belonging to the tenant can create audit logs.
     * @allow (update) User belonging to the tenant can update audit logs.
     * @allow (delete) User belonging to the tenant can delete audit logs.
     * @principle Tenant users have full CRUD access to audit logs.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Sub-collection for user and system notifications within a tenant.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (get) User belonging to the tenant can read notifications.
     * @allow (list) User belonging to the tenant can list notifications.
     * @allow (create) User belonging to the tenant can create notifications.
     * @allow (update) User belonging to the tenant can update notifications.
     * @allow (delete) User belonging to the tenant can delete notifications.
     * @principle Tenant users have full CRUD access to notifications.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId);
      allow delete: if isInTenant(tenantId);
    }

    /**
     * @description Collection for triggering email sending via Firebase Extensions (e.g., SendGrid, Mailgun).
     * @path /mail/{mailId}
     * @allow (create) Only authenticated users can queue emails.
     * @deny (get) No client can read email queue.
     * @deny (list) No client can list email queue.
     * @deny (update) Updates not allowed
     * @deny (delete) Deletion not allowed
     * @principle Restrict email creation.
     */
    match /mail/{mailId} {
      allow create: if isSignedIn();
      allow get: if false;
      allow list: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}