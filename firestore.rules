/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a multi-tenant security model where users are associated with tenants.
 *   Each tenant's data (users, transactions, products, settings) is stored in a subcollection under the /tenants/{tenantId} path.
 *   Global subscription plans are stored in the /global/plans/{planId} collection and are publicly readable.
 *   A top-level /users/{userId} collection maps user UIDs to tenant IDs, enabling efficient tenant-based access control.
 *
 * @dataStructure
 *   /users/{userId}: Maps user UIDs to tenant IDs.
 *   /tenants/{tenantId}: Contains tenant information.
 *   /tenants/{tenantId}/users/{userId}: Contains user data within a tenant.
 *   /tenants/{tenantId}/transactions/{transactionId}: Contains transaction data for a tenant.
 *   /tenants/{tenantId}/products/{productId}: Contains product data for a tenant.
 *   /tenants/{tenantId}/settings/{settingId}: Contains tenant-specific settings.
 *   /global/plans/{planId}: Contains global subscription plans.
 *   /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}: Contains AI chat messages within a tenant's AI chat session.
 *
 * @keySecurityDecisions
 *   - Users can only list other users in their own tenant.
 *   - Only authenticated users can access data.
 *   - Users can only create their own user entry in the /users/{userId} collection.
 *   - Global plans are publicly readable but not writable.
 *   - Data validation is relaxed during prototyping, focusing on authorization.
 *
 * @denormalizationForAuthorization
 *   - The tenantId is denormalized into the /users/{userId} document to allow rules to quickly check a user's tenant without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Top-level collection to map user UIDs to tenant IDs.
     * @path /users/{userId}
     * @allow (create) - An authenticated user can create their own entry in this collection.
     * @deny (create) - An unauthenticated user cannot create an entry.
     * @allow (get) - If the authenticated user's ID matches the userId.
     * @allow (list) - Deny listing this collection.
     * @deny (get) - If the authenticated user's ID does not match the userId.
     * @principle Enforces user-ownership.  Users can only create/read their own entry.
     */
    match /users/{userId} {
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow update, delete: if false;
    }

    /**
     * @description Collection to store tenant information.
     * @path /tenants/{tenantId}
     */
    match /tenants/{tenantId} {
        allow read: if false; // Secure by default and require authentication to override
        allow write: if false; // Secure by default and require authentication to override

      /**
       * @description Sub-collection for users within a tenant.
       * @path /tenants/{tenantId}/users/{userId}
       * @allow (list) - An authenticated user can list all users in their tenant
       * @allow (create) - An authenticated user can create other users in their tenant
       * @allow (get) - An authenticated user can get a specific user in their tenant
       * @deny (create) - An unauthenticated user cannot create an entry.
       * @deny (get) - If the authenticated user's ID does not match the userId.
       * @principle Enforces user-ownership.  Users can only create/read their own entry.
       */
      match /tenants/{tenantId}/users/{userId} {
        allow create: if isSignedIn();
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }

      /**
       * @description Sub-collection for transactions within a tenant.
       * @path /tenants/{tenantId}/transactions/{transactionId}
       */
      match /tenants/{tenantId}/transactions/{transactionId} {
        allow create: if isSignedIn();
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }

      /**
       * @description Sub-collection for products within a tenant.
       * @path /tenants/{tenantId}/products/{productId}
       */
      match /tenants/{tenantId}/products/{productId} {
        allow create: if isSignedIn();
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }

       /**
        * @description Sub-collection for settings within a tenant.
        * @path /tenants/{tenantId}/settings/{settingId}
        */
      match /tenants/{tenantId}/settings/{settingId} {
        allow create: if isSignedIn();
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }

        /**
         * @description Sub-collection for messages within an AI chat session.
         * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
         */
        match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
          allow create: if isSignedIn();
          allow get: if isSignedIn();
          allow list: if isSignedIn();
          allow update: if isSignedIn();
          allow delete: if isSignedIn();
        }
    }

    /**
     * @description Global collection for subscription plans.
     * @path /global/plans/{planId}
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}