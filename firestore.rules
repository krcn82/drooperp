rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Maps user UIDs to tenant IDs.  This collection is critical for all other rules.
     * @path /users/{userId}
     * @allow (create) - If the authenticated user's UID matches the document ID.
     * @deny (create) - If the authenticated user's UID does not match the document ID.
     * @allow (get) - If the authenticated user's UID matches the document ID.
     * @deny (get) - If the authenticated user's UID does not match the document ID.
     * @allow (update, delete) - Never.  This collection is immutable after creation.
     * @deny (update, delete) - Always.  This collection is immutable after creation.
     * @allow (list) - Never.  Listing users is not allowed.
     * @deny (list) - Always.  Listing users is not allowed.
     * @principle Enforces document ownership for reads and self-creation.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update, delete: if false;
    }

    /**
     * @description Stores tenant information.
     * @path /tenants/{tenantId}
     * @allow (create) - Never. Tenants can only be created through the admin console or backend processes.
     * @deny (create) - Always. Tenants can only be created through the admin console or backend processes.
     * @allow (get) - If the user is authenticated and a member of the tenant (checks /users/{userId}).
     * @deny (get) - If the user is not authenticated or not a member of the tenant.
     * @allow (update, delete) - Never. Tenants can only be updated/deleted through the admin console or backend processes.
     * @deny (update, delete) - Always. Tenants can only be updated/deleted through the admin console or backend processes.
     * @allow (list) - Never. Listing tenants is not allowed.
     * @deny (list) - Always. Listing tenants is not allowed.
     * @principle Restricts access to tenant data based on user membership.
     */
    match /tenants/{tenantId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow get: if isSignedIn() && isMemberOfTenant(tenantId);
      allow list: if false;
      allow create, update, delete: if false;
    }

    /**
     * @description Sub-collection for users within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (create) - If the user is an admin in the tenant and the new user's `tenantId` matches the path.
     * @deny (create) - If the user is not an admin or the `tenantId` does not match.
     * @allow (get) - If the user is authenticated and a member of the tenant.
     * @deny (get) - If the user is not authenticated or not a member of the tenant.
     * @allow (update) - If the user is an admin in the tenant.
     * @deny (update) - If the user is not an admin.
     * @allow (delete) - If the user is an admin in the tenant.
     * @deny (delete) - If the user is not an admin.
     * @allow (list) - If the user is authenticated and a member of the tenant.
     * @deny (list) - If the user is not authenticated or not a member of the tenant.
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      function isAdminInTenant(tenantId) {
          return isMemberOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(userId)).data.role == 'admin';
      }
      allow get, list: if isSignedIn() && isMemberOfTenant(tenantId);
      allow create: if isAdminInTenant(tenantId) && request.resource.data.tenantId == tenantId;
      allow update: if isAdminInTenant(tenantId); //Enforce immutability of the userId
      allow delete: if isAdminInTenant(tenantId);
    }

    /**
     * @description Sub-collection for transactions within a tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (create) - If the user is authenticated and a member of the tenant.
     * @deny (create) - If the user is not authenticated or not a member of the tenant.
     * @allow (get) - If the user is authenticated and a member of the tenant.
     * @deny (get) - If the user is not authenticated or not a member of the tenant.
     * @allow (update) - If the user is an admin in the tenant and document exists.
     * @deny (update) - If the user is not an admin or document does not exist.
     * @allow (delete) - If the user is an admin in the tenant and document exists.
     * @deny (delete) - If the user is not an admin or document does not exist.
     * @allow (list) - If the user is authenticated and a member of the tenant.
     * @deny (list) - If the user is not authenticated or not a member of the tenant.
     * @principle Enforces tenant-level access control.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      function isAdminInTenant(tenantId) {
          return isMemberOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isSignedIn() && isMemberOfTenant(tenantId);
      allow create: if isSignedIn() && isMemberOfTenant(tenantId);
      allow update: if isAdminInTenant(tenantId) && exists( /databases/$(database)/documents/tenants/$(tenantId)/transactions/$(transactionId));
      allow delete: if isAdminInTenant(tenantId) && exists(/databases/$(database)/documents/tenants/$(tenantId)/transactions/$(transactionId));
    }

    /**
     * @description Sub-collection for products within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (create) - If the user is authenticated and a member of the tenant.
     * @deny (create) - If the user is not authenticated or not a member of the tenant.
     * @allow (get) - If the user is authenticated and a member of the tenant.
     * @deny (get) - If the user is not authenticated or not a member of the tenant.
     * @allow (update) - If the user is an admin in the tenant and document exists.
     * @deny (update) - If the user is not an admin or document does not exist.
     * @allow (delete) - If the user is an admin in the tenant and document exists.
     * @deny (delete) - If the user is not an admin or document does not exist.
     * @allow (list) - If the user is authenticated and a member of the tenant.
     * @deny (list) - If the user is not authenticated or not a member of the tenant.
     * @principle Enforces tenant-level access control.
     */
    match /tenants/{tenantId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      function isAdminInTenant(tenantId) {
          return isMemberOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isSignedIn() && isMemberOfTenant(tenantId);
      allow create: if isSignedIn() && isMemberOfTenant(tenantId);
      allow update: if isAdminInTenant(tenantId) && exists(/databases/$(database)/documents/tenants/$(tenantId)/products/$(productId));
      allow delete: if isAdminInTenant(tenantId) && exists(/databases/$(database)/documents/tenants/$(tenantId)/products/$(productId));
    }

    /**
     * @description Document for general settings within a tenant.
     * @path /tenants/{tenantId}/settings/general
     * @allow (create) - If the user is an admin in the tenant.
     * @deny (create) - If the user is not an admin.
     * @allow (get) - If the user is authenticated and a member of the tenant.
     * @deny (get) - If the user is not authenticated or not a member of the tenant.
     * @allow (update) - If the user is an admin in the tenant and document exists.
     * @deny (update) - If the user is not an admin or document does not exist.
     * @allow (delete) - Never. Settings documents should not be deleted.
     * @deny (delete) - Always. Settings documents should not be deleted.
     * @allow (list) - Never. This is a document, not a collection.
     * @deny (list) - Always. This is a document, not a collection.
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/settings/general {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      function isAdminInTenant(tenantId) {
          return isMemberOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get: if isSignedIn() && isMemberOfTenant(tenantId);
      allow list: if false;
      allow create: if isAdminInTenant(tenantId);
      allow update: if isAdminInTenant(tenantId) && exists(/databases/$(database)/documents/tenants/$(tenantId)/settings/general);
      allow delete: if false;
    }

    /**
     * @description Document for module settings within a tenant.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (create) - If the user is an admin in the tenant.
     * @deny (create) - If the user is not an admin.
     * @allow (get) - If the user is authenticated and a member of the tenant.
     * @deny (get) - If the user is not authenticated or not a member of the tenant.
     * @allow (update) - If the user is an admin in the tenant and document exists.
     * @deny (update) - If the user is not an admin or document does not exist.
     * @allow (delete) - Never. Settings documents should not be deleted.
     * @deny (delete) - Always. Settings documents should not be deleted.
     * @allow (list) - Never. This is a document, not a collection.
     * @deny (list) - Always. This is a document, not a collection.
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/settings/modules {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      function isAdminInTenant(tenantId) {
          return isMemberOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get: if isSignedIn() && isMemberOfTenant(tenantId);
      allow list: if false;
      allow create: if isAdminInTenant(tenantId);
      allow update: if isAdminInTenant(tenantId) && exists(/databases/$(database)/documents/tenants/$(tenantId)/settings/modules);
      allow delete: if false;
    }

       /**
        * @description Document for automation rule settings within a tenant.
        * @path /tenants/{tenantId}/settings/automationRules
        * @allow (create) - If the user is an admin in the tenant.
        * @deny (create) - If the user is not an admin.
        * @allow (get) - If the user is authenticated and a member of the tenant.
        * @deny (get) - If the user is not authenticated or not a member of the tenant.
        * @allow (update) - If the user is an admin in the tenant and document exists.
        * @deny (update) - If the user is not an admin or document does not exist.
        * @allow (delete) - Never. Settings documents should not be deleted.
        * @deny (delete) - Always. Settings documents should not be deleted.
        * @allow (list) - Never. This is a document, not a collection.
        * @deny (list) - Always. This is a document, not a collection.
        * @principle Enforces tenant-level access control and admin-only modifications.
        */
    match /tenants/{tenantId}/settings/automationRules {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      function isAdminInTenant(tenantId) {
          return isMemberOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get: if isSignedIn() && isMemberOfTenant(tenantId);
      allow list: if false;
      allow create: if isAdminInTenant(tenantId);
      allow update: if isAdminInTenant(tenantId) && exists(/databases/$(database)/documents/tenants/$(tenantId)/settings/automationRules);
      allow delete: if false;
    }

    /**
     * @description Document for RKSV key and status within a tenant.
     * @path /tenants/{tenantId}/settings/rksv
     * @allow (create) - If the user is an admin in the tenant.
     * @deny (create) - If the user is not an admin.
     * @allow (get) - If the user is authenticated and a member of the tenant.
     * @deny (get) - If the user is not authenticated or not a member of the tenant.
     * @allow (update) - If the user is an admin in the tenant and document exists.
     * @deny (update) - If the user is not an admin or document does not exist.
     * @allow (delete) - Never. Settings documents should not be deleted.
     * @deny (delete) - Always. Settings documents should not be deleted.
     * @allow (list) - Never. This is a document, not a collection.
     * @deny (list) - Always. This is a document, not a collection.
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/settings/rksv {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      function isAdminInTenant(tenantId) {
          return isMemberOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get: if isSignedIn() && isMemberOfTenant(tenantId);
      allow list: if false;
      allow create: if isAdminInTenant(tenantId);
      allow update: if isAdminInTenant(tenantId) && exists(/databases/$(database)/documents/tenants/$(tenantId)/settings/rksv);
      allow delete: if false;
    }

    /**
     * @description Stores credentials and status for third-party integrations like Wolt or Foodora.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (create) - If the user is an admin in the tenant.
     * @deny (create) - If the user is not an admin.
     * @allow (get) - If the user is authenticated and a member of the tenant.
     * @deny (get) - If the user is not authenticated or not a member of the tenant.
     * @allow (update) - If the user is an admin in the tenant and document exists.
     * @deny (update) - If the user is not an admin or document does not exist.
     * @allow (delete) - If the user is an admin in the tenant and document exists.
     * @deny (delete) - If the user is not an admin or document does not exist.
     * @allow (list) - If the user is authenticated and a member of the tenant.
     * @deny (list) - If the user is not authenticated or not a member of the tenant.
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      function isAdminInTenant(tenantId) {
          return isMemberOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isSignedIn() && isMemberOfTenant(tenantId);
      allow create: if isAdminInTenant(tenantId);
      allow update: if isAdminInTenant(tenantId) && exists(/databases/$(database)/documents/tenants/$(tenantId)/integrations/$(platformId));
      allow delete: if isAdminInTenant(tenantId) && exists(/databases/$(database)/documents/tenants/$(tenantId)/integrations/$(platformId));
    }

    /**
     * @description Global collection for subscription plans.
     * @path /global/plans/{planId}
     * @allow (create) - Never. Plans can only be created through the admin console or backend processes.
     * @deny (create) - Always. Plans can only be created through the admin console or backend processes.
     * @allow (get, list) - Public read access.
     * @allow (update, delete) - Never. Plans can only be updated/deleted through the admin console or backend processes.
     * @deny (update, delete) - Always. Plans can only be updated/deleted through the admin console or backend processes.
     * @principle Provides public read access to subscription plans.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Sub-collection for messages within an AI chat session.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (create) - If the user is authenticated and a member of the tenant.
     * @deny (create) - If the user is not authenticated or not a member of the tenant.
     * @allow (get) - If the user is authenticated and a member of the tenant.
     * @deny (get) - If the user is not authenticated or not a member of the tenant.
     * @allow (update, delete) - Never. Chat messages should not be updated or deleted by clients.
     * @deny (update, delete) - Always. Chat messages should not be updated or deleted by clients.
     * @allow (list) - If the user is authenticated and a member of the tenant.
     * @deny (list) - If the user is not authenticated or not a member of the tenant.
     * @principle Enforces tenant-level access control.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      allow get, list: if isSignedIn() && isMemberOfTenant(tenantId);
      allow create: if isSignedIn() && isMemberOfTenant(tenantId);
      allow update, delete: if false;
    }

    /**
     * @description Sub-collection for orders from external POS/delivery platforms.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (create) - If the user is authenticated and a member of the tenant.
     * @deny (create) - If the user is not authenticated or not a member of the tenant.
     * @allow (get) - If the user is authenticated and a member of the tenant.
     * @deny (get) - If the user is not authenticated or not a member of the tenant.
     * @allow (update) - If the user is an admin in the tenant and the document exists.
     * @deny (update) - If the user is not an admin or the document does not exist.
     * @allow (delete) - If the user is an admin in the tenant and the document exists.
     * @deny (delete) - If the user is not an admin or the document does not exist.
     * @allow (list) - If the user is authenticated and a member of the tenant.
     * @deny (list) - If the user is not authenticated or not a member of the tenant.
     * @principle Enforces tenant-level access control.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
      function isAdminInTenant(tenantId) {
          return isMemberOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isSignedIn() && isMemberOfTenant(tenantId);
      allow create: if isSignedIn() && isMemberOfTenant(tenantId);
      allow update: if isAdminInTenant(tenantId) && exists(/databases/$(database)/documents/tenants/$(tenantId)/posOrders/$(orderId));
      allow delete: if isAdminInTenant(tenantId) && exists(/databases/$(database)/documents/tenants/$(tenantId)/posOrders/$(orderId));
    }

    /**
     * @description Sub-collection for logging incoming webhook API calls.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (create) - Always.  Audit logs are created by the backend.
     * @deny (create) - Never.  Audit logs are created by the backend.
     * @allow (get) - If the user is an admin in the tenant.
     * @deny (get) - If the user is not an admin.
     * @allow (update, delete) - Never. Audit logs should not be updated or deleted.
     * @deny (update, delete) - Always. Audit logs should not be updated or deleted.
     * @allow (list) - If the user is an admin in the tenant.
     * @deny (list) - If the user is not an admin.
     * @principle Restricts access to audit logs based on tenant membership and admin role.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMemberOfTenant(tenantId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      }
       function isAdminInTenant(tenantId) {
          return isMemberOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow create: if true; // created by backend
      allow get, list: if isAdminInTenant(tenantId);
      allow update, delete: if false;
    }

    /**
     * @description Sub-collection for user and system notifications within a tenant.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (create) - Always. Notifications created by backend.
     * @deny (create) - Never.
     * @allow (get) - If the user is authenticated and a member of the tenant.
     * @deny (get) - If the user is not authenticated or not a member of the tenant.
     * @allow (update) - If the user is authenticated and a member of the tenant.
     * @deny (update) - If the user is not authenticated or not a member of the tenant.
     * @allow (delete) - Never. Notifications should not be deleted by clients.
     * @deny (delete) - Always. Notifications should not be deleted by clients.
     * @allow (list) - If the user is authenticated and a member of the tenant.
     * @deny (list) - If the user is not authenticated or not a member of the tenant.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isMemberOfTenant(tenantId) {
            return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow create: if true; // Notifications created by backend

        allow get, list, update: if isSignedIn() && isMemberOfTenant(tenantId);

        allow delete: if false; // Notifications should not be deleted by clients.
    }

    /**
     * @description Collection for triggering email sending via Firebase Extensions (e.g., SendGrid, Mailgun).
     * @path /mail/{mailId}
     * @allow (create) - Always. Used by backend extensions to send mail.
     * @deny (create) - Never.
     * @allow (get, list, update, delete) - Never.  This collection is write-only, used by an extension.
     * @deny (get, list, update, delete) - Always.  This collection is write-only, used by an extension.
     * @principle Restricts all access to the extension.
     */
    match /mail/{mailId} {
      allow create: if true;
      allow get, list, update, delete: if false;
    }
  }
}