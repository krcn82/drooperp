rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants a user create access to their own root document.
     * @path /users/{userId}
     * @allow (create) User with UID "user123" can create /users/user123 with tenantId = "tenant456".
     * @deny (create) User with UID "user123" cannot create /users/user456.
     * @principle Enforces document ownership for creation.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if false;
      allow list: if false;

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to tenant documents.
     * @path /tenants/{tenantId}
     * @allow (get, list) Anyone can read tenant information.
     * @allow (create, update, delete) No one can create, update, or delete tenants in this prototype.
     * @deny (create) Unauthorized users cannot create tenants.
     * @principle Restricts write access to tenant documents.
     */
    match /tenants/{tenantId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Grants access to user documents within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get, list) Anyone within the tenant can read user information.
     * @allow (create, update, delete) Users can only manage their own profiles within a tenant.
     * @deny (create) User with UID "user123" cannot create a user profile in tenant "tenant456" if the profile's tenantId is different.
     * @deny (update) User with UID "user123" cannot update a user profile in tenant "tenant456" if they are not the owner.
     * @principle Enforces tenant-based user ownership for writes.
     */
    match /tenants/{tenantId}/users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data.id == userId;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.tenantId == tenantId && request.resource.data.id == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.tenantId == tenantId;
      allow delete: if isSignedIn() && isExistingOwner(userId) && request.resource.data.tenantId == tenantId;
    }

    /**
     * @description Controls access to transaction documents within a tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get, list) Anyone within the tenant can read transaction information.
     * @allow (create, update, delete) Users can only manage transactions within their tenant.
     * @deny (create) User with UID "user123" cannot create a transaction in tenant "tenant456" if the transaction's tenantId is different.
     * @deny (update) User with UID "user123" cannot update a transaction in tenant "tenant456" if they are not the owner.
     * @principle Enforces tenant-based ownership for writes.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.tenantId == tenantId;
      allow update: if isSignedIn() && request.resource.data.tenantId == tenantId;
      allow delete: if isSignedIn() && request.resource.data.tenantId == tenantId;
    }

    /**
     * @description Controls access to product documents within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) Anyone within the tenant can read product information.
     * @allow (create, update, delete) Users can only manage products within their tenant.
     * @deny (create) User with UID "user123" cannot create a product in tenant "tenant456" if the product's tenantId is different.
     * @deny (update) User with UID "user123" cannot update a product in tenant "tenant456" if they are not the owner.
     * @principle Enforces tenant-based ownership for writes.
     */
    match /tenants/{tenantId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.tenantId == tenantId;
      allow update: if isSignedIn() && request.resource.data.tenantId == tenantId;
      allow delete: if isSignedIn() && request.resource.data.tenantId == tenantId;
    }

    /**
     * @description Controls access to settings documents within a tenant.
     * @path /tenants/{tenantId}/settings/{settingId}
     * @allow (get, list) Anyone within the tenant can read the settings.
     * @allow (create, update, delete) Users can only manage settings within their tenant.
     * @deny (create) User with UID "user123" cannot create settings in tenant "tenant456" if the settings' tenantId is different.
     * @deny (update) User with UID "user123" cannot update settings in tenant "tenant456" if they are not the owner.
     * @principle Enforces tenant-based ownership for writes.
     */
    match /tenants/{tenantId}/settings/{settingId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.tenantId == tenantId;
      allow update: if isSignedIn() && request.resource.data.tenantId == tenantId;
      allow delete: if isSignedIn() && request.resource.data.tenantId == tenantId;
    }

    /**
     * @description Controls access to global plan documents.
     * @path /global/plans/{planId}
     * @allow (get, list) Anyone can read the plans.
     * @allow (create, update, delete) No one can create, update, or delete plans in this prototype.
     * @deny (create) Unauthorized users cannot create plans.
     * @principle Restricts write access to plan documents.
     */
    match /global/plans/{planId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }
  }
}