/**
 * @file Firebase Security Rules for Firestore.
 *
 * @Core Philosophy: This ruleset enforces a multi-tenant security model where users are associated with specific tenants.
 *  Most data is stored within tenant-specific subcollections, ensuring data isolation and access control.
 *  Administrative access within a tenant is controlled via the `role` field in the `/tenants/{tenantId}/users/{userId}` document.
 *
 * @Data Structure:
 * - `/users/{userId}`: Maps user UIDs to their tenant ID for initial tenant association.
 * - `/tenants/{tenantId}`: Stores tenant-level information.
 * - `/tenants/{tenantId}/{collections}`: Contains data specific to a tenant, such as users, products, and orders.
 * - `/global/plans/{planId}`: Stores globally available subscription plans.
 * - `/mail/{mailId}`: Triggers email sending.
 *
 * @Key Security Decisions:
 * - Strict tenant isolation: Users can only access data within their assigned tenant.
 * - User listing is denied to prevent unauthorized enumeration of users.
 * - Global plans are publicly readable, but only modifiable by a privileged process (e.g., Firebase Function with Admin SDK).
 * - The ruleset prioritizes security over complex data validation to enable rapid prototyping.
 *
 * @Denormalization for Authorization:
 * - User role is denormalized into the `/tenants/{tenantId}/users/{userId}` document for efficient access control within the tenant.
 * - Tenant ID is stored in the `/users/{userId}` document to quickly determine the tenant a user belongs to.
 *
 * @Structural Segregation:
 * - Private user data and public tenant data are stored in separate collections to avoid the need for complex filtering based on visibility.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Maps user UIDs to tenant IDs.
     * @path /users/{userId}
     * @allow (create) Authenticated user creates their own mapping document.
     * @deny (get, list, update, delete) No one can read, list, update, or delete user tenant mappings.
     * @principle Enforces user-ownership and prevents unauthorized access to tenant mappings.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get, list: if false;
      allow create: if isOwner(userId) && request.resource.data.tenantId is string;
      allow update, delete: if false;
    }

    /**
     * @description Manages tenant information.
     * @path /tenants/{tenantId}
     * @allow (get, list) Anyone can read tenant information.
     * @deny (create, update, delete) Only a privileged process (e.g., Cloud Function with Admin SDK) can modify tenant information.
     * @principle Restricts tenant modification to backend processes.
     */
    match /tenants/{tenantId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

     /**
     * @description Manages product categories within a tenant.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get, list) Any authenticated user can list categories within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify categories.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
       function isSignedIn() {
            return request.auth != null;
        }

        function isTenantAdmin(tenantId) {
            return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages products within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) Any authenticated user can list products within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify products.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

     /**
     * @description Manages customers within a tenant.
     * @path /tenants/{tenantId}/customers/{customerId}
     * @allow (get, list) Any authenticated user can list customers within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify customers.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/customers/{customerId} {
       function isSignedIn() {
            return request.auth != null;
        }

        function isTenantAdmin(tenantId) {
            return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

     /**
     * @description Manages orders within a tenant.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get, list) Any authenticated user can list orders within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify orders.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/orders/{orderId} {
       function isSignedIn() {
            return request.auth != null;
        }

        function isTenantAdmin(tenantId) {
            return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages tables within a tenant.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get, list) Any authenticated user can list tables within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify tables.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/tables/{tableId} {
       function isSignedIn() {
            return request.auth != null;
        }

        function isTenantAdmin(tenantId) {
            return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages KDS orders within a tenant.
     * @path /tenants/{tenantId}/kdsOrders/{kdsId}
     * @allow (get, list) Any authenticated user can list KDS orders within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify KDS orders.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/kdsOrders/{kdsId} {
       function isSignedIn() {
            return request.auth != null;
        }

        function isTenantAdmin(tenantId) {
            return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages users within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get) Any authenticated user can get their own user document within a tenant.
     * @deny (list) Prevents listing all users in a tenant, which could expose sensitive information.
     * @allow (create, update, delete) Only admin users within the tenant can create, update, or delete users.
     * @principle Enforces tenant-level access control and admin-only modifications for users.
     */
    match /tenants/{tenantId}/users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      function isOwner(tenantId, userId) {
           return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(tenantId, userId) && request.auth.uid == userId;
      allow list: if false;
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages payments within a tenant.
     * @path /tenants/{tenantId}/payments/{paymentId}
     * @allow (get, list) Any authenticated user can list payments within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify payments.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/payments/{paymentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages general settings within a tenant.
     * @path /tenants/{tenantId}/settings/general}
     * @allow (get) Any authenticated user can get general settings within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify general settings.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/settings/general {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      allow get: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
      allow list: if false;
    }

    /**
     * @description Manages module settings within a tenant.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get) Any authenticated user can get module settings within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify module settings.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/settings/modules {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      allow get: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
      allow list: if false;
    }

     /**
     * @description Manages automation rules within a tenant.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow (get) Any authenticated user can get automation rules within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify automation rules.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/settings/automationRules {
       function isSignedIn() {
            return request.auth != null;
        }

        function isTenantAdmin(tenantId) {
            return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        allow get: if isSignedIn();
        allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
        allow list: if false;
    }

    /**
     * @description Manages RKSV configuration within a tenant.
     * @path /tenants/{tenantId}/rksvConfig
     * @allow (get) Any authenticated user can get RKSV config within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify RKSV config.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/rksvConfig {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      allow get: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
      allow list: if false;
    }

    /**
     * @description Manages RKSV signatures within a tenant.
     * @path /tenants/{tenantId}/signatures/{signatureId}
     * @allow (get, list) Any authenticated user can list RKSV signatures within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify RKSV signatures.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/signatures/{signatureId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages Z-Reports within a tenant.
     * @path /tenants/{tenantId}/zReports/{reportId}
     * @allow (get, list) Any authenticated user can list zReports within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify zReports.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/zReports/{reportId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages integrations within a tenant.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get, list) Any authenticated user can list integrations within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify integrations.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages cash registers within a tenant.
     * @path /tenants/{tenantId}/cashRegisters/{registerId}
     * @allow (get, list) Any authenticated user can list cash registers within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify cash registers.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/cashRegisters/{registerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages reports within a tenant.
     * @path /tenants/{tenantId}/reports/{reportId}
     * @allow (get, list) Any authenticated user can list reports within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify reports.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/reports/{reportId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages FinanzOnline logs within a tenant.
     * @path /tenants/{tenantId}/finanzOnlineLogs/{logId}
     * @allow (get, list) Any authenticated user can list FinanzOnline logs within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify FinanzOnline logs.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/finanzOnlineLogs/{logId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isTenantAdmin(tenantId) {
            return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages system errors within a tenant.
     * @path /tenants/{tenantId}/systemErrors/{errorId}
     * @allow (get, list) Any authenticated user can list system errors within a tenant.
     * @allow (create, update, delete) Only admin users within the tenant can modify system errors.
     * @deny Request without authentication
     * @principle Enforces tenant-level access control and admin-only modifications.
     */
    match /tenants/{tenantId}/systemErrors/{errorId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isTenantAdmin(tenantId) {
            return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages global subscription plans.
     * @path /global/plans/{planId}
     * @allow (get, list) Anyone can read global plans.
     * @deny (create, update, delete) Only a privileged process (e.g., Cloud Function with Admin SDK) can modify plans.
     * @principle Restricts plan modification to backend processes.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages chat messages within an AI chat session.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, list) Any authenticated user can list messages within a chat session they have access to.
     * @allow (create) Any authenticated user can create messages within a chat session they have access to.
     * @deny (update, delete) No user can update or delete chat messages (append-only).
     * @principle Restricts access to chat messages based on chat session membership and enforces append-only behavior.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
        function isSignedIn() {
            return request.auth != null;
        }

        //CRITICAL TODO - For now, let any signed in user in the tenant read, create messages.
        //This needs to be secured based on a membership or other form of access control.
        allow get, list, create: if isSignedIn();
        allow update, delete: if false;
    }

    /**
     * @description Manages POS orders from external platforms.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (create) Allow creation from external platforms. Authentication should be handled before this.
     * @allow (get, list) Only admin users within the tenant can list posOrders.
     * @deny (update, delete) No user can update or delete posOrders.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isTenantAdmin(tenantId) {
            return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        allow create: if true; // Authentication should be handled before the rules are applied.
        allow get, list: if isSignedIn() && isTenantAdmin(tenantId);
        allow update, delete: if false;
    }

    /**
     * @description Manages audit logs for incoming webhooks.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (create) Allow creation from external platforms. Authentication should be handled before this.
     * @allow (get, list) Only admin users within the tenant can list auditLogs.
     * @deny (update, delete) No user can update or delete auditLogs.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isTenantAdmin(tenantId) {
            return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        allow create: if true; // Authentication should be handled before the rules are applied.
        allow get, list: if isSignedIn() && isTenantAdmin(tenantId);
        allow update, delete: if false;
    }

    /**
     * @description Manages notifications within a tenant.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (get) Any authenticated user can get their own notification within a tenant.
     * @deny (list) Prevents listing all notifications in a tenant, which could expose sensitive information.
     * @allow (create, update, delete) Only admin users within the tenant can create, update, or delete notifications.
     * @principle Enforces tenant-level access control and admin-only modifications for notifications.
     */
     match /tenants/{tenantId}/notifications/{notificationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTenantAdmin(tenantId) {
        return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

       function isOwner(tenantId, notificationId) {
           return request.auth.uid == notificationId;
       }

      allow get: if isSignedIn() && isOwner(tenantId, notificationId) && request.auth.uid == notificationId; // For Prototyping, admins can read all notifications. TODO: Fine tune
      allow list: if false;
      allow create, update, delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages emails to be sent via extension.
     * @path /mail/{mailId}
     * @deny (get, list, create, update, delete) No user can directly access this collection. Triggered by backend.
     * @principle Restricts email sending to backend processes.
     */
    match /mail/{mailId} {
      allow get, list, create, update, delete: if false;
    }
  }
}