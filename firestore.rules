/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant security model, with strict separation of data between tenants.
 * Users can only access data within their assigned tenant. User data is further segregated within a tenant.
 * All authorization decisions are based on the authenticated user's UID and tenant ID.
 *
 * Data Structure:
 * - /users/{userId}: Maps user UIDs to tenant IDs. This is the entry point for authorization.
 * - /tenants/{tenantId}: Stores tenant-specific information.
 * - /tenants/{tenantId}/users/{userId}: Stores user data within a tenant.
 * - /tenants/{tenantId}/...: Other tenant-specific data, such as products, transactions, and settings.
 * - /global/plans/{planId}: Stores global subscription plans.
 * - /mail/{mailId}: Stores mail objects to be processed by a firebase extension.
 *
 * Key Security Decisions:
 * - Users can only list other users within their tenant if they are admins.
 * - Global plans are publicly readable.
 * - The /mail collection is write-only and designed for Firebase Extensions to process.
 *
 * Denormalization for Authorization:
 * - The User document within a tenant includes a `role` field. This allows for role-based access control within the tenant.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Maps user UIDs to tenant IDs for security rules.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their UserTenant document with matching UID.
     * @deny (create) - Authenticated user attempts to create a UserTenant document with a mismatched UID.
     * @allow (get) - Any authenticated user can get their own UserTenant document.
     * @deny (get) - Any authenticated user attempts to get another user's UserTenant document.
     * @principle Enforces document ownership for user-to-tenant mapping.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores tenant-specific information.
     * @path /tenants/{tenantId}
     * @allow (get, list) - Public read access to tenant information.
     * @allow (create, update, delete) - No direct client-side write access.  Tenants are likely created and managed via a backend process.
     * @principle Requires administrative privileges to manage tenants.
     */
    match /tenants/{tenantId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;

      /**
       * @description Sub-collection for users within a tenant.
       * @path /tenants/{tenantId}/users/{userId}
       * @allow (create) - Authenticated user creates their own user document within the tenant.
       * @deny (create) - Authenticated user attempts to create a user document with a mismatched UID.
       * @allow (get) - Any authenticated user within the tenant can get their own user document.
       * @deny (get) - Any authenticated user attempts to get another user's document.
       * @allow (list) - Only admins can list users in the tenant.
       * @principle Enforces document ownership and role-based access control within a tenant.
       */
      match /users/{userId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        function isTenantAdmin(tenantId) {
          return isSignedIn()
              && isTenantUser(tenantId)
              && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        function isExistingOwner(tenantId, userId) {
          return isOwner(userId) && resource != null && isTenantUser(tenantId);
        }

        function isOwner(userId) {
          return request.auth != null && request.auth.uid == userId;
        }
        allow get: if isSignedIn() && isOwner(userId) && isTenantUser(tenantId);
        allow list: if isTenantAdmin(tenantId);
        allow create: if isSignedIn() && isOwner(userId) && isTenantUser(tenantId);
        allow update: if isExistingOwner(tenantId, userId);
        allow delete: if isExistingOwner(tenantId, userId);
      }

      /**
       * @description Sub-collection for transactions within a tenant.
       * @path /tenants/{tenantId}/transactions/{transactionId}
       * @allow (get, list) - Any authenticated user within the tenant can read transactions.
       * @allow (create, update, delete) - Write access is restricted. Transactions are likely created and managed via a backend process or specific user roles.
       * @principle Requires tenant membership for read access; restricts write access.
       */
      match /transactions/{transactionId} {

        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get, list: if isSignedIn() && isTenantUser(tenantId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Sub-collection for products within a tenant.
       * @path /tenants/{tenantId}/products/{productId}
       * @allow (get, list) - Any authenticated user within the tenant can read products.
       * @allow (create, update, delete) - Write access is restricted. Products are likely created and managed via a backend process or specific user roles.
       * @principle Requires tenant membership for read access; restricts write access.
       */
      match /products/{productId} {

        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get, list: if isSignedIn() && isTenantUser(tenantId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Document for general settings within a tenant.
       * @path /tenants/{tenantId}/settings/general
       * @allow (get) - Any authenticated user within the tenant can read general settings.
       * @allow (create, update, delete) - Write access is restricted. Settings are likely managed via a backend process or specific user roles.
       * @principle Requires tenant membership for read access; restricts write access.
       */
      match /settings/general {

        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isSignedIn() && isTenantUser(tenantId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Document for module settings within a tenant.
       * @path /tenants/{tenantId}/settings/modules
       * @allow (get) - Any authenticated user within the tenant can read module settings.
       * @allow (create, update, delete) - Write access is restricted. Settings are likely managed via a backend process or specific user roles.
       * @principle Requires tenant membership for read access; restricts write access.
       */
      match /settings/modules {

        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isSignedIn() && isTenantUser(tenantId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Document for automation rule settings within a tenant.
       * @path /tenants/{tenantId}/settings/automationRules
       * @allow (get) - Any authenticated user within the tenant can read automation rules settings.
       * @allow (create, update, delete) - Write access is restricted. Settings are likely managed via a backend process or specific user roles.
       * @principle Requires tenant membership for read access; restricts write access.
       */
      match /settings/automationRules {

        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isSignedIn() && isTenantUser(tenantId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Document for RKSV key and status within a tenant.
       * @path /tenants/{tenantId}/settings/rksv
       * @allow (get) - Any authenticated user within the tenant can read RKSV settings.
       * @allow (create, update, delete) - Write access is restricted. Settings are likely managed via a backend process.
       * @principle Requires tenant membership for read access; restricts write access.
       */
      match /settings/rksv {

        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get: if isSignedIn() && isTenantUser(tenantId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Stores credentials and status for third-party integrations like Wolt or Foodora.
       * @path /tenants/{tenantId}/integrations/{platformId}
       * @allow (get, list) - Any authenticated user within the tenant can read integration settings.
       * @allow (create, update, delete) - Write access is restricted. Integrations are likely managed via a backend process.
       * @principle Requires tenant membership for read access; restricts write access.
       */
      match /integrations/{platformId} {

        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get, list: if isSignedIn() && isTenantUser(tenantId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Sub-collection for messages within an AI chat session.
       * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
       * @allow (get, list) - Any authenticated user within the tenant can read chat messages.
       * @allow (create, update, delete) - Write access is restricted. Chat messages are likely managed via a backend process or specific user roles.
       * @principle Requires tenant membership for read access; restricts write access.
       */
      match /aiChats/{chatId}/messages/{messageId} {

        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get, list: if isSignedIn() && isTenantUser(tenantId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Sub-collection for orders from external POS/delivery platforms.
       * @path /tenants/{tenantId}/posOrders/{orderId}
       * @allow (get, list) - Any authenticated user within the tenant can read POS orders.
       * @allow (create, update, delete) - Write access is restricted. POS orders are likely created and managed via a backend process.
       * @principle Requires tenant membership for read access; restricts write access.
       */
      match /posOrders/{orderId} {

        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get, list: if isSignedIn() && isTenantUser(tenantId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Sub-collection for logging incoming webhook API calls.
       * @path /tenants/{tenantId}/auditLogs/{logId}
       * @allow (get, list) - Any authenticated user within the tenant can read audit logs.
       * @allow (create, update, delete) - Write access is restricted. Audit logs are likely created and managed via a backend process.
       * @principle Requires tenant membership for read access; restricts write access.
       */
      match /auditLogs/{logId} {

        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get, list: if isSignedIn() && isTenantUser(tenantId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Sub-collection for user and system notifications within a tenant.
       * @path /tenants/{tenantId}/notifications/{notificationId}
       * @allow (get, list) - Any authenticated user within the tenant can read notifications.
       * @allow (create, update, delete) - Write access is restricted. Notifications are likely created and managed via a backend process.
       * @principle Requires tenant membership for read access; restricts write access.
       */
      match /notifications/{notificationId} {

        function isSignedIn() {
          return request.auth != null;
        }

        function isTenantUser(tenantId) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        }

        allow get, list: if isSignedIn() && isTenantUser(tenantId);
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }
    }

    /**
     * @description Global collection for subscription plans.
     * @path /global/plans/{planId}
     * @allow (get, list) - Public read access to subscription plans.
     * @allow (create, update, delete) - No direct client-side write access. Plans are likely created and managed via a backend process.
     * @principle Requires administrative privileges to manage plans.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Collection for triggering email sending via Firebase Extensions (e.g., SendGrid, Mailgun).
     * @path /mail/{mailId}
     * @allow (create) - Allows creating mail objects; designed for Firebase Extensions to process.
     * @allow (get, list, update, delete) - No direct client-side access for reading, updating, or deleting mail objects.
     * @principle Requires administrative privileges to manage mail objects; extensions are responsible for handling them.
     */
    match /mail/{mailId} {
      allow get, list, update, delete: if false;
      allow create: if true;
    }
  }
}