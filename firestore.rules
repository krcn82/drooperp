rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner, ensuring the document exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId));
    }

    /**
     * @description Checks if the authenticated user is an administrator for the given tenant.
     */
    function isAdmin(tenantId) {
      return isSignedIn() && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Top-level collection to map user UIDs to tenant IDs for security rules.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create document /users/user123
     * @deny (create) User with UID 'user123' cannot create document /users/user456
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Collection to store tenant information.
     * @path /tenants/{tenantId}
     * @allow (get, list) Public read access to tenant information.
     * @deny (create, update, delete) Only server-side code can create, update, or delete tenants.
     * @principle Public read with server-only writes.
     */
    match /tenants/{tenantId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Sub-collection for product categories within a tenant.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get, list) Any signed-in user can read categories within their tenant.
     * @allow (create, update, delete) Only admins can manage categories.
     * @deny (create, update, delete) Non-admins cannot manage categories.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for products within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) Any signed-in user can read products within their tenant.
     * @allow (create, update, delete) Only admins can manage products.
     * @deny (create, update, delete) Non-admins cannot manage products.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/products/{productId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for customers within a tenant.
     * @path /tenants/{tenantId}/customers/{customerId}
     * @allow (get, list) Any signed-in user can read customers within their tenant.
     * @allow (create, update, delete) Only admins can manage customers.
     * @deny (create, update, delete) Non-admins cannot manage customers.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/customers/{customerId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for POS orders within a tenant.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get, list) Any signed-in user can read orders within their tenant.
     * @allow (create, update, delete) Only admins can manage orders.
     * @deny (create, update, delete) Non-admins cannot manage orders.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for restaurant tables within a tenant.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get, list) Any signed-in user can read tables within their tenant.
     * @allow (create, update, delete) Only admins can manage tables.
     * @deny (create, update, delete) Non-admins cannot manage tables.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for Kitchen Display System orders within a tenant.
     * @path /tenants/{tenantId}/kdsOrders/{kdsId}
     * @allow (get, list) Any signed-in user can read KDS orders within their tenant.
     * @allow (create, update, delete) Only admins can manage KDS orders.
     * @deny (create, update, delete) Non-admins cannot manage KDS orders.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/kdsOrders/{kdsId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for users within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get) Any signed-in user can read other users within their tenant.
     * @allow (list) Only admins can list users within a tenant.
     * @allow (create) Only admins can create users.
     * @allow (update) Only admins can update users.
     * @allow (delete) Only admins can delete users.
     * @deny (create, update, delete) Non-admins cannot manage users.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/users/{userId} {
      allow get: if isSignedIn();
      allow list: if isAdmin(tenantId);
      allow create: if isAdmin(tenantId);
      allow update: if isAdmin(tenantId);
      allow delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for payments within a tenant.
     * @path /tenants/{tenantId}/payments/{paymentId}
     * @allow (get, list) Any signed-in user can read payments within their tenant.
     * @allow (create, update, delete) Only admins can manage payments.
     * @deny (create, update, delete) Non-admins cannot manage payments.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/payments/{paymentId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Document for general settings within a tenant.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get) Any signed-in user can read general settings within their tenant.
     * @allow (create, update, delete) Only admins can manage general settings.
     * @deny (create, update, delete) Non-admins cannot manage general settings.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/settings/general {
      allow get: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Document for module settings within a tenant.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get) Any signed-in user can read module settings within their tenant.
     * @allow (create, update, delete) Only admins can manage module settings.
     * @deny (create, update, delete) Non-admins cannot manage module settings.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/settings/modules {
      allow get: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Document for automation rule settings within a tenant.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow (get) Any signed-in user can read automation rules settings within their tenant.
     * @allow (create, update, delete) Only admins can manage automation rules settings.
     * @deny (create, update, delete) Non-admins cannot manage automation rules settings.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/settings/automationRules {
      allow get: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Singleton document for RKSV fiscal certificate and configuration for a tenant.
     * @path /tenants/{tenantId}/rksvConfig
     * @allow (get) Any signed-in user can read the RKSV config within their tenant.
     * @allow (create, update, delete) Only admins can manage the RKSV config.
     * @deny (create, update, delete) Non-admins cannot manage the RKSV config.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/rksvConfig {
      allow get: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for the RKSV cryptographic signature chain.
     * @path /tenants/{tenantId}/signatures/{signatureId}
     * @allow (get, list) Any signed-in user can read signatures within their tenant.
     * @allow (create, update, delete) Only admins can manage signatures.
     * @deny (create, update, delete) Non-admins cannot manage signatures.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/signatures/{signatureId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for daily Z-Reports (Tagesabschluss).
     * @path /tenants/{tenantId}/zReports/{reportId}
     * @allow (get, list) Any signed-in user can read zReports within their tenant.
     * @allow (create, update, delete) Only admins can manage zReports.
     * @deny (create, update, delete) Non-admins cannot manage zReports.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/zReports/{reportId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for logging FinanzOnline API submissions.
     * @path /tenants/{tenantId}/finanzOnlineLogs/{logId}
     * @allow get, list: if isSignedIn();
     * @allow create, update, delete: if isAdmin(tenantId);
     */
    match /tenants/{tenantId}/finanzOnlineLogs/{logId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for logging critical system errors within a tenant.
     * @path /tenants/{tenantId}/systemErrors/{errorId}
     * @allow get, list: if isSignedIn();
     * @allow create, update, delete: if isAdmin(tenantId);
     */
    match /tenants/{tenantId}/systemErrors/{errorId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for credentials and status for third-party integrations.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get, list) Any signed-in user can read integrations within their tenant.
     * @allow (create, update, delete) Only admins can manage integrations.
     * @deny (create, update, delete) Non-admins cannot manage integrations.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for cash register sessions.
     * @path /tenants/{tenantId}/cashRegisters/{registerId}
     * @allow (get, list) Any signed-in user can read cashRegisters within their tenant.
     * @allow (create, update, delete) Only admins can manage cashRegisters.
     * @deny (create, update, delete) Non-admins cannot manage cashRegisters.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/cashRegisters/{registerId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for generated reports.
     * @path /tenants/{tenantId}/reports/{reportId}
     * @allow (get, list) Any signed-in user can read reports within their tenant.
     * @allow (create, update, delete) Only admins can manage reports.
     * @deny (create, update, delete) Non-admins cannot manage reports.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/reports/{reportId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Global collection for subscription plans.
     * @path /global/plans/{planId}
     * @allow (get, list) Public read access to subscription plans.
     * @deny (create, update, delete) Only server-side code can create, update, or delete plans.
     * @principle Public read with server-only writes.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Sub-collection for messages within an AI chat session.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, list) Any signed-in user can read AI chat messages within their tenant.
     * @allow (create, update, delete) Only admins can manage AI chat messages.
     * @deny (create, update, delete) Non-admins cannot manage AI chat messages.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for orders from external POS/delivery platforms.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (get, list) Any signed-in user can read POS orders within their tenant.
     * @allow (create, update, delete) Only admins can manage POS orders.
     * @deny (create, update, delete) Non-admins cannot manage POS orders.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

     /**
      * @description Sub-collection for logging incoming webhook API calls.
      * @path /tenants/{tenantId}/auditLogs/{logId}
      */
     match /tenants/{tenantId}/auditLogs/{logId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Sub-collection for user and system notifications within a tenant.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (get, list) Any signed-in user can read notifications within their tenant.
     * @allow (create, update, delete) Only admins can manage notifications.
     * @deny (create, update, delete) Non-admins cannot manage notifications.
     * @principle Tenant-based authorization with admin roles.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin(tenantId);
    }

    /**
     * @description Collection for triggering email sending via Firebase Extensions. Write-only.
     * @path /mail/{mailId}
     * @allow (create) Any signed-in user can trigger an email.
     * @deny (get, list, update, delete) No read, update, or delete access allowed.
     * @principle Write-only for triggering extensions.
     */
    match /mail/{mailId} {
      allow create: if isSignedIn();
      allow get: if false;
      allow list: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Access control for tenant-specific transactions.
     * @path /tenants/{tenantId}/transactions
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
        allow get: if isSignedIn();
        allow list: if isAdmin(tenantId);
        allow create, update, delete: if isAdmin(tenantId);
    }
  }
}