/**
 * @file Overview
 * This ruleset enforces a multi-tenant security model with user-based access control.
 *
 * Data Structure:
 * - /users/{userId}: Maps user IDs to tenant IDs.  Used for initial authorization.
 * - /tenants/{tenantId}: Stores tenant-level information.
 * - /tenants/{tenantId}/*: Subcollections containing tenant-specific data.
 * - /global/plans/{planId}: Stores global subscription plans. Publicly readable.
 * - /mail/{mailId}: Collection for triggering emails; restricted write access.
 *
 * Key Security Decisions:
 * - Tenants are isolated from each other; users can only access data within their assigned tenant.
 * - The /users/{userId} collection provides the tenantId link for a given user.
 * - The /global/plans collection is publicly readable.
 * - Listing of the /users/{userId} collection is disallowed for security.
 *
 * Denormalization for Authorization:
 *  - The tenantId is denormalized onto most documents to simplify authorization rules. This avoids costly `get()` operations to look up tenant membership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Restricts access to the top-level /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) A user can create their own document to link their UID to a tenantId.
     * @deny (get, list, update, delete) No one can read, list, update, or delete user-tenant mappings.
     * @principle Enforces user-ownership for initial tenant assignment; prevents unauthorized access to tenant mappings.
     */
    match /users/{userId} {
      allow get, list: if false;
      allow create: if request.auth.uid == userId;
      allow update, delete: if false;
    }

    /**
     * @description Allows access to tenant documents.
     * @path /tenants/{tenantId}
     * @allow (get, list) Not protected in prototyping mode
     * @allow (create, update, delete) Not protected in prototyping mode
     * @principle Allows access to tenant documents.
     */
    match /tenants/{tenantId} {
        allow get, list: if true;
        allow create, update, delete: if false; // TODO: Restrict based on admin role
    }

    /**
     * @description Manages user access within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get, list) Allow a tenant admin to get and list users within their tenant.
     * @allow (create) Allow a tenant admin to create users within their tenant.
     * @allow (update, delete) Allow a tenant admin to update or delete users within their tenant.
     * @principle Enforces tenant-based user management; restricts user access to their own tenant.
     */
    match /tenants/{tenantId}/users/{userId} {
        function isTenantAdmin(tenantId) {
            return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        allow get, list: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Manages transactions within a tenant.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get, list) Allow a tenant admin to get and list transactions within their tenant.
     * @allow (create) Allow a tenant admin to create transactions within their tenant.
     * @allow (update, delete) Allow a tenant admin to update or delete transactions within their tenant.
     * @principle Enforces tenant-based transaction management; restricts access to transactions within a tenant.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
        function isTenantAdmin(tenantId) {
            return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        allow get, list: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Manages products within a tenant.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) Allow a tenant admin to get and list products within their tenant.
     * @allow (create) Allow a tenant admin to create products within their tenant.
     * @allow (update, delete) Allow a tenant admin to update or delete products within their tenant.
     * @principle Enforces tenant-based product management; restricts access to products within a tenant.
     */
    match /tenants/{tenantId}/products/{productId} {
        function isTenantAdmin(tenantId) {
            return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        allow get, list: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Manages general settings within a tenant.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get) Allow a tenant admin to get general settings within their tenant.
     * @allow (create) Allow a tenant admin to create general settings within their tenant.
     * @allow (update, delete) Allow a tenant admin to update or delete general settings within their tenant.
     * @principle Enforces tenant-based settings management; restricts access to settings within a tenant.
     */
    match /tenants/{tenantId}/settings/general {
        function isTenantAdmin(tenantId) {
            return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        allow get: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
        allow list: if false;
    }

    /**
     * @description Manages module settings within a tenant.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get) Allow a tenant admin to get module settings within their tenant.
     * @allow (create) Allow a tenant admin to create module settings within their tenant.
     * @allow (update, delete) Allow a tenant admin to update or delete module settings within their tenant.
     * @principle Enforces tenant-based settings management; restricts access to settings within a tenant.
     */
    match /tenants/{tenantId}/settings/modules {
        function isTenantAdmin(tenantId) {
            return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        allow get: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
        allow list: if false;
    }

    /**
     * @description Manages automation rule settings within a tenant.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow (get) Allow a tenant admin to get automation rule settings within their tenant.
     * @allow (create) Allow a tenant admin to create automation rule settings within their tenant.
     * @allow (update, delete) Allow a tenant admin to update or delete automation rule settings within their tenant.
     * @principle Enforces tenant-based settings management; restricts access to settings within a tenant.
     */
    match /tenants/{tenantId}/settings/automationRules {
        function isTenantAdmin(tenantId) {
            return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        allow get: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
        allow list: if false;
    }

    /**
     * @description Manages RKSV settings within a tenant.
     * @path /tenants/{tenantId}/settings/rksv
     * @allow (get) Allow a tenant admin to get RKSV settings within their tenant.
     * @allow (create) Allow a tenant admin to create RKSV settings within their tenant.
     * @allow (update, delete) Allow a tenant admin to update or delete RKSV settings within their tenant.
     * @principle Enforces tenant-based settings management; restricts access to settings within a tenant.
     */
    match /tenants/{tenantId}/settings/rksv {
        function isTenantAdmin(tenantId) {
            return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        allow get: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
        allow list: if false;
    }

    /**
     * @description Manages integrations within a tenant.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get, list) Allow a tenant admin to get and list integrations within their tenant.
     * @allow (create) Allow a tenant admin to create integrations within their tenant.
     * @allow (update, delete) Allow a tenant admin to update or delete integrations within their tenant.
     * @principle Enforces tenant-based integration management; restricts access to integrations within a tenant.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
        function isTenantAdmin(tenantId) {
            return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        allow get, list: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Allows public read access to subscription plans.
     * @path /global/plans/{planId}
     * @allow (get, list) Allow anyone to read subscription plans.
     * @deny (create, update, delete) No one can create, update, or delete subscription plans.
     * @principle Allows public access to subscription plan information.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Restrict based on a super-admin role.
    }

    /**
     * @description Manages chat messages within a tenant.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, list) Allow a tenant admin to get and list chat messages within their tenant.
     * @allow (create) Allow a tenant admin to create chat messages within their tenant.
     * @allow (update, delete) Allow a tenant admin to update or delete chat messages within their tenant.
     * @principle Enforces tenant-based chat management; restricts access to chat messages within a tenant.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
        function isTenantAdmin(tenantId) {
            return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        allow get, list: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
    }

     /**
      * @description Manages point of sale orders within a tenant.
      * @path /tenants/{tenantId}/posOrders/{orderId}
      * @allow (get, list) Allow a tenant admin to get and list POS orders within their tenant.
      * @allow (create) Allow a tenant admin to create POS orders within their tenant.
      * @allow (update, delete) Allow a tenant admin to update or delete POS orders within their tenant.
      * @principle Enforces tenant-based POS order management; restricts access to POS orders within a tenant.
      */
    match /tenants/{tenantId}/posOrders/{orderId} {
        function isTenantAdmin(tenantId) {
            return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        allow get, list: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
    }
    
    /**
     * @description Manages audit logs within a tenant.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (get, list) Allow a tenant admin to get and list audit logs within their tenant.
     * @allow (create) Allow a tenant admin to create audit logs within their tenant.
     * @allow (update, delete) Allow a tenant admin to update or delete audit logs within their tenant.
     * @principle Enforces tenant-based audit log management; restricts access to audit logs within a tenant.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
        function isTenantAdmin(tenantId) {
            return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        allow get, list: if isTenantAdmin(tenantId);
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Manages notifications within a tenant.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (get, list) Allow a tenant admin to get and list notifications within their tenant.
     * @allow (create) Allow a tenant admin to create notifications within their tenant.
     * @allow (update, delete) Allow a tenant admin to update or delete notifications within their tenant.
     * @principle Enforces tenant-based notification management; restricts access to notifications within a tenant.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Manages email requests.
     * @path /mail/{mailId}
     * @deny (get, list) Disallow getting or listing email requests.
     * @allow (create) Only allow service accounts to create mail requests
     * @deny (update, delete) No one can update or delete email requests.
     */
    match /mail/{mailId} {
      allow get, list: if false;
      allow create: if request.auth.token.email == "eseegastro@gmail.com";  //TODO switch to is service account once available https://firebase.google.com/docs/rules/rules-and-auth#use_custom_claims
      allow update, delete: if false;
    }
  }
}