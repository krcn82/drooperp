/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model with user-based access control.
 * Most data is namespaced under a specific tenant, and access is granted to users
 * who belong to that tenant based on their assigned role. Global data (e.g., plans)
 * is publicly readable but writable only by backend services (simulated via `false` rules).
 *
 * Data Structure:
 * - /users/{userId}: Maps user UIDs to tenant IDs.
 * - /tenants/{tenantId}: Stores tenant information.
 * - /tenants/{tenantId}/users/{userId}: Stores user information within a tenant.
 * - /tenants/{tenantId}/transactions/{transactionId}: Stores transaction data for a tenant.
 * - /tenants/{tenantId}/products/{productId}: Stores product data for a tenant.
 * - /tenants/{tenantId}/settings/...: Stores various settings for a tenant.
 * - /global/plans/{planId}: Stores global subscription plans.
 * - /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}: Stores AI chat messages.
 * - /tenants/{tenantId}/posOrders/{orderId}: Stores orders from POS/delivery platforms.
 * - /tenants/{tenantId}/auditLogs/{logId}: Stores audit logs for incoming webhooks.
 * - /tenants/{tenantId}/notifications/{notificationId}: Stores notifications for users.
 * - /mail/{mailId}: Stores email requests for processing by extensions.
 *
 * Key Security Decisions:
 * - Users can only read and write data within their assigned tenant.
 * - Tenant-level access control is based on the user's role (admin, cashier, viewer).
 * - Global plans are publicly readable.
 * - Listing of users within a tenant is allowed for admins.
 * - The /mail collection is write-only and designed to be triggered by backend services through extensions.
 * - All write operations are validated to ensure the document exists before proceeding.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to create their UserTenant document, mapping their UID to their tenant ID. Read access is forbidden.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create a document mapping their ID to a tenant.
     * @deny (get, list, update, delete) No one can read or modify this collection directly.
     * @principle Self-Creation: Users can create their own UserTenant document.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get, list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update, delete: if false;
    }

    /**
     * @description Allows read access to tenant information, but only tenant admins can modify it.
     * @path /tenants/{tenantId}
     * @allow (get, list) Any logged-in user can read tenant information.
     * @deny (create, update, delete) Only tenant admins can modify tenant information.
     * @principle Tenant-Level Access Control: Restricts tenant modification to admins.
     */
    match /tenants/{tenantId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows tenant admins to manage users within their tenant. Other roles have restricted access.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get, list) Any authenticated user can read tenant user information.
     * @allow (create) Only tenant admins can create users.
     * @allow (update, delete) Only tenant admins can update or delete users.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete users.
     * @principle Tenant-Level Access Control: Restricts user management within a tenant to admins.
     */
    match /tenants/{tenantId}/users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isSignedIn();
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if isTenantAdmin(tenantId) && resource != null;
    }

    /**
     * @description Allows tenant users to read transactions. Only admins can create, update, or delete them.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get, list) Any authenticated user can read transactions within a tenant.
     * @allow (create) Only tenant admins can create transactions.
     * @allow (update, delete) Only tenant admins can update or delete transactions.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete transactions.
     * @principle Tenant-Level Access Control: Restricts transaction management within a tenant to admins.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isSignedIn();
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if isTenantAdmin(tenantId) && resource != null;
    }

    /**
     * @description Allows tenant users to read products. Only admins can create, update, or delete them.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) Any authenticated user can read products within a tenant.
     * @allow (create) Only tenant admins can create products.
     * @allow (update, delete) Only tenant admins can update or delete products.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete products.
     * @principle Tenant-Level Access Control: Restricts product management within a tenant to admins.
     */
    match /tenants/{tenantId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isSignedIn();
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if isTenantAdmin(tenantId) && resource != null;
    }

    /**
     * @description Allows tenant users to read general settings. Only admins can update them.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get) Any authenticated user can read general settings within a tenant.
     * @allow (update) Only tenant admins can update general settings.
     * @deny (create, delete) No one can create or delete general settings.
     * @principle Tenant-Level Access Control: Restricts settings modification to admins.
     */
    match /tenants/{tenantId}/settings/general {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get: if isSignedIn();
      allow create: if false;
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if false;
      allow list: if false;
    }

    /**
     * @description Allows tenant users to read module settings. Only admins can update them.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get) Any authenticated user can read module settings within a tenant.
     * @allow (update) Only tenant admins can update module settings.
     * @deny (create, delete) No one can create or delete module settings.
     * @principle Tenant-Level Access Control: Restricts settings modification to admins.
     */
    match /tenants/{tenantId}/settings/modules {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get: if isSignedIn();
      allow create: if false;
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if false;
      allow list: if false;
    }

    /**
     * @description Allows tenant users to read automation rules. Only admins can update them.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow (get) Any authenticated user can read automation rules settings within a tenant.
     * @allow (update) Only tenant admins can update automation rules settings.
     * @deny (create, delete) No one can create or delete automation rules settings.
     * @principle Tenant-Level Access Control: Restricts settings modification to admins.
     */
    match /tenants/{tenantId}/settings/automationRules {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get: if isSignedIn();
      allow create: if false;
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if false;
      allow list: if false;
    }

    /**
     * @description Allows tenant users to read RKSV settings. Only admins can update them.
     * @path /tenants/{tenantId}/settings/rksv
     * @allow (get) Any authenticated user can read RKSV settings within a tenant.
     * @allow (update) Only tenant admins can update RKSV settings.
     * @deny (create, delete) No one can create or delete RKSV settings.
     * @principle Tenant-Level Access Control: Restricts settings modification to admins.
     */
    match /tenants/{tenantId}/settings/rksv {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get: if isSignedIn();
      allow create: if false;
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if false;
      allow list: if false;
    }

    /**
     * @description Allows tenant users to read Integration settings. Only admins can update them.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get) Any authenticated user can read Integration settings within a tenant.
     * @allow (update) Only tenant admins can update Integration settings.
     * @deny (create, delete) No one can create or delete Integration settings.
     * @principle Tenant-Level Access Control: Restricts settings modification to admins.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get: if isSignedIn();
      allow create: if false;
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if false;
      allow list: if false;
    }

    /**
     * @description Allows anyone to read global plans, but nobody can modify them through the client.
     * @path /global/plans/{planId}
     * @allow (get, list) Any user can read global plans.
     * @deny (create, update, delete) No one can create, update, or delete global plans (backend only).
     * @principle Public Read, Restricted Write: Global plans are publicly readable but writable only by backend.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows tenant users to read AI chat messages. Only admins can create, update, or delete them.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, list) Any authenticated user can read chat messages within a tenant.
     * @allow (create) Only tenant admins can create chat messages.
     * @allow (update, delete) Only tenant admins can update or delete chat messages.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete chat messages.
     * @principle Tenant-Level Access Control: Restricts chat message management within a tenant to admins.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isSignedIn();
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if isTenantAdmin(tenantId) && resource != null;
    }

    /**
     * @description Allows tenant users to read POS orders. Only admins can create, update, or delete them.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (get, list) Any authenticated user can read POS orders within a tenant.
     * @allow (create) Only tenant admins can create POS orders.
     * @allow (update, delete) Only tenant admins can update or delete POS orders.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete POS orders.
     * @principle Tenant-Level Access Control: Restricts POS order management within a tenant to admins.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isSignedIn();
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if isTenantAdmin(tenantId) && resource != null;
    }

     /**
      * @description Allows tenant users to read Audit Logs. Only admins can create, update, or delete them.
      * @path /tenants/{tenantId}/auditLogs/{logId}
      * @allow (get, list) Any authenticated user can read audit logs within a tenant.
      * @allow (create) Only tenant admins can create audit logs.
      * @allow (update, delete) Only tenant admins can update or delete audit logs.
      * @deny (create, update, delete) Non-admins cannot create, update, or delete audit logs.
      * @principle Tenant-Level Access Control: Restricts audit log management within a tenant to admins.
      */
    match /tenants/{tenantId}/auditLogs/{logId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isSignedIn();
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if isTenantAdmin(tenantId) && resource != null;
    }

    /**
     * @description Allows tenant users to read notifications. Only admins can create, update, or delete them.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (get, list) Any authenticated user can read notifications within a tenant.
     * @allow (create) Only tenant admins can create notifications.
     * @allow (update, delete) Only tenant admins can update or delete notifications.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete notifications.
     * @principle Tenant-Level Access Control: Restricts notification management within a tenant to admins.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isTenantAdmin(tenantId) {
        return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if isSignedIn();
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId) && resource != null;
      allow delete: if isTenantAdmin(tenantId) && resource != null;
    }

    /**
     * @description Allows creation of mail documents for triggering email sending extensions. No read access granted.
     * @path /mail/{mailId}
     * @allow (create) Allows anyone to trigger email sending (intended for extensions/backend).
     * @deny (get, list, update, delete) No one can read, update or delete mail documents.
     * @principle Write-Only Trigger: Used for triggering email sending extensions.
     */
    match /mail/{mailId} {
      allow get, list: if false;
      allow create: if true;
      allow update, delete: if false;
    }
  }
}