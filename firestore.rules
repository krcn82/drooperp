/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model where most data is scoped to a specific tenant.
 * Users can only access data within their assigned tenant. Write access is generally restricted to
 * authenticated users. The 'users' collection is used to map user UIDs to tenant IDs, enabling
 * tenant-based security.
 *
 * Data Structure:
 * - /users/{userId}: Maps user IDs to tenant IDs.
 * - /tenants/{tenantId}: Stores tenant information.
 * - /tenants/{tenantId}/users/{userId}: Stores user information within a tenant.
 * - /tenants/{tenantId}/transactions/{transactionId}: Stores transaction data for a tenant.
 * - /tenants/{tenantId}/products/{productId}: Stores product data for a tenant.
 * - /tenants/{tenantId}/settings/{settingId}: Stores settings for a tenant.
 * - /global/plans/{planId}: Stores global subscription plans.
 * - /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}: Stores AI chat messages within a tenant.
 * - /tenants/{tenantId}/notifications/{notificationId}: Stores AI-generated notifications for a tenant.
 *
 * Key Security Decisions:
 * - User listing is generally disallowed for privacy.
 * - The /users/{userId} document is self-created: a user can create their own document to link their UID to a tenant ID.
 * - All data access is predicated on the user being authenticated.
 * - Data shape validation is relaxed during the prototyping phase, focusing on authorization.
 * - Notifications are written by a trusted server and can only be read by authenticated users of the tenant.
 *
 * Denormalization for Authorization:
 * - The /users/{userId} document denormalizes the tenantId, allowing rules to quickly check which tenant a user belongs to.
 *
 * Structural Segregation:
 * - Public vs. private data is managed through collection hierarchy (e.g., tenant-specific data under /tenants/{tenantId}).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to create their own UserTenant document, mapping their UID to a tenantId.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates /users/user123 with tenantId: 'tenant456'.
     * @deny (create) User with UID 'user123' tries to create /users/anotherUser with tenantId: 'tenant456'.
     * @principle Enforces self-creation of UserTenant documents; validates userId matches auth.uid.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if false;
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.tenantId is string;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows reading and writing of tenant data.
     * @path /tenants/{tenantId}
     * @allow (get) Any authenticated user can read a tenant document.
     * @allow (create) Any authenticated user can create a tenant document.
     * @deny (update) Any authenticated user cannot update a tenant document.
     * @principle Requires authentication for all access; ownership not enforced at this level.
     */
    match /tenants/{tenantId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;

      /**
       * @description Allows reading and writing user data within a tenant.
       * @path /tenants/{tenantId}/users/{userId}
       * @allow (create) Any authenticated user can create a user within a tenant.
       * @allow (get) Any authenticated user can read a user within a tenant.
       * @deny (update) Any authenticated user cannot update a user within a tenant.
       * @principle Requires authentication for all access; ownership not strictly enforced.
       */
      match /users/{userId} {
        allow get: if isSignedIn() && isTenantMember(tenantId);
        allow list: if false;
        allow create: if isSignedIn() && isTenantMember(tenantId);
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Allows reading and writing transaction data within a tenant.
       * @path /tenants/{tenantId}/transactions/{transactionId}
       * @allow (create) Any authenticated user can create a transaction within a tenant.
       * @allow (get) Any authenticated user can read a transaction within a tenant.
       * @deny (update) Any authenticated user cannot update a transaction within a tenant.
       * @principle Requires authentication for all access; ownership not strictly enforced.
       */
      match /transactions/{transactionId} {
        allow get: if isSignedIn() && isTenantMember(tenantId);
        allow list: if false;
        allow create: if isSignedIn() && isTenantMember(tenantId);
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Allows reading and writing product data within a tenant.
       * @path /tenants/{tenantId}/products/{productId}
       * @allow (create) Any authenticated user can create a product within a tenant.
       * @allow (get) Any authenticated user can read a product within a tenant.
       * @deny (update) Any authenticated user cannot update a product within a tenant.
       * @principle Requires authentication for all access; ownership not strictly enforced.
       */
      match /products/{productId} {
        allow get: if isSignedIn() && isTenantMember(tenantId);
        allow list: if false;
        allow create: if isSignedIn() && isTenantMember(tenantId);
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Allows reading and writing settings data within a tenant.
       * @path /tenants/{tenantId}/settings/{settingId}
       * @allow (create) Any authenticated user can create settings within a tenant.
       * @allow (get) Any authenticated user can read settings within a tenant.
       * @deny (update) Any authenticated user cannot update settings within a tenant.
       * @principle Requires authentication for all access; ownership not strictly enforced.
       */
      match /settings/{settingId} {
        allow get: if isSignedIn() && isTenantMember(tenantId);
        allow list: if false;
        allow create: if isSignedIn() && isTenantMember(tenantId);
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Allows reading and writing messages within an AI chat for a tenant.
       * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
       * @allow (create) Any authenticated user can create a chat message within a tenant.
       * @allow (get) Any authenticated user can read a chat message within a tenant.
       * @deny (update) Any authenticated user cannot update a chat message within a tenant.
       * @principle Requires authentication for all access; ownership not strictly enforced.
       */
      match /aiChats/{chatId}/messages/{messageId} {
        allow get: if isSignedIn() && isTenantMember(tenantId);
        allow list: if false;
        allow create: if isSignedIn() && isTenantMember(tenantId);
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Allows the Automation Engine (Cloud Function: aiAutomationWorker) to create notifications and any authenticated user of the tenant to read notifications.
       * @path /tenants/{tenantId}/notifications/{notificationId}
       * @allow (create) Allow create for a trusted AI worker.
       * @allow (get) Any authenticated tenant member can read notifications.
       * @deny (update) No one can update notifications.
       */
      match /notifications/{notificationId} {
        allow get: if isSignedIn() && isTenantMember(tenantId);
        allow list: if false;
        allow create: if request.auth.token.email == 'aiAutomationWorker@example.com'; // Replace with actual service account email
        allow update: if false;
        allow delete: if false;
      }
    }

    /**
     * @description Allows reading of global subscription plans.
     * @path /global/plans/{planId}
     * @allow (get) Any authenticated user can read a plan.
     * @deny (create) No one can create, update, or delete plans through the client.
     * @principle Requires authentication for read access; write access is explicitly denied.
     */
    match /global/plans/{planId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isTenantMember(tenantId) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }
  }
}