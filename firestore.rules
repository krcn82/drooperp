rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is a member of the tenant.
     */
    function isTenantMember(tenantId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }

     /**
      * @description Checks if the user is an existing owner of the document.
      * @principle Ensures that only the owner can modify or delete a document, and that the document exists.
      */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the /users/{userId} collection, which maps user UIDs to tenant IDs.
     * @path /users/{userId}
     * @allow (get) User with UID 'user123' can read their own UserTenant document.
     * @allow (create) User with UID 'user123' can create their own UserTenant document.
     * @deny (get) User with UID 'user456' cannot read UserTenant document of 'user123'.
     * @deny (list) No one can list all UserTenant documents.
     * @principle Enforces user-ownership: Only the authenticated user can read/write their own UserTenant document.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for the /tenants/{tenantId} collection, which stores tenant information.
     * @path /tenants/{tenantId}
     * @allow (get) A tenant member can read tenant information.
     * @allow (create) A tenant member can create a tenant.
     * @deny (list) No one can list all tenants.
     * @deny (update) Only tenant members can update tenant information.
     * @deny (delete) Only tenant members can delete tenant.
     * @principle Restricts access to tenant data to authorized tenant members.
     */
    match /tenants/{tenantId} {
      allow get: if isTenantMember(tenantId);
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/categories/{categoryId} collection, storing product categories.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get) A tenant member can read category information.
     * @allow (list) A tenant member can list categories.
     * @allow (create) A tenant member can create a category.
     * @deny (update) Only tenant members can update category information.
     * @deny (delete) Only tenant members can delete a category.
     * @principle Restricts access to tenant-specific categories to authorized tenant members.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/products/{productId} collection, storing products.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get) A tenant member can read product information.
     * @allow (list) A tenant member can list products.
     * @allow (create) A tenant member can create a product.
     * @deny (update) Only tenant members can update product information.
     * @deny (delete) Only tenant members can delete a product.
     * @principle Restricts access to tenant-specific products to authorized tenant members.
     */
    match /tenants/{tenantId}/products/{productId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/customers/{customerId} collection, storing customer data.
     * @path /tenants/{tenantId}/customers/{customerId}
     * @allow (get) A tenant member can read customer information.
     * @allow (list) A tenant member can list customers.
     * @allow (create) A tenant member can create a customer.
     * @deny (update) Only tenant members can update customer information.
     * @deny (delete) Only tenant members can delete a customer.
     * @principle Restricts access to tenant-specific customers to authorized tenant members.
     */
    match /tenants/{tenantId}/customers/{customerId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/orders/{orderId} collection, storing POS orders.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get) A tenant member can read order information.
     * @allow (list) A tenant member can list orders.
     * @allow (create) A tenant member can create an order.
     * @deny (update) Only tenant members can update order information.
     * @deny (delete) Only tenant members can delete an order.
     * @principle Restricts access to tenant-specific orders to authorized tenant members.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

     /**
      * @description Rules for the /tenants/{tenantId}/tables/{tableId} collection, storing restaurant table information.
      * @path /tenants/{tenantId}/tables/{tableId}
      * @allow (get) A tenant member can read table information.
      * @allow (list) A tenant member can list tables.
      * @allow (create) A tenant member can create a table.
      * @deny (update) Only tenant members can update table information.
      * @deny (delete) Only tenant members can delete a table.
      * @principle Restricts access to tenant-specific tables to authorized tenant members.
      */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/kdsOrders/{kdsId} collection, storing Kitchen Display System order information.
     * @path /tenants/{tenantId}/kdsOrders/{kdsId}
     * @allow (get) A tenant member can read KDS order information.
     * @allow (list) A tenant member can list KDS orders.
     * @allow (create) A tenant member can create a KDS order.
     * @deny (update) Only tenant members can update KDS order information.
     * @deny (delete) Only tenant members can delete a KDS order.
     * @principle Restricts access to tenant-specific KDS orders to authorized tenant members.
     */
    match /tenants/{tenantId}/kdsOrders/{kdsId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/users/{userId} collection, storing user data within a tenant.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get) A tenant member can read user information within their tenant.
     * @allow (list) A tenant member can list users within their tenant.
     * @allow (create) A tenant member can create a user within their tenant.
     * @deny (update) Only tenant members can update user information within their tenant.
     * @deny (delete) Only tenant members can delete a user within their tenant.
     * @principle Restricts access to tenant-specific users to authorized tenant members.
     */
    match /tenants/{tenantId}/users/{userId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/payments/{paymentId} collection, storing payment information.
     * @path /tenants/{tenantId}/payments/{paymentId}
     * @allow (get) A tenant member can read payment information within their tenant.
     * @allow (list) A tenant member can list payments within their tenant.
     * @allow (create) A tenant member can create a payment within their tenant.
     * @deny (update) Only tenant members can update payment information within their tenant.
     * @deny (delete) Only tenant members can delete a payment within their tenant.
     * @principle Restricts access to tenant-specific payments to authorized tenant members.
     */
    match /tenants/{tenantId}/payments/{paymentId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/settings/general document, storing general settings.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get) A tenant member can read general settings within their tenant.
     * @allow (create) A tenant member can create general settings within their tenant.
     * @deny (list) Listing is not applicable for documents.
     * @deny (update) Only tenant members can update general settings within their tenant.
     * @deny (delete) Only tenant members can delete the general settings document within their tenant.
     * @principle Restricts access to tenant-specific general settings to authorized tenant members.
     */
    match /tenants/{tenantId}/settings/general {
      allow get: if isTenantMember(tenantId);
      allow list: if false;
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/settings/modules document, storing module settings.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get) A tenant member can read module settings within their tenant.
     * @allow (create) A tenant member can create module settings within their tenant.
     * @deny (list) Listing is not applicable for documents.
     * @deny (update) Only tenant members can update module settings within their tenant.
     * @deny (delete) Only tenant members can delete the module settings document within their tenant.
     * @principle Restricts access to tenant-specific module settings to authorized tenant members.
     */
    match /tenants/{tenantId}/settings/modules {
      allow get: if isTenantMember(tenantId);
      allow list: if false;
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/settings/automationRules document, storing automation rules.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow (get) A tenant member can read the automation rules.
     * @allow (create) A tenant member can create the automation rules.
     * @deny (update) Only tenant members can update the automation rules.
     * @deny (delete) Only tenant members can delete the automation rules.
     * @principle Restricts access to tenant-specific automation rules to authorized tenant members.
     */
    match /tenants/{tenantId}/settings/automationRules {
        allow get: if isTenantMember(tenantId);
        allow list: if false;
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/rksvConfig document, storing RKSV configuration.
     * @path /tenants/{tenantId}/rksvConfig
     * @allow (get) A tenant member can read RKSV configuration within their tenant.
     * @allow (create) A tenant member can create RKSV configuration within their tenant.
     * @deny (list) Listing is not applicable for documents.
     * @deny (update) Only tenant members can update RKSV configuration within their tenant.
     * @deny (delete) Only tenant members can delete the RKSV configuration document within their tenant.
     * @principle Restricts access to tenant-specific RKSV configuration to authorized tenant members.
     */
    match /tenants/{tenantId}/rksvConfig {
      allow get: if isTenantMember(tenantId);
      allow list: if false;
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/signatures/{signatureId} collection, storing RKSV signatures.
     * @path /tenants/{tenantId}/signatures/{signatureId}
     * @allow (get) A tenant member can read RKSV signature information within their tenant.
     * @allow (list) A tenant member can list RKSV signatures within their tenant.
     * @allow (create) A tenant member can create an RKSV signature within their tenant.
     * @deny (update) Only tenant members can update RKSV signature information within their tenant.
     * @deny (delete) Only tenant members can delete an RKSV signature within their tenant.
     * @principle Restricts access to tenant-specific RKSV signatures to authorized tenant members.
     */
    match /tenants/{tenantId}/signatures/{signatureId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/zReports/{reportId} collection, storing Z-Reports.
     * @path /tenants/{tenantId}/zReports/{reportId}
     * @allow (get) A tenant member can read Z-Report information within their tenant.
     * @allow (list) A tenant member can list Z-Reports within their tenant.
     * @allow (create) A tenant member can create a Z-Report within their tenant.
     * @deny (update) Only tenant members can update Z-Report information within their tenant.
     * @deny (delete) Only tenant members can delete a Z-Report within their tenant.
     * @principle Restricts access to tenant-specific Z-Reports to authorized tenant members.
     */
    match /tenants/{tenantId}/zReports/{reportId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/integrations/{platformId} collection, storing integration data.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get) A tenant member can read integration data within their tenant.
     * @allow (list) A tenant member can list integrations within their tenant.
     * @allow (create) A tenant member can create an integration within their tenant.
     * @deny (update) Only tenant members can update integration data within their tenant.
     * @deny (delete) Only tenant members can delete an integration within their tenant.
     * @principle Restricts access to tenant-specific integrations to authorized tenant members.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/cashRegisters/{registerId} collection, storing cash register sessions.
     * @path /tenants/{tenantId}/cashRegisters/{registerId}
     * @allow (get) A tenant member can read cash register sessions within their tenant.
     * @allow (list) A tenant member can list cash register sessions within their tenant.
     * @allow (create) A tenant member can create a cash register session within their tenant.
     * @deny (update) Only tenant members can update cash register sessions within their tenant.
     * @deny (delete) Only tenant members can delete a cash register session within their tenant.
     * @principle Restricts access to tenant-specific cash register sessions to authorized tenant members.
     */
    match /tenants/{tenantId}/cashRegisters/{registerId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/reports/{reportId} collection, storing generated reports.
     * @path /tenants/{tenantId}/reports/{reportId}
     * @allow (get) A tenant member can read reports within their tenant.
     * @allow (list) A tenant member can list reports within their tenant.
     * @allow (create) A tenant member can create a report within their tenant.
     * @deny (update) Only tenant members can update reports within their tenant.
     * @deny (delete) Only tenant members can delete a report within their tenant.
     * @principle Restricts access to tenant-specific reports to authorized tenant members.
     */
    match /tenants/{tenantId}/reports/{reportId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/finanzOnlineLogs/{logId} collection, storing FinanzOnline API submission logs.
     * @path /tenants/{tenantId}/finanzOnlineLogs/{logId}
     * @allow (get) A tenant member can read FinanzOnline log information within their tenant.
     * @allow (list) A tenant member can list FinanzOnline logs within their tenant.
     * @allow (create) A tenant member can create a FinanzOnline log within their tenant.
     * @deny (update) Only tenant members can update FinanzOnline log information within their tenant.
     * @deny (delete) Only tenant members can delete a FinanzOnline log within their tenant.
     * @principle Restricts access to tenant-specific FinanzOnline logs to authorized tenant members.
     */
    match /tenants/{tenantId}/finanzOnlineLogs/{logId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/systemErrors/{errorId} collection, storing system error logs.
     * @path /tenants/{tenantId}/systemErrors/{errorId}
     * @allow (get) A tenant member can read system error information within their tenant.
     * @allow (list) A tenant member can list system errors within their tenant.
     * @allow (create) A tenant member can create a system error within their tenant.
     * @deny (update) Only tenant members can update system error information within their tenant.
     * @deny (delete) Only tenant members can delete a system error within their tenant.
     * @principle Restricts access to tenant-specific system errors to authorized tenant members.
     */
    match /tenants/{tenantId}/systemErrors/{errorId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /global/plans/{planId} collection, storing subscription plans.
     * @path /global/plans/{planId}
     * @allow (get) Any signed-in user can read subscription plan information.
     * @allow (list) Any signed-in user can list subscription plans.
     * @allow (create) No one can create subscription plans via the client.
     * @deny (update) No one can update subscription plans via the client.
     * @deny (delete) No one can delete subscription plans via the client.
     * @principle Allows public read access to subscription plans, while restricting write access.
     */
    match /global/plans/{planId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} collection, storing AI chat messages.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get) A tenant member can read AI chat messages within their tenant.
     * @allow (list) A tenant member can list AI chat messages within their tenant.
     * @allow (create) A tenant member can create an AI chat message within their tenant.
     * @deny (update) Only tenant members can update AI chat messages within their tenant.
     * @deny (delete) Only tenant members can delete an AI chat message within their tenant.
     * @principle Restricts access to tenant-specific AI chat messages to authorized tenant members.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/posOrders/{orderId} collection, storing POS orders from external platforms.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (get) A tenant member can read POS orders within their tenant.
     * @allow (list) A tenant member can list POS orders within their tenant.
     * @allow (create) A tenant member can create a POS order within their tenant.
     * @deny (update) Only tenant members can update POS orders within their tenant.
     * @deny (delete) Only tenant members can delete a POS order within their tenant.
     * @principle Restricts access to tenant-specific POS orders from external platforms to authorized tenant members.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/auditLogs/{logId} collection, storing audit logs for API calls.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (get) A tenant member can read audit log information within their tenant.
     * @allow (list) A tenant member can list audit logs within their tenant.
     * @allow (create) A tenant member can create an audit log within their tenant.
     * @deny (update) Only tenant members can update audit log information within their tenant.
     * @deny (delete) Only tenant members can delete an audit log within their tenant.
     * @principle Restricts access to tenant-specific audit logs to authorized tenant members.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
        allow get: if isTenantMember(tenantId);
        allow list: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        allow update: if isTenantMember(tenantId);
        allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/notifications/{notificationId} collection, storing user notifications.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (get) A tenant member can read notification information within their tenant.
     * @allow (list) A tenant member can list notifications within their tenant.
     * @allow (create) A tenant member can create a notification within their tenant.
     * @deny (update) Only tenant members can update notification information within their tenant.
     * @deny (delete) Only tenant members can delete a notification within their tenant.
     * @principle Restricts access to tenant-specific notifications to authorized tenant members.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      allow get: if isTenantMember(tenantId);
      allow list: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId);
      allow delete: if isTenantMember(tenantId);
    }

    /**
     * @description Rules for the /mail/{mailId} collection, used to trigger email sending.
     * @path /mail/{mailId}
     * @allow (get) No one can get email objects directly.
     * @allow (list) No one can list email objects.
     * @allow (create) Only authenticated users can create mail objects.
     * @deny (update) No one can update email objects directly.
     * @deny (delete) No one can delete email objects directly.
     * @principle Restricts access to email creation to authenticated users, managed by a backend function.
     */
    match /mail/{mailId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}