/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model where users are associated with specific tenants.
 * Access is generally restricted to authenticated users within their respective tenants,
 * with explicit ownership checks for user-specific data and read-only access to global plans.
 *
 * Data Structure:
 * - /users/{userId}: Maps user IDs to tenant IDs for rule enforcement.
 * - /tenants/{tenantId}: Stores tenant-specific information.
 * - /tenants/{tenantId}/users/{userId}: Stores user information within a tenant.
 * - /tenants/{tenantId}/transactions/{transactionId}: Stores transaction data for a tenant.
 * - /tenants/{tenantId}/products/{productId}: Stores product data for a tenant.
 * - /tenants/{tenantId}/settings/{settingId}: Stores settings for a tenant.
 * - /global/plans/{planId}: Stores global subscription plans (read-only).
 * - /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}: Stores chat messages within a tenant's AI chat.
 *
 * Key Security Decisions:
 * - Users can only list data within their own tenant.
 * - Global plans are publicly readable but not writable.
 * - The UserTenant document creation is limited to the user themselves.
 *
 * Denormalization for Authorization:
 * - The UserTenant document at /users/{userId} denormalizes the tenantId, allowing efficient tenant-based access control without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to read and write their own UserTenant document, which maps their UID to their tenant ID.
     * @path /users/{userId}
     * @allow (create) User with UID "user123" can create /users/user123 with data { tenantId: "tenant456" } if authenticated as "user123".
     * @deny (create) User with UID "user123" cannot create /users/user456.
     * @principle Enforces document ownership and prevents unauthorized user mapping.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.tenantId is string;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows read and write access to tenant information for authenticated users.
     * @path /tenants/{tenantId}
     * @allow (get) Any authenticated user can read tenant data.
     * @allow (create) Any authenticated user can create tenant data.
     * @deny (create) Unauthorized user cannot create tenant data.
     * @principle Allows tenant-level access control.
     */
    match /tenants/{tenantId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to user information within a tenant for authenticated users.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get) Any authenticated user can read user data within a tenant.
     * @allow (create) Any authenticated user can create user data within a tenant.
     * @deny (create) Unauthorized user cannot create user data.
     * @principle Allows tenant-specific user management.
     */
    match /tenants/{tenantId}/users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to transaction data within a tenant for authenticated users.
     * @path /tenants/{tenantId}/transactions/{transactionId}
     * @allow (get) Any authenticated user can read transaction data within a tenant.
     * @allow (create) Any authenticated user can create transaction data within a tenant.
     * @deny (create) Unauthorized user cannot create transaction data.
     * @principle Allows tenant-specific transaction management.
     */
    match /tenants/{tenantId}/transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to product data within a tenant for authenticated users.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get) Any authenticated user can read product data within a tenant.
     * @allow (create) Any authenticated user can create product data within a tenant.
     * @deny (create) Unauthorized user cannot create product data.
     * @principle Allows tenant-specific product management.
     */
    match /tenants/{tenantId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to settings within a tenant for authenticated users.
     * @path /tenants/{tenantId}/settings/{settingId}
     * @allow (get) Any authenticated user can read settings within a tenant.
     * @allow (create) Any authenticated user can create settings within a tenant.
     * @deny (create) Unauthorized user cannot create settings.
     * @principle Allows tenant-specific settings management.
     */
    match /tenants/{tenantId}/settings/{settingId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to global plans.
     * @path /global/plans/{planId}
     * @allow (get) Any user can read global plan data.
     * @deny (create) No user can create global plan data.
     * @principle Provides public information while restricting modifications.
     */
    match /global/plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to chat messages within a tenant's AI chat for authenticated users.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get) Any authenticated user can read chat messages within a tenant.
     * @allow (create) Any authenticated user can create chat messages within a tenant.
     * @deny (create) Unauthorized user cannot create chat messages.
     * @principle Allows tenant-specific AI chat management.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

     /**
      * @description Fixes the error by allowing listing of kdsOrders for the specific tenant.
      * @path /tenants/{tenantId}/kdsOrders/{kdsOrderId}
      * @allow (list) Allows authenticated users to list kdsOrders within their tenant.
      * @deny (create) Unauthorized user cannot create kdsOrders data.
      * @principle Allows tenant-specific kdsOrders management.
      */
    match /tenants/{tenantId}/kdsOrders/{kdsOrderId} {
       function isSignedIn() {
         return request.auth != null;
       }

       allow get: if isSignedIn();
       allow list: if isSignedIn();
       allow create: if isSignedIn();
       allow update: if false;
       allow delete: if false;
     }
  }
}