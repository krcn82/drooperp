/**
 * @fileoverview Firestore Security Rules for the POS System.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model where data is primarily segregated by tenant ID.
 * Access is generally restricted to authenticated users.
 *
 * Data Structure:
 * - /users/{userId}: Maps user UIDs to tenant IDs. Used to quickly determine tenant access.
 * - /tenants/{tenantId}: Stores tenant-level information.
 * - /tenants/{tenantId}/*: Most data is stored within tenant-specific subcollections.
 * - /global/plans/{planId}: Stores global subscription plans.
 *
 * Key Security Decisions:
 * - Tenant Isolation: Most rules enforce that users can only access data within their assigned tenant.
 * - No User Enumeration: Listing of users is generally disallowed for privacy.
 * - Explicit Denials: Permissions are explicitly denied when not granted to ensure a secure-by-default posture.
 *
 * Denormalization for Authorization:
 * - UserTenant Collection: The `/users/{userId}` collection is used to quickly retrieve the tenant ID for a user.
 *   This avoids costly queries to a user's document within the `/tenants/{tenantId}/users/{userId}` collection for every request.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Authentication.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Ownership.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the existing document.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Ownership and Existence.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Gets the tenant ID for a given user ID from the /users/{userId} document.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Tenant Isolation.
     */
    function getTenantIdForUser(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.tenantId;
    }

    /**
     * @description Checks if the user is part of the specified tenant
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Tenant Isolation.
     */
    function isInTenant(tenantId) {
        return isSignedIn() && getTenantIdForUser(request.auth.uid) == tenantId;
    }


    /**
     * @description Rule for the top-level /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own UserTenant document.
     * @deny (create) - If the authenticated user's ID doesn't match the userId.
     * @allow (get) - Authenticated user can get their own UserTenant document.
     * @deny (get) - If the authenticated user's ID doesn't match the userId.
     * @deny (list) - Listing all users is not permitted.
     * @allow (update) - Authenticated user can update their own UserTenant document.
     * @deny (update) - If the authenticated user's ID doesn't match the userId.
     * @allow (delete) - Authenticated user can delete their own UserTenant document.
     * @deny (delete) - If the authenticated user's ID doesn't match the userId.
     * @principle Self-Creation, Ownership, and No User Enumeration.
     */
    match /users/{userId} {
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.tenantId is string;
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow update: if isExistingOwner(userId) && request.resource.data.tenantId == resource.data.tenantId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /tenants/{tenantId} collection.
     * @path /tenants/{tenantId}
     * @allow (get, list) - Anyone can read tenant information.
     * @allow (create, update, delete) - No one is allowed to create, update, or delete tenants directly.
     * @deny (create) - No one can create a tenant document.
     * @deny (update) - No one can update a tenant document.
     * @deny (delete) - No one can delete a tenant document.
     * @principle Public Read, Restricted Write.
     */
    match /tenants/{tenantId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/categories/{categoryId} collection.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get, list) - Any authenticated user in the tenant can read categories.
     * @allow (create) - Any authenticated user in the tenant can create categories.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete categories.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/products/{productId} collection.
     * @path /tenants/{tenantId}/products/{productId}
     * @allow (get, list) - Any authenticated user in the tenant can read products.
     * @allow (create) - Any authenticated user in the tenant can create products.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete products.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/products/{productId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

   /**
     * @description Rule for the /tenants/{tenantId}/customers/{customerId} collection.
     * @path /tenants/{tenantId}/customers/{customerId}
     * @allow (get, list) - Any authenticated user in the tenant can read customers.
     * @allow (create) - Any authenticated user in the tenant can create customers.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete customers.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/customers/{customerId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/orders/{orderId} collection.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get, list) - Any authenticated user in the tenant can read orders.
     * @allow (create) - Any authenticated user in the tenant can create orders.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete orders.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get: if isInTenant(tenantId);
      allow list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/tables/{tableId} collection.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get, list) - Any authenticated user in the tenant can read tables.
     * @allow (create) - Any authenticated user in the tenant can create tables.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete tables.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

   /**
     * @description Rule for the /tenants/{tenantId}/kdsOrders/{kdsId} collection.
     * @path /tenants/{tenantId}/kdsOrders/{kdsId}
     * @allow (get, list) - Any authenticated user in the tenant can read kdsOrders.
     * @allow (create) - Any authenticated user in the tenant can create kdsOrders.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete kdsOrders.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/kdsOrders/{kdsId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/users/{userId} collection.
     * @path /tenants/{tenantId}/users/{userId}
     * @allow (get) - Any authenticated user in the tenant can get user information.
     * @allow (list) - Listing users is disallowed for privacy.
     * @allow (create) - No one can create a user via this path. User creation should occur through an admin interface.
     * @allow (update) - Any authenticated user in the tenant can update users.
     * @allow (delete) - Any authenticated user in the tenant can delete users.
     * @deny (create) - Creating a user directly is not permitted.
     * @deny (list) - Listing all users is not permitted.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation, No User Enumeration.
     */
    match /tenants/{tenantId}/users/{userId} {
      allow get: if isInTenant(tenantId);
      allow list: if false;
      allow create: if false;
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/payments/{paymentId} collection.
     * @path /tenants/{tenantId}/payments/{paymentId}
     * @allow (get, list) - Any authenticated user in the tenant can read payments.
     * @allow (create) - Any authenticated user in the tenant can create payments.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete payments.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/payments/{paymentId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/settings/general document.
     * @path /tenants/{tenantId}/settings/general
     * @allow (get) - Any authenticated user in the tenant can read general settings.
     * @allow (list) - Listing is not applicable for a single document.
     * @allow (create, update, delete) - Any authenticated user in the tenant can create/update/delete general settings.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/settings/general {
      allow get: if isInTenant(tenantId);
      allow list: if false;
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/settings/modules document.
     * @path /tenants/{tenantId}/settings/modules
     * @allow (get) - Any authenticated user in the tenant can read module settings.
     * @allow (list) - Listing is not applicable for a single document.
     * @allow (create, update, delete) - Any authenticated user in the tenant can create/update/delete module settings.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/settings/modules {
      allow get: if isInTenant(tenantId);
      allow list: if false;
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/settings/automationRules document.
     * @path /tenants/{tenantId}/settings/automationRules
     * @allow (get) - Any authenticated user in the tenant can read automation rules.
     * @allow (list) - Listing is not applicable for a single document.
     * @allow (create, update, delete) - Any authenticated user in the tenant can create/update/delete automation rules.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/settings/automationRules {
      allow get: if isInTenant(tenantId);
      allow list: if false;
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/rksvConfig document.
     * @path /tenants/{tenantId}/rksvConfig
     * @allow (get) - Any authenticated user in the tenant can read the RKSV config.
     * @allow (list) - Listing is not applicable for a single document.
     * @allow (create, update, delete) - Any authenticated user in the tenant can create/update/delete the RKSV config.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/rksvConfig {
      allow get: if isInTenant(tenantId);
      allow list: if false;
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/signatures/{signatureId} collection.
     * @path /tenants/{tenantId}/signatures/{signatureId}
     * @allow (get, list) - Any authenticated user in the tenant can read signatures.
     * @allow (create) - Any authenticated user in the tenant can create signatures.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete signatures.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/signatures/{signatureId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/zReports/{reportId} collection.
     * @path /tenants/{tenantId}/zReports/{reportId}
     * @allow (get, list) - Any authenticated user in the tenant can read Z-Reports.
     * @allow (create) - Any authenticated user in the tenant can create Z-Reports.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete Z-Reports.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/zReports/{reportId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/integrations/{platformId} collection.
     * @path /tenants/{tenantId}/integrations/{platformId}
     * @allow (get, list) - Any authenticated user in the tenant can read integrations.
     * @allow (create) - Any authenticated user in the tenant can create integrations.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete integrations.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/integrations/{platformId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/cashRegisters/{registerId} collection.
     * @path /tenants/{tenantId}/cashRegisters/{registerId}
     * @allow (get, list) - Any authenticated user in the tenant can read cash registers.
     * @allow (create) - Any authenticated user in the tenant can create cash registers.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete cash registers.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/cashRegisters/{registerId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/reports/{reportId} collection.
     * @path /tenants/{tenantId}/reports/{reportId}
     * @allow (get, list) - Any authenticated user in the tenant can read reports.
     * @allow (create) - Any authenticated user in the tenant can create reports.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete reports.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/reports/{reportId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/finanzOnlineLogs/{logId} collection.
     * @path /tenants/{tenantId}/finanzOnlineLogs/{logId}
     * @allow (get, list) - Any authenticated user in the tenant can read FinanzOnline logs.
     * @allow (create) - Any authenticated user in the tenant can create FinanzOnline logs.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete FinanzOnline logs.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/finanzOnlineLogs/{logId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/systemErrors/{errorId} collection.
     * @path /tenants/{tenantId}/systemErrors/{errorId}
     * @allow (get, list) - Any authenticated user in the tenant can read system errors.
     * @allow (create) - Any authenticated user in the tenant can create system errors.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete system errors.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/systemErrors/{errorId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /global/plans/{planId} collection.
     * @path /global/plans/{planId}
     * @allow (get, list) - Anyone can read subscription plans.
     * @allow (create, update, delete) - No one can create, update, or delete plans directly.
     * @deny (create) - No one can create a plan document.
     * @deny (update) - No one can update a plan document.
     * @deny (delete) - No one can delete a plan document.
     * @principle Public Read, Restricted Write.
     */
    match /global/plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} collection.
     * @path /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId}
     * @allow (get, list) - Any authenticated user in the tenant can read messages.
     * @allow (create) - Any authenticated user in the tenant can create messages.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete messages.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/aiChats/{chatId}/messages/{messageId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/posOrders/{orderId} collection.
     * @path /tenants/{tenantId}/posOrders/{orderId}
     * @allow (get, list) - Any authenticated user in the tenant can read POS Orders.
     * @allow (create) - Any authenticated user in the tenant can create POS Orders.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete POS Orders.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/posOrders/{orderId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/auditLogs/{logId} collection.
     * @path /tenants/{tenantId}/auditLogs/{logId}
     * @allow (get, list) - Any authenticated user in the tenant can read audit logs.
     * @allow (create) - Any authenticated user in the tenant can create audit logs.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete audit logs.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/auditLogs/{logId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /tenants/{tenantId}/notifications/{notificationId} collection.
     * @path /tenants/{tenantId}/notifications/{notificationId}
     * @allow (get, list) - Any authenticated user in the tenant can read notifications.
     * @allow (create) - Any authenticated user in the tenant can create notifications.
     * @allow (update, delete) - Any authenticated user in the tenant can update/delete notifications.
     * @deny (create) - If the user is not part of the tenant.
     * @deny (update) - If the user is not part of the tenant.
     * @deny (delete) - If the user is not part of the tenant.
     * @principle Tenant Isolation.
     */
    match /tenants/{tenantId}/notifications/{notificationId} {
      allow get, list: if isInTenant(tenantId);
      allow create: if isInTenant(tenantId);
      allow update: if isInTenant(tenantId) && resource != null;
      allow delete: if isInTenant(tenantId) && resource != null;
    }

    /**
     * @description Rule for the /mail/{mailId} collection.
     * @path /mail/{mailId}
     * @allow (create) - Any authenticated user can trigger email sending.
     * @allow (get, list, update, delete) - No one can get/list/update/delete emails.
     * @deny (get) - No one can get an email.
     * @deny (list) - No one can list emails.
     * @deny (update) - No one can update an email.
     * @deny (delete) - No one can delete an email.
     * @principle Restricted Access, Trigger Only.
     */
    match /mail/{mailId} {
      allow create: if isSignedIn();
      allow get, list, update, delete: if false;
    }
  }
}